<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"geek5nan.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="每天进步一点。">
<meta property="og:type" content="website">
<meta property="og:title" content="Geek5Nan">
<meta property="og:url" content="http://geek5nan.github.io/index.html">
<meta property="og:site_name" content="Geek5Nan">
<meta property="og:description" content="每天进步一点。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Geek5Nan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://geek5nan.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Geek5Nan</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-49244994-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-49244994-2');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Geek5Nan</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2019/11/09/Git-Branch-Management/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/09/Git-Branch-Management/" class="post-title-link" itemprop="url">聊聊分支管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-09 22:16:06" itemprop="dateCreated datePublished" datetime="2019-11-09T22:16:06+08:00">2019-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:42:18" itemprop="dateModified" datetime="2019-12-11T22:42:18+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">软件工程</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/11/09/Git-Branch-Management/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/09/Git-Branch-Management/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>大多时候，开发人员仅需使用少量的分支，甚至只需 master 和 develop 两个分支即可完成日常工作。这足以应付小型项目或小规模团队的开发工作，但随着协作人员的增多和项目周期的延长，各样的挑战便会纷至沓来…</p>
<h4 id="代码版本控制的挑战"><a href="#代码版本控制的挑战" class="headerlink" title="代码版本控制的挑战"></a>代码版本控制的挑战</h4><ol>
<li>并行开发：如何开始一个 feature 的开发，而不影响别的 feature ？</li>
<li>代码回溯：如何了解每次提交做了哪些工作，如何让提交记录承载软件文档的功能？</li>
<li>代码回溯：随着时间的流逝，如何快速了解每个分支都做了什么？</li>
<li>分支管理：由于新分支的创建是<strong>廉价</strong>的，分支多了之后该如何管理？</li>
<li>发布管理：如何进行<strong>发布</strong>管理？发布时如何冻结 Feature 的<strong>合并</strong>？发布过程中如何修复线上 bug？发布过程中如何<strong>并行开发</strong>新功能？</li>
<li>修复管理：线上代码出 Bug 后如何快速修复？修复后的代码如何<strong>安全</strong>、<strong>优雅</strong>的合并到<strong>所有协作者</strong>的工作分支中？</li>
<li>代码维护：如何在多人员的并行开发过程中保证<strong>代码质量</strong>？</li>
</ol>
<p>面临这些挑战，本文试图提出一种简洁的、清晰的、可执行的分支管理方案，以期能够规避一些常见的版本控制陷阱，提高协作效率，增强知识共享，降低维护成本。</p>
<h4 id="本分支规范的目的"><a href="#本分支规范的目的" class="headerlink" title="本分支规范的目的"></a>本分支规范的目的</h4><ol>
<li>提高协作效率：基于 git 的分布式实现，发挥并行开发的优势</li>
<li>增强知识共享：提交记录即文档，使其成为知识的载体之一，使得项目变更具有回溯性</li>
<li>降低维护成本：通过清晰的分支划分，简化代码集成过程、问题修复过程，使得项目的集成更可控</li>
</ol>
<h3 id="代码提交规范"><a href="#代码提交规范" class="headerlink" title="代码提交规范"></a>代码提交规范</h3><blockquote>
<p><strong>好的提交记录是分支管理的基石</strong>，在讲述分支管理之前，务必先了解代码提交规范。</p>
</blockquote>
<h4 id="git-commit-规范及原则"><a href="#git-commit-规范及原则" class="headerlink" title="git commit 规范及原则"></a>git commit 规范及原则</h4><ol>
<li><p><strong>单一职责原则</strong>：细化提交粒度，每次提交内容应少而精，职责清晰，任务单一，拒绝将多个改动汇聚到同一个提交记录中</p>
</li>
<li><p>基于第一点，每次提交日志应尽可能的准确，详细阐述本次提交的改动内容，必要时可详细阐述改动的原因并给出相关链接。<u>下附提交日志格式，以供参考。</u></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">第一行，简述变更内容，对于简单改动，仅填写此行信息即可。控制在 72 个半角字符以内，避免 Web 端自动换行</span><br><span class="line">第二行，保持空行</span><br><span class="line">第三行，详细变更 1，必要时需说明变更原因</span><br><span class="line">第四行，详细变更 2，必要时需说明变更原因</span><br><span class="line">第五行，相关链接（Wiki、RFC、技术博客等）...</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>拒绝</strong>空日志、重复日志、无意义的提交记录</p>
</li>
<li><p><strong>避免</strong>不完整的提交，<strong>确保</strong>推送至远程分支的代码都是可运行的</p>
<ul>
<li>如有某次提交不完整的情况，可在推送至远端前采用<code>git commit --amend</code>的方式完善上次提交的内容</li>
</ul>
</li>
<li><p><strong>避免</strong>过于琐碎的无意义提交，尽量保持提交记录清晰可读</p>
<ul>
<li>若有多个提交记录所完成的功能是一个原子型任务，则可在推送之远端之前使用 <code>git commit --ammend</code>或 <code>git rebase -i</code> 或 <code>git merge --squash</code> 的方式进行整合后，重新提交</li>
<li>此外，也可以使用 <code>git reset --soft</code>  将本地仓库重制到某次操作后，重新提交</li>
</ul>
</li>
<li><p><strong>拒绝</strong>在合并时使用 <strong>fast-forward</strong> 方式隐藏合并记录，建议使用<code>git merge --no-ff</code>进行合并操作，确保每次代码合并都是可回溯的</p>
</li>
<li><p>非特殊情况下，<strong>避免</strong>使用 <code>git push -f</code> 强制重置远程仓库中的历史记录</p>
</li>
</ol>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>代码提交规范是<strong>分支管理</strong>的基础，不好的提交记录在 PR/MR 阶段<strong>将会被拒绝</strong>，同时，提交记录也是一份事实上的文档，描述了代码的变更原因与变更内容。一份好的提交记录将会为知识分享、<strong>CodeReview **等提供莫大的便利，因此，请务必保持提交记录的</strong>整洁性<strong>、</strong>易读性<strong>，</strong>传承性**。</p>
<div style="page-break-after: always;"></div>

<h3 id="git-flow-分支模型"><a href="#git-flow-分支模型" class="headerlink" title="git-flow 分支模型"></a>git-flow 分支模型</h3><p><img src="/uploads/git-flow.png" alt="git-flow"></p>
<ol>
<li>图中每个 ● 都表示一个 commit 记录</li>
<li>图中纵轴表示时间。● 的位置越靠近下方，则表示该 commit 出现的越晚</li>
<li>图中每列都表示一条分支。上图中从左到右，有 2 条 feature 分支、1 条 develop 分支、1 条 release 分支、1 条 hotfix 分支与 1 条 master 分支</li>
</ol>
<h3 id="分支规范"><a href="#分支规范" class="headerlink" title="分支规范"></a>分支规范</h3><p>开始之前，先来了解一下本文中即将出现的<strong>术语</strong>，以便对本文将要表达的内容达成一个初步共识</p>
<h4 id="术语对照表"><a href="#术语对照表" class="headerlink" title="术语对照表"></a>术语对照表</h4><table>
<thead>
<tr>
<th>术语</th>
<th>git 命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>签出</td>
<td>git checkout -b $新分支名称</td>
<td>以当前工作副本为准，创建新的分支</td>
</tr>
<tr>
<td>签入*</td>
<td>git merge 或 git rebase 或 git cherry-pick</td>
<td>将某次提交或某个分支合并到当前工作副本所在的分支</td>
</tr>
<tr>
<td>PR/MR</td>
<td>-</td>
<td>发起 Pull Request/Merge request 请求，开启 CodeReview 流程</td>
</tr>
<tr>
<td>上游*</td>
<td>-</td>
<td>当前分支的起点，例如：feature 的上游通常是 develop</td>
</tr>
<tr>
<td>项目负责人</td>
<td></td>
<td>Project Owner，最了解该项目源码的人，非职位</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>签入：本文中的「签入」一词均可替换为「合并」，它们所表达的意义是基本相同。本文之所以使用「签入」而非「合并」是因为笔者主观的认为「签入」更具普适性。例如：git rebase、git merge、git cherry-pick 均可进行代码集成 — 即「合并」操作。</p>
</blockquote>
<blockquote>
<p>上游：本文中的「上游」一词并非本地分支所对应的远程分支，而是指当前分支所关注的 BaseLine 基线分支。举个例子：feature/A 、feature/B 分支都是从 develop 分支签出的功能分支 ，那么 develop 便是feature/A 和 feature/B 的基线分支，即「上游」。</p>
</blockquote>
<h4 id="规范及原则"><a href="#规范及原则" class="headerlink" title="规范及原则"></a>规范及原则</h4><table>
<thead>
<tr>
<th>分支</th>
<th>描述</th>
<th>作用</th>
<th>约束原则</th>
</tr>
</thead>
<tbody><tr>
<td>develop</td>
<td>开发分支（长期）</td>
<td>开发过程中的<strong>基线 Base Line</strong></td>
<td>1. 所有的 feature、release 分支均从 develop <strong>签出</strong>  <br />2. develop 属于<strong>保护分支</strong>，任何人不得直接修改develop 分支中的 commit 记录<br />3. develop 分支的所有 commit <strong>必须通过 PR/MR</strong> 的方式<strong>签入</strong><br />4. <strong><span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlODUlQjMlRTYlQjMlQTglRTclODIlQjklRTUlODglODYlRTclQTYlQkI=" title="https://baike.baidu.com/item/%E5%85%B3%E6%B3%A8%E7%82%B9%E5%88%86%E7%A6%BB">关注点分离原则<i class="fa fa-external-link"></i></span></strong>与<strong><span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTglQkYlQUElRTclQjElQjMlRTclODklQjklRTYlQjMlOTUlRTUlODglOTk=" title="https://baike.baidu.com/item/%E8%BF%AA%E7%B1%B3%E7%89%B9%E6%B3%95%E5%88%99">最少知识原则<i class="fa fa-external-link"></i></span></strong>：develop 仅集成本期迭代需要交付的功能与代码<br /></td>
</tr>
<tr>
<td>feature</td>
<td>功能分支（短期）</td>
<td>新的需求或功能<br />优化与重构<br /></td>
<td>1. 由 develop <strong>签出</strong><br />2. <span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlOEQlOTUlRTQlQjglODAlRTglODElOEMlRTglQjQlQTMlRTUlOEUlOUYlRTUlODglOTk=" title="https://baike.baidu.com/item/%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99">单一职责原则<i class="fa fa-external-link"></i></span>，切勿在同一个 feature 分支内做多件事<br />3. 及时与上游（develop）进行代码同步，<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTYlOEMlODElRTclQkIlQUQlRTklOUIlODYlRTYlODglOTA=" title="https://baike.baidu.com/item/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90">持续集成<i class="fa fa-external-link"></i></span>以<strong>降低集成成本</strong><br />4. 如有必要，可以在 feature 分支之间进行合并，如：代码整合，功能整合等<br />5. 开发完成后，发送 PR/MR 给<strong>项目负责人</strong>进行<strong>CodeReview</strong><br />6. 审核通过后，<strong>签入</strong> develop 分支</td>
</tr>
<tr>
<td>release</td>
<td>预发分支（短期）</td>
<td>集成测试<br />细节微调（配置修改、数据脱敏等）</td>
<td>1. 由 develop <strong>签出</strong><br />2. 此分支仅做少量更改；如需大量修改，请使用 feature 分支完成<br />3. 测试、验收通过后，发送 PR/MR 给<strong>项目负责人</strong>进行 <strong>CodeReview</strong><br />4. 审核通过后，<strong>签入</strong> master 分支，<strong>必须添加 TAG 记录</strong>，用以标识本次发布的版本信息</td>
</tr>
<tr>
<td>master</td>
<td>已发布分支（长期）</td>
<td>归档<br />稳定的<br />基于 Tag 的<br />可回溯的<br /></td>
<td>1. master 属于<strong>保护分支</strong>。任何人不得直接修改 master 分支中的 commit 记录、TAG等信息<br />2. master 分支仅为已发布的软件版本提供回溯功能，以便 bug 修复、回归测试、紧急降级等<br />3. master 分支的上游必须是 release 或 hotfix<br />4. master 分支中的所有 commit <strong>必须通过 PR/MR</strong> 的方式<strong>签入</strong><br /></td>
</tr>
<tr>
<td>hotfix</td>
<td>修复分支（短期）</td>
<td>对 master 中已发布版本存在的问题进行修复<br /></td>
<td>1. 由 master <strong>签出</strong><br />2. <strong>单一职责原则</strong>：仅允许对已发布版本（如：v1.0.2、v2.0.0）中存在的 bug 问题进行修复；<strong>不允许</strong>在 hotfix 中集成新功能<br />3. bug 修复后，向项目负责人发送 PR/MR 进行<strong>CodeReview</strong><br />4. 审核通过后，<strong>同时签入</strong> develop 分支与 master 分支</td>
</tr>
</tbody></table>
<div style="page-break-after: always;"></div>

<h4 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h4><ul>
<li><p><strong>develop</strong>：</p>
<ul>
<li><p>develop 分支是软件开发、维护过程中的<strong>基线</strong>分支，贯穿软件活动的整个生命周期</p>
</li>
<li><p>单一信源 Single Source of Truth ：所有的变更、发布只有一个来源，出错的机会便会少很多</p>
</li>
<li><p>所有的 <strong>feature/release 分支</strong>均从 <strong>develop 分支</strong>中<strong>签出</strong></p>
</li>
<li><p><strong>关注点分离原则</strong>：develop 分支仅集成本期迭代需要交付的功能（feature），并非所有的 feature 完成后都要立即<strong>签入</strong> develop 分支。PS：*<u>让子弹飞一会儿</u>～*</p>
<blockquote>
<p>如果一个项目有多个发布版需要并行开发，且不同的发布版间有巨大的代码差异，则建议使用多个 develop 基线分支进行开发</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>feature</strong>：</p>
<ul>
<li><p>特性分支通常有多个（&gt;= 并行开发的需求或人员的数量），它们都是从 develop 分支<strong>签出</strong>的</p>
</li>
<li><p>特性分支的名称通常为 <code>feature/特性分支名称</code>，每个特性分支对应某一个或某一类的需求或功能</p>
</li>
<li><p>特性分支的名称必须是<strong>需求相关的</strong>、<strong>准确的</strong>、<strong>无歧义的</strong>、<strong>自解释的</strong>、<strong>易于理解的</strong></p>
</li>
<li><p>开发过程中，大部分工作在特性分支进行，功能完成后，需通过 PR/MR 的方式将其<strong>签入</strong>回 develop 分支</p>
</li>
<li><p>持续集成原则：</p>
<ol>
<li>确保每次提交的代码都可通过编译，仅向版本库提交可编译、可运行的代码</li>
<li>及时向远程仓库推送本地变更，避免因本地设备损坏、失窃等造成的代码丢失</li>
<li>每天至少从<strong>上游</strong>同步一次代码，尽早对上游的变更作出反应，降低集成成本</li>
</ol>
</li>
<li><p>发布管理原则：并非每一个 feature 开发完成后都要立即<strong>签入</strong>至 develop 分支。切记，<strong>develop 仅关注本期迭代所需交付的功能</strong>，若不确定某 feature 是否需要交付，则不要对其进行合并，延迟合并时机</p>
</li>
<li><p>紧急回退原则*：若需从 develop 中移除某个 feature 分支的代码变更，可使用以下方案</p>
<ol>
<li>将 develop 重制到该 feature 合并之前，然后依次重新集成其他的 feature 进来，必要时，联系项目负责人进行辅助</li>
<li>新建 feature/remove-xxx 分支，在该分支中完成该 feature 分支对应的代码变更的反向操作，完成后发起新的 PR/MR </li>
</ol>
<blockquote>
<p>紧急回退涉及修改 develop 分支的历史记录，务必在项目负责人、 feature 开发人员的共同协作下完成。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>release</strong>：</p>
<ul>
<li>预发布分支的的名称必须是<strong>软件版本号相关的</strong>、<strong>递增的</strong>、<strong>可回溯的</strong></li>
<li>预发布分支的名称通常为 <code>release/x.y.z</code> 或 <code>release/Vx.y.z</code>（其中x，y，z均为数字，表示软件的<span class="exturl" data-url="aHR0cHM6Ly9zZW12ZXIub3JnL2xhbmcvemgtQ04v" title="https://semver.org/lang/zh-CN/">语义化版本号<i class="fa fa-external-link"></i></span>）或 <code>release/x.y.z-渠道版</code></li>
<li>预发布分支是软件交付（上线）相关的，每个预发布分支对应了某一个软件版本的交付（上线）过程，当软件顺利交付后，预发布分支的使命便已完成</li>
<li><strong>当 develop 分支凑齐了本期迭代所需交付的全部 feature 后</strong>，便可以从 develop 分支<strong>签出</strong> release 分支</li>
<li>预发布分支中仅进行发布前的<strong>修改</strong>与<strong>测试</strong>工作，例如：参数调节、配置修改、源码混淆、数据脱敏等修改操作；集成测试、端到端测试、验收测试等</li>
<li>预发布分支中的变更记录是非必须的，或许你已经在 develop 分支做足了发布前的全部准备，此时只需直接向 master 分支发起 PR/MR 即可。但预发布分支的存在仍很有意义，原因如下：<ol>
<li>有利于培养 gif-flow 的使用习惯</li>
<li>提供了潜在的修复机会</li>
<li>隔绝了预发测试阶段的临时到配置性变更对<strong>基线</strong>分支即 develop 造成污染，避免将仅适用于预发阶段的临时变更同步给其他分支。</li>
</ol>
</li>
<li>验收通过后，将 release 分支中的变更<strong>同时签入</strong>到 master 分支和 develop 分支中，同时删除此 release 分支，并在<strong>签入</strong>操作的提交记录上添加符合<span class="exturl" data-url="aHR0cHM6Ly9zZW12ZXIub3JnL2xhbmcvemgtQ04v" title="https://semver.org/lang/zh-CN/">语义化版本号<i class="fa fa-external-link"></i></span>的 Tag 名称（如：v1.1.0、v2.0.0），便于今后的溯源与问题修复</li>
</ul>
</li>
<li><p><strong>master</strong>：</p>
<ul>
<li>此分支的代码是稳定的、不易变动的，可以将 master 分支视为已发布软件代码的归档记录</li>
<li>master 分支仅纳入新版本发布（release）、问题修复的（hotfix）的变更记录</li>
</ul>
</li>
<li><p><strong>hotfix</strong>：</p>
<ul>
<li>hotfix 由 master 分支<strong>签出</strong></li>
<li>hotfix 分支仅用来进行紧急修复工作，新分支的名称通常为 <code>hotfix/xxx</code></li>
<li>当 bug 修复完成后，将 <code>hotfix/xxx</code>分支<strong>同时签入</strong>到 master 分支与 develop 分支中，同时删除此 hotfix 分支，并在<strong>签入</strong>操作的提交记录上添加符合<span class="exturl" data-url="aHR0cHM6Ly9zZW12ZXIub3JnL2xhbmcvemgtQ04v" title="https://semver.org/lang/zh-CN/">语义化版本号<i class="fa fa-external-link"></i></span>的 Tag 名称（如：v1.0.1、v2.0.3），便于今后的溯源与问题修复</li>
</ul>
</li>
</ul>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>git-flow 分支模型并不复杂，若仍对其感到困惑，可以通过文末的<strong>相关链接</strong>来进一步了解。此外，本节开始的<strong>git-flow 大图</strong>也非常有用，它足以表达出本文的大部分内容，熟悉它将有利于你对 git-flow 的理解，请将它存储到你的硬盘中，方便后续查看。</p>
<p>软件工程中没有银弹，git-flow 也并非万能。更多时候，还需要我们根据具体项目，因地制宜的作出一些变通。但至少 gif-flow 是一个有意义的开端，不是吗？</p>
<p>如仍对 gif-flow 的使用感到疑问，不妨在下方提出问题或意见。</p>
<h4 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h4><p>以下推荐几篇 gif-flow 相关的文章，其中 <strong>Vincent Driessen</strong> 是 git-flow 分支模型的<strong>提出者</strong>，首先推荐他的文章。</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9udmllLmNvbS9wb3N0cy9hLXN1Y2Nlc3NmdWwtZ2l0LWJyYW5jaGluZy1tb2RlbC8=" title="https://nvie.com/posts/a-successful-git-branching-model/">A successful Git branching model<i class="fa fa-external-link"></i></span> by <span class="exturl" data-url="aHR0cHM6Ly9udmllLmNvbS9hYm91dC8=" title="https://nvie.com/about/">Vincent Driessen<i class="fa fa-external-link"></i></span> </li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kYXRhc2lmdC5naXRodWIuaW8vZ2l0Zmxvdy9JbnRyb2R1Y2luZ0dpdEZsb3cuaHRtbA==" title="https://datasift.github.io/gitflow/IntroducingGitFlow.html">Introducing GitFlow<i class="fa fa-external-link"></i></span> by <span class="exturl" data-url="aHR0cDovL2RhdGFzaWZ0LmdpdGh1Yi5pby8=" title="http://datasift.github.io/">DataSift Team<i class="fa fa-external-link"></i></span> 。PS：此文对 <span class="exturl" data-url="aHR0cHM6Ly9udmllLmNvbS9hYm91dC8=" title="https://nvie.com/about/">Vincent Driessen<i class="fa fa-external-link"></i></span> 的 git-flow 模型进行了分步骤的讲述，简明扼要，恰到好处。</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2l0LXRvd2VyLmNvbS9sZWFybi9naXQvZWJvb2svY24vY29tbWFuZC1saW5lL2FkdmFuY2VkLXRvcGljcy9naXQtZmxvdw==" title="https://www.git-tower.com/learn/git/ebook/cn/command-line/advanced-topics/git-flow">git-flow 的工作流程<i class="fa fa-external-link"></i></span> by <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2l0LXRvd2VyLmNvbS8=" title="https://www.git-tower.com/">Tower Team<i class="fa fa-external-link"></i></span>。PS：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2l0LXRvd2VyLmNvbS9tYWM=" title="https://www.git-tower.com/mac">Tower<i class="fa fa-external-link"></i></span> 是一款 Mac 平台下的 git 客户端工具，该团队对 git-flow 的理解的非常到位，此文的阐述也十分得体，最重要的是 — 有中文。</li>
</ul>
<h3 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h3><h4 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h4><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ndWlkZXMuZ2l0aHViLmNvbS9pbnRyb2R1Y3Rpb24vZmxvdy8=" title="https://guides.github.com/introduction/flow/">GitHubFlow<i class="fa fa-external-link"></i></span>：Github 对 git-flow 的改进，开创性的提出 FORK/PR 的方式，进一步发挥 git 的分布式优势，于 2011 年发布</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvdG9waWNzL2dpdGxhYl9mbG93Lmh0bWw=" title="https://docs.gitlab.com/ee/topics/gitlab_flow.html">GitLabFlow<i class="fa fa-external-link"></i></span>：Gitlab  对 git-flow 和 github-flow 的改进，于 2014 年发布</li>
<li><span class="exturl" data-url="aHR0cHM6Ly90cnVua2Jhc2VkZGV2ZWxvcG1lbnQuY29tLw==" title="https://trunkbaseddevelopment.com/">Trunk Based Development<i class="fa fa-external-link"></i></span>：SVN 时代流传下来的分支模型</li>
</ul>
<h4 id="网络博文"><a href="#网络博文" class="headerlink" title="网络博文"></a>网络博文</h4><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly95cS5hbGl5dW4uY29tL2FydGljbGVzLzU3MzU0OQ==" title="https://yq.aliyun.com/articles/573549">AnoeFlow<i class="fa fa-external-link"></i></span>： 阿里内部基于 git-flow 延伸的 git 工作流，适用于互联网企业的动态发布模型。PS：某种程度上说，动态发布并非技术问题，而是产品规划对技术团队协作模型的挑战。</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kdWFucXouZ2l0aHViLmlvLzIwMTUtMDgtMzAtSW50cm8tdG8tYXV0b21lcmdlcg==" title="https://duanqz.github.io/2015-08-30-Intro-to-automerger">AOSP 代码管理<i class="fa fa-external-link"></i></span>：Android 系统源代码的管理方式，简单讲述了 Android 团队的内外部的协作流程。</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvODk2MDQzNDg4MDI5NjAw" title="https://www.liaoxuefeng.com/wiki/896043488029600">git 教程 - 廖雪峰<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5icm9maXZlLm9yZy8/cD0yMTY1" title="http://www.brofive.org/?p=2165">Git 代码分支模型（1）<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5icm9maXZlLm9yZy8/cD0yMjMz" title="http://www.brofive.org/?p=2233">Git 代码分支模型（2）<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5icm9maXZlLm9yZy8/cD00MzUy" title="http://www.brofive.org/?p=4352">Git 代码分支模型（3）<i class="fa fa-external-link"></i></span></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2019/09/07/Developing-Gradle-Plugin-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/07/Developing-Gradle-Plugin-1/" class="post-title-link" itemprop="url">自定义 Gradle 插件开发(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-07 20:05:31" itemprop="dateCreated datePublished" datetime="2019-09-07T20:05:31+08:00">2019-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/develop/" itemprop="url" rel="index"><span itemprop="name">develop</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/09/07/Developing-Gradle-Plugin-1/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/09/07/Developing-Gradle-Plugin-1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Gradle-插件简介"><a href="#Gradle-插件简介" class="headerlink" title="Gradle 插件简介"></a>Gradle 插件简介</h1><p><strong>Gradle 插件</strong>是一个能够将 Gradle 的构建逻辑（build logic）和构建任务（build task）打包到一起，以便在多个项目的构建脚本（build.gradle）中应用（apply）的工具。</p>
<p>例如，<code>build.gradle</code> 构建脚本文件内 <code>apply plugin: &#39;java&#39;</code> 、<code>apply plugin: &#39;com.android.application&#39;</code> 中的 <strong>java</strong>、<strong>com.android.application</strong> 就是官方提供的 Gradle 插件，通过应用这些插件，可以丰富项目的构建任务与构建逻辑。</p>
<p>除官方提供的插件外，Gradle 还允许开发者定义自己的 Gradle 插件。开发者可以根据实际需求定义自己的构建逻辑和构建任务，将其打包为 Gradle 插件，从而在多个项目的构建脚本中复用。此外，还可以将自定义的 Gradle 插件发布到 <span class="exturl" data-url="aHR0cHM6Ly9wbHVnaW5zLmdyYWRsZS5vcmcv" title="https://plugins.gradle.org/">plugin portal<i class="fa fa-external-link"></i></span> 或其他仓库中，更为方便的分享给他人使用。</p>
<p>Gradle 插件对编程语言没有太多限制，只要是能够被编译为 JVM 字节码的编程语言，都能用来编写 Gradle 插件。Gradle-API 的被设计为对 Groovy、Java、Koltin 友好的，通常情况下，使用 Java 或 Kotlin 这类静态类型语言实现的 Gradle 插件的性能要比使用 Groovy 实现的相同常见的性能更好。</p>
<h3 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h3><p>Gradle 作为一个普通的构建工具，本身并不依赖任何可视化 GUI 工具。为简化步骤，本文将采用命令行方式来完成自定义 Gradle 插件的演示。在开始之前，需先将 gradle 命令添加到系统环境变量中。</p>
<p>若读者在 IDEA / Android Studio 使用过 gradle ，则可在当前用户目录下找到 gradle 命令，具体路径如下</p>
<ul>
<li>Mac：<code>/Users/当前用户名/.gradle/wrapper/dists/gradle版本/沙盒路径/gradle版本/bin</code></li>
<li>Win：<code>C:\Users\当前用户名\.gradle\wrapper\dists\gradle版本\沙盒路径\gradle版本\bin</code></li>
</ul>
<p>若读者的电脑中尚未安装 gradle，则可在 <span class="exturl" data-url="aHR0cHM6Ly9ncmFkbGUub3JnL3JlbGVhc2VzLw==" title="https://gradle.org/releases/">Gradle 官方<i class="fa fa-external-link"></i></span> 下载安装。</p>
<p>以笔者使用的环境为例，gradle 命令所在目录为  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;.gradle&#x2F;wrapper&#x2F;dists&#x2F;gradle-5.4.1-all&#x2F;3221gyojl5jsh0helicew7rwx&#x2F;gradle-5.4.1&#x2F;bin</span><br></pre></td></tr></table></figure>

<p>将 gradle 命令所在目录添加到环境变量中</p>
<ul>
<li>Mac：在<code>~/.bashrc</code>中添加</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=~/.gradle/wrapper/dists/gradle-5.4.1-all/3221gyojl5jsh0helicew7rwx/gradle-5.4.1/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Win：在系统环境变量中添加 </li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\用户名\.<span class="title">gradle</span>\<span class="title">wrapper</span>\<span class="title">dists</span>\<span class="title">gradle</span>-5.4.1-<span class="title">all</span>\805<span class="title">usxkvhgx6e1wbo8o64g0tx</span>\<span class="title">gradle</span>-5.6.1\<span class="title">bin</span></span></span><br></pre></td></tr></table></figure>

<h3 id="牛刀小试"><a href="#牛刀小试" class="headerlink" title="牛刀小试"></a>牛刀小试</h3><p>在命令行中输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle --version</span><br></pre></td></tr></table></figure>

<p>得到如下输出则表示 gradle 环境设置成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------</span><br><span class="line">Gradle 5.4.1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build time:   2019-04-26 08:14:42 UTC</span><br><span class="line">Revision:     261d171646b36a6a28d5a19a69676cd098a4c19d</span><br><span class="line"></span><br><span class="line">Kotlin:       1.3.21</span><br><span class="line">Groovy:       2.5.4</span><br><span class="line">Ant:          Apache Ant(TM) version 1.9.13 compiled on July 10 2018</span><br><span class="line">JVM:          1.8.0_171 (Oracle Corporation 25.171-b11)</span><br><span class="line">OS:           Mac OS X 10.14.6 x86_64</span><br></pre></td></tr></table></figure>

<h2 id="自定义-Gradle-插件"><a href="#自定义-Gradle-插件" class="headerlink" title="自定义 Gradle 插件"></a>自定义 Gradle 插件</h2><p>自定义 gradle 插件可以在以下三个地方创建，分别是：</p>
<ol>
<li>构建脚本内</li>
<li>buildSrc 模块内</li>
<li>单独项目</li>
</ol>
<h3 id="构建脚本内建方式"><a href="#构建脚本内建方式" class="headerlink" title="构建脚本内建方式"></a>构建脚本内建方式</h3><p>在 <code>build.gradle</code> 内直接创建 Gradle 插件</p>
<p><strong>优点：</strong></p>
<ul>
<li><code>build.gradle</code>中创建的插件将<u><strong>被自动编译并包含在 classpath 中</strong></u>，使用时无需在构建脚本内指定 classpath</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>此插件仅在当前构建脚本中有效，对外部文件不可见，无法在当前构建脚本以外的其他地方复用此插件</li>
</ul>
<p><strong>示例</strong></p>
<h4 id="1-创建-BuildInDemo-目录"><a href="#1-创建-BuildInDemo-目录" class="headerlink" title="1.创建 BuildInDemo 目录"></a>1.创建 <code>BuildInDemo</code> 目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir BuildInDemo</span><br></pre></td></tr></table></figure>

<h4 id="2-在BuildInDemo目录内中新建-build-gradle-文件"><a href="#2-在BuildInDemo目录内中新建-build-gradle-文件" class="headerlink" title="2.在BuildInDemo目录内中新建 build.gradle 文件"></a>2.在<code>BuildInDemo</code>目录内中新建 <code>build.gradle</code> 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> BuildInDemo</span><br><span class="line">touch build.gradle</span><br></pre></td></tr></table></figure>

<p>使用 <code>tree</code> 命令查看创建后的目录结构，如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BuildInDemo</span><br><span class="line">.</span><br><span class="line">└── build.gradle</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br></pre></td></tr></table></figure>

<h4 id="3-在-BuildInDemo-build-gradle-内创建并应用-Gradle-插件，代码如下"><a href="#3-在-BuildInDemo-build-gradle-内创建并应用-Gradle-插件，代码如下" class="headerlink" title="3.在 BuildInDemo/build.gradle 内创建并应用 Gradle 插件，代码如下"></a>3.在 <code>BuildInDemo/build.gradle</code> 内创建并应用 Gradle 插件，代码如下</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建插件 BuildInPlugin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuildInPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line">    <span class="comment">// 2. 应用插件时执行此函数</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">void</span> apply(Project target) &#123;</span><br><span class="line">        println(<span class="string">"hello form build-in plugin"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//3. 应用插件</span></span><br><span class="line">apply <span class="string">plugin:</span> BuildInPlugin</span><br></pre></td></tr></table></figure>

<h4 id="4-构建此-build-gradle-文件"><a href="#4-构建此-build-gradle-文件" class="headerlink" title="4.构建此 build.gradle 文件"></a>4.构建此 <code>build.gradle</code> 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle build</span><br></pre></td></tr></table></figure>

<p>Gradle 构建时将执行 <code>build.gradle</code> 中的代码，当执行到 <code>apply plugin: BuildInPlugin</code> 时，将会调用 <strong>BuildInPlugin</strong> 的实例方法 <code>apply(Project p)</code>。因此在构建过程中，可以看到如下输出，其中第2行即为上一步自定义插件中打印的内容，表明插件应用成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configure project :</span><br><span class="line">hello form build-in plugin</span><br><span class="line"></span><br><span class="line">&gt; Task :buildEnvironment</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Root project</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">classpath</span><br><span class="line">No dependencies</span><br><span class="line"></span><br><span class="line">A web-based, searchable dependency report is available by adding the --scan option.</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 0s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>

<h3 id="buildSrc-模块方式"><a href="#buildSrc-模块方式" class="headerlink" title="buildSrc 模块方式"></a>buildSrc 模块方式</h3><p>rootProject/<strong>buildSrc</strong> 文件夹是 Gradle 的预留目录，用来存放当前项目私有 Gradle 插件的源代码与构建脚本</p>
<p>优点：</p>
<ul>
<li>项目构建时，Gradle 会自动编译项目目录下的 <strong>buildSrc</strong> 文件夹下的构建脚本和源码，并将其添加到项目构建脚本的 classpath 中，因此在使用 buildSrc 中创建的插件时，无需再手动指定 classpath </li>
<li>buildSrc 文件夹中构建脚本和 Gradle 插件同一项目均可见，因此同一项目中的其他模块也可以使用 <strong>buildSrc</strong> 中创建的插件</li>
</ul>
<p>缺点：</p>
<ul>
<li>此处创建的插件对外部项目不可见，无法在其他项目中复用</li>
</ul>
<p><strong>示例</strong></p>
<h4 id="1-创建-PluginBuildSrcDemo-项目模块"><a href="#1-创建-PluginBuildSrcDemo-项目模块" class="headerlink" title="1. 创建 PluginBuildSrcDemo 项目模块"></a>1. 创建 <code>PluginBuildSrcDemo</code> 项目模块</h4><p>创建 <code>PluginBuildSrcDemo</code> 目录，并在该目录下创建  <code>build.gradle</code>  文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir PluginBuildSrcDemo &amp;&amp; <span class="built_in">cd</span> PluginBuildSrcDemo &amp;&amp; touch build.gradle</span><br></pre></td></tr></table></figure>

<h4 id="2-创建-buildSrc-子模块"><a href="#2-创建-buildSrc-子模块" class="headerlink" title="2. 创建 buildSrc 子模块"></a>2. 创建 <code>buildSrc</code> 子模块</h4><h5 id="2-1-在-PluginBuildSrcDemo-目录下创建buildSrc目录"><a href="#2-1-在-PluginBuildSrcDemo-目录下创建buildSrc目录" class="headerlink" title="2.1 在 PluginBuildSrcDemo 目录下创建buildSrc目录"></a>2.1 在 <code>PluginBuildSrcDemo</code> 目录下创建<code>buildSrc</code>目录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir buildSrc</span><br></pre></td></tr></table></figure>

<h5 id="2-2-在-PluginBuildSrcDemo-buildSrc-目录下创建-buildSrc-子模块的构建脚本文件-build-gradle"><a href="#2-2-在-PluginBuildSrcDemo-buildSrc-目录下创建-buildSrc-子模块的构建脚本文件-build-gradle" class="headerlink" title="2.2 在 PluginBuildSrcDemo/buildSrc 目录下创建 buildSrc 子模块的构建脚本文件 build.gradle"></a>2.2 在 <code>PluginBuildSrcDemo/buildSrc</code> 目录下创建 <strong>buildSrc</strong> 子模块的构建脚本文件 <code>build.gradle</code></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> buildSrc</span><br><span class="line">touch build.gradle</span><br></pre></td></tr></table></figure>

<p><code>PluginBuildSrcDemo/buildSrc/build.gradle</code>的内容如下 </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 plugins 块语法应用插件</span></span><br><span class="line">plugins &#123;</span><br><span class="line">  <span class="comment">// 应用 kotlin 插件</span></span><br><span class="line">  id <span class="string">'org.jetbrains.kotlin.jvm'</span> version <span class="string">'1.3.50'</span></span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">  <span class="comment">// 仅在编译时使用 Grdale-API 依赖</span></span><br><span class="line">  compileOnly gradleApi()</span><br><span class="line">  <span class="comment">// 在插件源码中添加 kotlin 标准库依赖</span></span><br><span class="line">  implementation <span class="string">'org.jetbrains.kotlin:kotlin-stdlib'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-创建-buildSrc-模块的源码目录"><a href="#2-3-创建-buildSrc-模块的源码目录" class="headerlink" title="2.3 创建 buildSrc 模块的源码目录"></a>2.3 创建 <strong>buildSrc</strong> 模块的源码目录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd PluginBuildSrcDemo&#x2F;buildSrc</span><br><span class="line">mkdir -p &#x2F;src&#x2F;main&#x2F;kotlin&#x2F;com&#x2F;example&#x2F;plugin</span><br></pre></td></tr></table></figure>

<h5 id="2-4-创建插件文件PluginBuildSrc-kt"><a href="#2-4-创建插件文件PluginBuildSrc-kt" class="headerlink" title="2.4 创建插件文件PluginBuildSrc.kt"></a>2.4 创建插件文件<code>PluginBuildSrc.kt</code></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> PluginBuildSrcDemo/buildSrc/src/main/kotlin/com/example/plugin</span><br><span class="line">touch PluginBuildSrc.kt</span><br></pre></td></tr></table></figure>

<p><code>PluginBuildSrc.kt</code> 的代码如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Plugin</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Project</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginBuildSrc</span> : <span class="type">Plugin</span>&lt;<span class="type">Project</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(target: <span class="type">Project</span>)</span></span> &#123;</span><br><span class="line">    println(<span class="string">"hello from buildSrc plugin"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-5-声明-Gradle-插件的-ID-与实现类"><a href="#2-5-声明-Gradle-插件的-ID-与实现类" class="headerlink" title="2.5 声明 Gradle 插件的 ID 与实现类"></a>2.5 声明 Gradle 插件的 ID 与实现类</h5><blockquote>
<p>此步骤是可选的：若使用插件 ID 形式应用自定义插件，则必须进行此步骤；若使用插件实现类的形式应用自定义插件，则可跳过此步骤。</p>
</blockquote>
<p>完成此步骤的方式有两种，任选其一即可</p>
<h6 id="方式1-META-INF-方式"><a href="#方式1-META-INF-方式" class="headerlink" title="方式1.  META-INF 方式"></a>方式1.  META-INF 方式</h6><p>创建<code>PluginBuildSrcDemo/buildSrc/src/main/resources/META-INF/gradle-plugins</code>目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> PluginBuildSrcDemo/buildSrc</span><br><span class="line">mkdir -p src/main/resources/META-INF/gradle-plugins</span><br></pre></td></tr></table></figure>

<p>在 <code>gradle-plugins</code>目录下创建 <span style='color:red'>com.example.plugin</span>.properties 属性文件，红色部分表示插件的 ID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> src/main/resources/META-INF/gradle-plugins</span><br><span class="line">touch com.example.plugin.properties</span><br></pre></td></tr></table></figure>

<p>属性文件的内容如下，表示插件 ID 为 <span style='color:red'>com.example.plugin</span> 的插件所对应的实现类为 <code>com.example.plugin.PluginBuildSrc</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">implementations-class</span>=<span class="string">com.example.plugin.PluginBuildSrc</span></span><br></pre></td></tr></table></figure>

<h6 id="方式2-java-gradle-plugin-插件方式"><a href="#方式2-java-gradle-plugin-插件方式" class="headerlink" title="方式2. java-gradle-plugin 插件方式"></a>方式2. java-gradle-plugin 插件方式</h6><p>  <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdyYWRsZS5vcmcvY3VycmVudC91c2VyZ3VpZGUvamF2YV9ncmFkbGVfcGx1Z2luLmh0bWwjamF2YV9ncmFkbGVfcGx1Z2lu" title="https://docs.gradle.org/current/userguide/java_gradle_plugin.html#java_gradle_plugin">java-gradle-plugin<i class="fa fa-external-link"></i></span> 是一个用于开发 Gradle 插件的辅助插件，它内置了很多辅助功能：</p>
<ol>
<li>为宿主模块添加 <code>gradlePlugin</code> 配置块，可在此处配置插件的 ID 和实现类</li>
<li>为宿主模块添加 <code>complile gradleApi()</code> 依赖</li>
<li>etc…</li>
</ol>
<p>此处我们主要使用 <code>gradlePlugin</code> 配置块代替 <code>META-INF</code> 目录下的属性文件。<code>java-gradle-plugin</code>的使用方式非常简单，只需在<code>PluginBuildSrcDemo/buildSrc/build.gradle</code>构建脚本文件中简单配置即可，如下所示。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  plugins &#123;</span><br><span class="line">      id 'org.jetbrains.kotlin.jvm' version '1.3.50'</span><br><span class="line"><span class="addition">+ //1. 应用 java-gradle-plugin 插件</span></span><br><span class="line"><span class="addition">+     id 'java-gradle-plugin' </span></span><br><span class="line">  &#125;</span><br><span class="line">     </span><br><span class="line">  dependencies &#123;</span><br><span class="line"><span class="deletion">-     compileOnly gradleApi() // java-gradle-plugin 插件已为宿主添加 gradleApi 依赖，此行可移除 </span></span><br><span class="line">      implementation 'org.jetbrains.kotlin:kotlin-stdlib'</span><br><span class="line">  &#125;</span><br><span class="line"><span class="addition">+ //2. 添加 gradlePlugin 配置块信息</span></span><br><span class="line"><span class="addition">+ gradlePlugin &#123;</span></span><br><span class="line"><span class="addition">+     plugins&#123;</span></span><br><span class="line"><span class="addition">+         // 此处的 tag 可以为任意名称</span></span><br><span class="line"><span class="addition">+         tag1&#123;</span></span><br><span class="line"><span class="addition">+             id = 'com.example.plugin.buildsrc' //自定义插件的 ID</span></span><br><span class="line"><span class="addition">+             implementationClass  = 'com.example.plugin.PluginBuildSrc' //自定义插件的实现类</span></span><br><span class="line"><span class="addition">+         &#125;</span></span><br><span class="line"><span class="addition">+     &#125;</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>

<p>此时在 <strong>PluginBuildSrcDemo</strong> 目录下使用 <code>tree</code> 命令，可以看到当前的目录结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PluginBuildSrcDemo</span><br><span class="line">.</span><br><span class="line">├── build.gradle</span><br><span class="line">├── buildSrc</span><br><span class="line">│   ├── build.gradle</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main</span><br><span class="line">│           └── kotlin</span><br><span class="line">│               └── com</span><br><span class="line">│                   └── example</span><br><span class="line">│                       └── plugin</span><br><span class="line">│                           └── PluginBuildSrc.kt</span><br><span class="line">7 directories, 3 files</span><br></pre></td></tr></table></figure>

<h4 id="3-在-PruginBuildSrcDemo-项目模块中应用-buildSrc-中声明的-Gradle-插件"><a href="#3-在-PruginBuildSrcDemo-项目模块中应用-buildSrc-中声明的-Gradle-插件" class="headerlink" title="3. 在 PruginBuildSrcDemo 项目模块中应用 buildSrc 中声明的 Gradle 插件"></a>3. 在 <code>PruginBuildSrcDemo</code> 项目模块中应用 <code>buildSrc</code> 中声明的 Gradle 插件</h4><p>在 <code>PluginBuildSrcDemo/build.gradle</code> 构建脚本文件中添加如下代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//apply plugin: '插件 ID' </span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.example.plugin'</span></span><br><span class="line"><span class="comment">//apply plugin: 实现类</span></span><br><span class="line"><span class="comment">//apply plugin: com.example.plugin.PluginBuildSrc</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>应用插件时，指定插件 ID 或指定插件的实现类都可以，但指定插件 ID 的形式更为简短及灵活，在实际开发中也更为常见。</p>
</blockquote>
<p>在<code>PluginBuildSrcDemo</code>目录下执行 <code>gradle build</code> 命令进行构建，可看到如下输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configure project :</span><br><span class="line">hello from buildSrc plugin</span><br><span class="line"></span><br><span class="line">&gt; Task :buildEnvironment</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Root project</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">classpath</span><br><span class="line">No dependencies</span><br><span class="line"></span><br><span class="line">A web-based, searchable dependency report is available by adding the --scan option.</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 3s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>

<p>其中第2行是我们在 <strong>buildSrc 模块</strong>中定义的 Gradle 插件所打印日志，表明 <strong>buildSrc 模块</strong> 中的自定义插件在根项目中已生效。</p>
<h4 id="4-创建-SubModule-子模块"><a href="#4-创建-SubModule-子模块" class="headerlink" title="4. 创建 SubModule 子模块"></a>4. 创建 <code>SubModule</code> 子模块</h4><blockquote>
<p><strong>buildSrc 模块</strong>中定义的插件可以在同一项目的任意模块的构建脚本中使用，接下来便演示在 <strong>SubModule</strong> 子模块中的应用。</p>
</blockquote>
<h5 id="4-1-创建-SubModule-目录与构建脚本"><a href="#4-1-创建-SubModule-目录与构建脚本" class="headerlink" title="4.1 创建 SubModule 目录与构建脚本"></a>4.1 创建 SubModule 目录与构建脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 1. 在 PluginBuildSrcDemo 目录下创建 SubModule 目录</span><br><span class="line"><span class="built_in">cd</span> PluginBuildSrcDemo &amp;&amp; mkdir SubModule</span><br><span class="line">// 2. 在 SubModule 目录下新建 gradle 构建脚本 </span><br><span class="line"><span class="built_in">cd</span> SubModule</span><br><span class="line">touch build.gralde</span><br></pre></td></tr></table></figure>

<p><code>PluginBuildSrcDemo/SubModule/build.gradle</code>的内容如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.example.plugin'</span></span><br></pre></td></tr></table></figure>

<h5 id="4-2-将-SubModule-模块关联到-PluginBuildSrcDemo-项目中"><a href="#4-2-将-SubModule-模块关联到-PluginBuildSrcDemo-项目中" class="headerlink" title="4.2 将 SubModule 模块关联到 PluginBuildSrcDemo 项目中"></a>4.2 将 <strong>SubModule</strong> 模块关联到 <strong>PluginBuildSrcDemo</strong> 项目中</h5><p>在 <code>PluginBuildSrcDemo</code>目录下新建 <code>settings.gradle</code> 文件，内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 将SubModule 子模块添加到 PluginBuildSrcDemo 项目模块中</span><br><span class="line">include &#39;:SubModule&#39;</span><br></pre></td></tr></table></figure>

<p>此时在 <code>PluginBuildSrcDemo</code>目录下使用<code>tree</code>命令，可以看到项目当前的目录结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PluginBuildSrcDemo</span><br><span class="line">.</span><br><span class="line">├── SubModule</span><br><span class="line">│   └── build.gradle</span><br><span class="line">├── build.gradle</span><br><span class="line">├── buildSrc</span><br><span class="line">│   ├── build.gradle</span><br><span class="line">│   └── src</span><br><span class="line">│       └── main</span><br><span class="line">│           └── kotlin</span><br><span class="line">│               └── com</span><br><span class="line">│                   └── example</span><br><span class="line">│                       └── plugin</span><br><span class="line">│                           └── PluginBuildSrc.kt</span><br><span class="line">└── settings.gradle</span><br></pre></td></tr></table></figure>

<h4 id="5-在-SubModule-模块执行构建命令"><a href="#5-在-SubModule-模块执行构建命令" class="headerlink" title="5. 在 SubModule 模块执行构建命令"></a>5. 在 <code>SubModule</code> 模块执行构建命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> PluginBuildSrcDemo/SubModule</span><br><span class="line">gradle build</span><br></pre></td></tr></table></figure>

<p>得到如下输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configure project :SubModule</span><br><span class="line">hello from buildSrc plugin</span><br><span class="line"></span><br><span class="line">&gt; Task :SubModule:buildEnvironment</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Project :SubModule</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">classpath</span><br><span class="line">No dependencies</span><br><span class="line"></span><br><span class="line">A web-based, searchable dependency report is available by adding the --scan option.</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 0s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>

<h3 id="独立项目方式"><a href="#独立项目方式" class="headerlink" title="独立项目方式"></a>独立项目方式</h3><p>采用 <strong>buildSrc 模块</strong>方式时，Gradle 会妥善处理 <strong>buildSrc 模块</strong>的构建脚本与源码，并将其添加到当前项目的 classpath 中。但 buildSrc 方式的插件只能在项目内共享与复用，若要在其他项目中使用该插件，还需要再进行下列操作</p>
<ul>
<li>将插件发布到 maven 仓库（任意仓库）</li>
<li>在需要应用该插件的构建脚本中的 repository 部分添加该插件所在的 maven 仓库</li>
<li>在需要应用该插件的构建脚本中的 classpath 部分添加该插件对应的 maven 坐标(<strong>group : id : version</strong>)</li>
</ul>
<p>因为是在其他项目中使用该项目 <strong>buildSrc 模块</strong> 中的自定义 Gradle 插件，所以 Gradle 的 <strong>buildSrc</strong> 保留目录优势不再。如果将模块名由 <code>buildSrc</code> 修改为其他名称，则可将其称为独立的 Gradle 插件模块。</p>
<p>在本小节中，我们主要学习 gradle 插件的发布与使用。</p>
<h4 id="1-创建-gradle-插件项目"><a href="#1-创建-gradle-插件项目" class="headerlink" title="1. 创建 gradle 插件项目"></a>1. 创建 gradle 插件项目</h4><p>与 <strong>buildSrc</strong> 方式相同，先创建构建脚本与自定义插件类</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir StandaloneDemo </span><br><span class="line"><span class="built_in">cd</span> StandaloneDemo</span><br><span class="line">touch build.gradle</span><br><span class="line">mkdir src/main/kotlin/com/example/plugin</span><br><span class="line">touch src/main/kotlin/com/example/plugin/StandalonePlugin.kt</span><br></pre></td></tr></table></figure>

<p><code>StandaloneDemo/build.gradle</code> 的内容如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">'org.jetbrains.kotlin.jvm'</span> version <span class="string">'1.3.50'</span></span><br><span class="line">    id <span class="string">'java-gradle-plugin'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradlePlugin&#123;</span><br><span class="line">    plugins&#123;</span><br><span class="line">        sometag&#123;</span><br><span class="line">            id = <span class="string">'com.example.plugin'</span></span><br><span class="line">            implementationClass = <span class="string">'com.example.plugin.StandalonePlugin'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StandaloneDemo/src/main/kotlin/com/example/plugin/StandalonePlugin.kt</code>的内容如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Plugin</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Project</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StandalonePlugin</span> : <span class="type">Plugin</span>&lt;<span class="type">Project</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(target: <span class="type">Project</span>)</span></span> &#123;</span><br><span class="line">        println(<span class="string">"hello from standalone plugin"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-将-gradle-插件发布到-maven-仓库"><a href="#2-将-gradle-插件发布到-maven-仓库" class="headerlink" title="2. 将 gradle 插件发布到 maven 仓库"></a>2. 将 gradle 插件发布到 maven 仓库</h4><h5 id="2-1-在StandaloneDemo-build-gradle-文件中配置发布信息"><a href="#2-1-在StandaloneDemo-build-gradle-文件中配置发布信息" class="headerlink" title="2.1 在StandaloneDemo/build.gradle 文件中配置发布信息"></a>2.1 在<code>StandaloneDemo/build.gradle</code> 文件中配置发布信息</h5><p>使用<code>maven-publish</code>插件将自定义插件发布到本地 maven 仓库中，如下所示</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> plugins &#123;</span><br><span class="line">     id 'org.jetbrains.kotlin.jvm' version '1.3.50'</span><br><span class="line">     id 'java-gradle-plugin'</span><br><span class="line"><span class="addition">+    //1. 应用 maven-publish 插件</span></span><br><span class="line"><span class="addition">+    id 'maven-publish'</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> gradlePlugin&#123;</span><br><span class="line">     plugins&#123;</span><br><span class="line">         sometag&#123;</span><br><span class="line">             id = 'com.example.plugin'</span><br><span class="line">             implementationClass = 'com.example.plugin.StandalonePlugin'</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+//2. 设置发布相关配置</span></span><br><span class="line"><span class="addition">+publishing &#123;</span></span><br><span class="line"><span class="addition">+    publications &#123;</span></span><br><span class="line"><span class="addition">+        //3. 将插件发布到 maven 仓库</span></span><br><span class="line"><span class="addition">+        maven(MavenPublication) &#123;</span></span><br><span class="line"><span class="addition">+						//4. 设置插件的 maven 坐标</span></span><br><span class="line"><span class="addition">+            groupId 'com.example'//组织 ID</span></span><br><span class="line"><span class="addition">+            artifactId 'plugin'  //制品 ID</span></span><br><span class="line"><span class="addition">+            version 'snapshot'   //制品版本</span></span><br><span class="line"><span class="addition">+            from components.kotlin</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+ 	//5. 设置发布仓库</span></span><br><span class="line"><span class="addition">+   repositories &#123;</span></span><br><span class="line"><span class="addition">+       // 6. 发布到本地 maven 仓库 </span></span><br><span class="line"><span class="addition">+       mavenLocal()</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-使用-publishMavenPublicationToMavenLocal-任务将插件发布到本地仓库"><a href="#2-2-使用-publishMavenPublicationToMavenLocal-任务将插件发布到本地仓库" class="headerlink" title="2.2 使用 publishMavenPublicationToMavenLocal 任务将插件发布到本地仓库"></a>2.2 使用 <code>publishMavenPublicationToMavenLocal</code> 任务将插件发布到本地仓库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> StandaloneDemo</span><br><span class="line">gradle publishMavenPublicationToMavenLocal</span><br></pre></td></tr></table></figure>

<p>执行以上命令后，gradle 会把 <code>StandaloneDemo</code> 中的代码编译打包后发布到本地 maven 仓库中，本地 maven 仓库通常存放于当前用户目录下，具体路径为</p>
<ul>
<li>Mac： <code>~/.m2/repository</code></li>
<li>Win：<code>C:\Users\当前用户名\.m2\repository</code></li>
</ul>
<p>我们可以在此目录下看到刚刚发布的插件，如下图所示</p>
<p><img src="/uploads/gradle-plugin-dev-1.png" alt=""></p>
<h4 id="3-在其他项目中使用本地-maven-仓库中的-gradle-插件"><a href="#3-在其他项目中使用本地-maven-仓库中的-gradle-插件" class="headerlink" title="3. 在其他项目中使用本地 maven 仓库中的 gradle 插件"></a>3. 在其他项目中使用本地 maven 仓库中的 gradle 插件</h4><h5 id="3-1-新建-OtherProject项目"><a href="#3-1-新建-OtherProject项目" class="headerlink" title="3.1 新建 OtherProject项目"></a>3.1 新建 <code>OtherProject</code>项目</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir OtherProject</span><br><span class="line"><span class="built_in">cd</span> OtherProject</span><br><span class="line">touch build.gradle</span><br></pre></td></tr></table></figure>

<p><code>build.gradle</code>的文件内容如下，相比 <strong>buildSrc</strong> 方式，应用时多了 11 行的 buildscript 相关的配置信息。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+buildscript &#123;</span></span><br><span class="line"><span class="addition">+  repositories &#123;</span></span><br><span class="line"><span class="addition">+    //1. 为当前构建脚本添加插件所在的 maven 仓库，本例中为 maven 本地仓库</span></span><br><span class="line"><span class="addition">+    mavenLocal()</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+  dependencies &#123;</span></span><br><span class="line"><span class="addition">+    //2. 为当前构建脚本添加如下依赖</span></span><br><span class="line"><span class="addition">+    //`com.exaple`、`plugin`、`snapshot` 是在上一步中设置的 maven 三维坐标</span></span><br><span class="line"><span class="addition">+    classpath 'com.example:plugin:snapshot'</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> //3. 应用独立插件项目中的自定义插件</span><br><span class="line"> // apply plugin: '插件 ID'</span><br><span class="line"> apply plugin: 'com.example.plugin'</span><br></pre></td></tr></table></figure>

<h5 id="3-2-构建-OtherProject-项目"><a href="#3-2-构建-OtherProject-项目" class="headerlink" title="3.2 构建 OtherProject 项目"></a>3.2 构建 <code>OtherProject</code> 项目</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> OtherProject</span><br><span class="line">gradle build</span><br></pre></td></tr></table></figure>

<p>输入以上命令，得到如下输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; Configure project :</span><br><span class="line">hello from standalone plugin</span><br><span class="line"></span><br><span class="line">&gt; Task :buildEnvironment</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Root project</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">classpath</span><br><span class="line">\--- com.example:plugin:snapshot</span><br><span class="line"></span><br><span class="line">A web-based, searchable dependency report is available by adding the --scan option.</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> 0s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文演示了 gradle 插件的三种创建方式，相关代码已上传至 github 中，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dlZWs1bmFuL0dyYWRsZVBsdWdpbkRlbW8=" title="https://github.com/geek5nan/GradlePluginDemo">点此即可查看<i class="fa fa-external-link"></i></span>。行文匆忙难免疏忽，如有遗漏还请斧正。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2019/08/31/Kotlin-Everywhere-Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/31/Kotlin-Everywhere-Notes/" class="post-title-link" itemprop="url">Kotlin/Everywhere BeijingGDG 见闻录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-31 20:05:31" itemprop="dateCreated datePublished" datetime="2019-08-31T20:05:31+08:00">2019-08-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Events/" itemprop="url" rel="index"><span itemprop="name">Events</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/08/31/Kotlin-Everywhere-Notes/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/31/Kotlin-Everywhere-Notes/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Kotlin-Everywhere"><a href="#Kotlin-Everywhere" class="headerlink" title="Kotlin-Everywhere"></a>Kotlin-Everywhere</h2><p><img src="/uploads/GDG-Kotlin-Everywhere.png" alt=""></p>
<p>在今年五月份的 Google I/O 大会上，Google 宣布了 Android 应用开发中 Kotlin 优先的战略，此后 Google 提供的 API（例如 Jetpack 工具库）将以 Kotlin 优先。大会结束后不久，Google 便联合 Jetbrains 在全球范围内推出了 <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLWRldmVsb3BlcnMuZ29vZ2xlYmxvZy5jb20vMjAxOS8wNS9rb3RsaW4taXMtZXZlcnl3aGVyZS1qb2luLWdsb2JhbC1ldmVudC5odG1s" title="https://android-developers.googleblog.com/2019/05/kotlin-is-everywhere-join-global-event.html">Koltin/Everywhere<i class="fa fa-external-link"></i></span> 计划。<strong>Kotlin/Everywhere 计划</strong> 是由各地社区主导的一系列活动，旨在关注 Kotlin 在多平台上的潜力，并为学习 Kotlin 的基本要素与最佳实践提供帮助，包括但不限于 Android、服务端、前端和其他平台。</p>
<h2 id="Kotlin-Everywhere-Beijing"><a href="#Kotlin-Everywhere-Beijing" class="headerlink" title="Kotlin-Everywhere Beijing"></a>Kotlin-Everywhere Beijing</h2><p><img src="/uploads/GDGBeijing-Kotlin-1.png" alt="GDGBeijing-Kotlin-2"></p>
<p>笔者有幸和一位朋友一起参加了北京 GDG 与 Kotlin 中文社区共同主办的 <span class="exturl" data-url="aHR0cHM6Ly9rb3RsaW4uZ2RnYmVpamluZy5vcmcv" title="https://kotlin.gdgbeijing.org/">Kotlin/Everywhere Beijing<i class="fa fa-external-link"></i></span> ，这场活动的嘉宾阵容空前强大，台下观众高朋满座，各路大咖云集，可谓之国内规格最高的一场 <strong>Kotlin/Everywhere</strong> 活动。会议的全程录像可在 <span class="exturl" data-url="aHR0cDovL3BsYXkuaXRka3MuY29tL3dhdGNoLzE2MjEwNjk=" title="http://play.itdks.com/watch/1621069">大咖说<i class="fa fa-external-link"></i></span> 回放。</p>
<p><strong>日程安排</strong></p>
<table>
<thead>
<tr>
<th>时间</th>
<th>主题</th>
<th>嘉宾</th>
</tr>
</thead>
<tbody><tr>
<td>9:00-10:00</td>
<td>签到入场</td>
<td>-</td>
</tr>
<tr>
<td>10:00-10:10</td>
<td>开场介绍</td>
<td>韩国恺</td>
</tr>
<tr>
<td>10:10-10:50</td>
<td>What’s New in Kotlin</td>
<td>Svetlana Isakova</td>
</tr>
<tr>
<td>10:50-11:30</td>
<td>携程 Kotlin Multiplatform 工程实践</td>
<td>陈琦</td>
</tr>
<tr>
<td>11:30-12:10</td>
<td>潜力无限：Kotlin 用于服务端与 WebAssembly</td>
<td>贾彦伟</td>
</tr>
<tr>
<td>12:10-13:40</td>
<td>中午午休</td>
<td>-</td>
</tr>
<tr>
<td>13:40-14:20</td>
<td>Boost Your Productivity with Kotlin</td>
<td>陈龙博</td>
</tr>
<tr>
<td>14:20-15:00</td>
<td>Be Friends with kotlinc</td>
<td>段建华</td>
</tr>
<tr>
<td>15:00-15:20</td>
<td>下午茶歇</td>
<td>-</td>
</tr>
<tr>
<td>15:20-16:00</td>
<td>Kotlin High-Performance Programming</td>
<td>朱涛3</td>
</tr>
<tr>
<td>16:00-16:40</td>
<td>Kotlin Coroutine</td>
<td>朱凯</td>
</tr>
<tr>
<td>16:40-17:20</td>
<td>Kotlin 函数式编程</td>
<td>乔禹昂</td>
</tr>
</tbody></table>
<h3 id="上午"><a href="#上午" class="headerlink" title="上午"></a>上午</h3><p>我和朋友于九点半到达活动会场，会场签到处有 kotlin 主题的挎包、徽章、冰箱贴、贴纸等伴手礼，签到进场后发现观众席已落座 300 余人，便匆忙在一个靠中间的位置坐下，会场大屏播放着 Kotlin 相关的视频，视频中世界各地的开发者在表达着对 Kotlin 语言的喜爱，现场观众席也充斥着对 Kotlin 的探讨之声。</p>
<p><img src="/uploads/GDGBeijing-Kotlin-2.jpeg" alt="GDGBeijing-Kotlin-2"></p>
<p>稍等了一会，活动主持人韩国恺（北京 GDG 核心组织者）便登台对本次活动的议程进行了介绍，同时简要介绍了 Kotlin 的发展史，紧接着便由 Jetbrains 技术步道师、Kotlin 编译器团队早期成员 、《Kotlin in action》的作者 Svetlana Isakova 开始了本次活动的第一场主题演讲 — <strong>What’s New in Kotlin</strong>。</p>
<h4 id="What’s-New-in-Kotlin"><a href="#What’s-New-in-Kotlin" class="headerlink" title="What’s New in Kotlin"></a>What’s New in Kotlin</h4><p><img src="/uploads/GDGBeijing-Kotlin-3.jpeg" alt="GDGBeijing-Kotlin-3"></p>
<p>Svetlana Isakova 向大家介绍了 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2tvdGxpbi9rZWVw" title="https://github.com/kotlin/keep">KEEP — Kotlin Evolution and Enhancement Process<i class="fa fa-external-link"></i></span> ，表达出 JetBrains 重视开发者，乐于倾听开发者的反馈与心声。此外还介绍了一系列 Kotlin 的新特性，为开发者建立信心。</p>
<ul>
<li>Inline classes</li>
<li>Contract</li>
<li>Channel</li>
<li>Flows</li>
</ul>
<p>这些特性虽大多处于实验阶段，但它们所带来的效率提升的确值得期待。</p>
<h4 id="携程-Kotlin-Multiplatform-工程实践"><a href="#携程-Kotlin-Multiplatform-工程实践" class="headerlink" title="携程 Kotlin Multiplatform 工程实践"></a>携程 Kotlin Multiplatform 工程实践</h4><p><img src="/uploads/GDGBeijing-Kotlin-4.jpeg" alt="GDGBeijing-Kotlin-4"></p>
<p>接下来是携程机票研发部无线研发总监陈琦带来的 <strong>携程 Kotlin Multiplatform 工程实践</strong> 主题分享。</p>
<p><img src="/uploads/GDGBeijing-Kotlin-5.png" alt="GDGBeijing-Kotlin-5"></p>
<p>该主题讲述了携程跨平台使用 Kotlin 的实践进展，以及实践过程中所遇到的来自人员与技术方面的挑战和解决思路，同时讲述了 Kotlin 技术选型中的考察指标与验证方式，还有Kotlin Native 在内部研发工具方面的运用，可谓是干货满满。</p>
<h4 id="潜力无限：Kotlin-用于服务端与-WebAssembly"><a href="#潜力无限：Kotlin-用于服务端与-WebAssembly" class="headerlink" title="潜力无限：Kotlin 用于服务端与 WebAssembly"></a>潜力无限：Kotlin 用于服务端与 WebAssembly</h4><p><img src="/uploads/GDGBeijing-Kotlin-6.png" alt="GDGBeijing-Kotlin-6"></p>
<p>上午最后一场是由蔚来汽车技术经理贾彦伟带来的 <strong>潜力无限：Kotlin 用于服务端与 WebAssembly</strong> 主题分享，该主题介绍了 Kotlin 在服务端开发领域相关的 Web 框架，DB 连接库等以 Kotlin 语言编写的基础设施，此外还介绍了 WebAssembly 的现状与 Kotlin 对 WebAssembly 的态度，同时对 Kotlin 的美好未来进行了一番畅想。</p>
<p>上午的会议在十二点一刻结束，我和朋友在附近转了转，一路边找饭馆边探讨，最后在一家小饭馆简单吃了些便匆匆赶回会场。</p>
<h3 id="下午"><a href="#下午" class="headerlink" title="下午"></a>下午</h3><p>回到会场的时间还早，我和朋友在前排挑了两个座位。随着参会人员的陆续返回，一会儿的时间前排座位就再次满座。</p>
<h4 id="Boost-Your-Productivity-with-Kotlin"><a href="#Boost-Your-Productivity-with-Kotlin" class="headerlink" title="Boost Your Productivity with Kotlin"></a>Boost Your Productivity with Kotlin</h4><p><img src="/uploads/GDGBeijing-Kotlin-7.png" alt="GDGBeijing-Kotlin-7"></p>
<p>下午的第一场分享是由抖音 Android 工程师陈龙博(id:<span class="exturl" data-url="aHR0cHM6Ly9zbWFsbHNvaG8uY29tL2Fib3V0Lw==" title="https://smallsoho.com/about/">smallSoho<i class="fa fa-external-link"></i></span>)带来的 <strong>Boost Your Productivity with Kotlin</strong> ，陈龙博看起来是一个阳光活泼的大男孩，一上台就带动了现场的气氛，他在演讲中通过一些小例子来表达 kotlin 对开发者的友好和工作效率的提升，对还未使用 kotlin 的和 kotlin 的新手进行推广和指引。内容包括：</p>
<ol>
<li>data class</li>
<li>中缀表达式</li>
<li>let apply also 等标准函数</li>
<li>“真泛型”</li>
<li>集合操作的快捷方式</li>
<li>优雅的“DSL”</li>
<li>Sequence <span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81YjI4ZjQ5NDZmYjlhMDBlM2E1YTliOGM=" title="https://juejin.im/post/5b28f4946fb9a00e3a5a9b8c">[译]Kotlin中的龟(List)兔(Sequence)赛跑<i class="fa fa-external-link"></i></span></li>
<li>internal 关键字</li>
<li>Anko</li>
<li>Kotlin 编写 gradle 插件  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NtYWxsU29ob1NvbG8vTWNJbWFnZQ==" title="https://github.com/smallSohoSolo/McImage">McImage<i class="fa fa-external-link"></i></span></li>
<li>Kotlin 编写 .kts 脚本代替 python 脚本</li>
</ol>
<h4 id="Be-Friends-with-kotlinc"><a href="#Be-Friends-with-kotlinc" class="headerlink" title="Be Friends with kotlinc"></a>Be Friends with kotlinc</h4><p><img src="/uploads/GDGBeijing-Kotlin-8.jpg" alt="GDGBeijing-Kotlin-8"></p>
<p>第二场是由知名博主段建华(id:<span class="exturl" data-url="aHR0cHM6Ly9kcm9pZHl1ZS5jb20vYWJvdXQv" title="https://droidyue.com/about/">技术小黑屋<i class="fa fa-external-link"></i></span> )带来的 <strong>Be Friends with kotlinc</strong> 主题分享，他对 kotlin 的编译工具<code>kotlinc</code> 进行了讲解，通过反编译方式解释了 kotlin 非空类型、reified 泛型增强等特性在 kotlinc 中的实现方式，同时给出了 kotlinc 编译速度优化的一些方案（如 kapt build cache、worker api、compile avoidance、incremental build 等）；此外还介绍了一系列 kotlin 为兼容 Java 所提供的注解，如@JvmName 等。</p>
<p>前两场分享结束后迎来了二十分钟的茶歇时间，会议举办方提供了丰富的点心和饮品供参会者品用，不得不说北京GDG真的给力！</p>
<h4 id="Kotlin-High-Performance-Programming"><a href="#Kotlin-High-Performance-Programming" class="headerlink" title="Kotlin High-Performance Programming"></a>Kotlin High-Performance Programming</h4><p><img src="/uploads/GDGBeijing-Kotlin-9.jpg" alt="GDGBeijing-Kotlin-9"></p>
<p>品尝了点心和咖啡后再次回到会场，接下来是陌陌工程师朱涛带来第三场名为 <strong>Kotlin High-Performance Programming</strong> 的主题分享。</p>
<p>朱涛为大家介绍了 kotlin 的甜（语法糖）与盐（性能陷阱），同时给出了众多的 kotlin 陷阱规避 tips，堪称 Kotlin 效率编程实用宝典。此外，朱涛还介绍了他所建立的 kotlin lint ，但目前 lint 规则有限，且维护人员较少，期待后续有更好的发展并开源出来。</p>
<h4 id="Kotlin-的协程-Coroutines"><a href="#Kotlin-的协程-Coroutines" class="headerlink" title="Kotlin 的协程 Coroutines"></a>Kotlin 的协程 Coroutines</h4><p><img src="/uploads/GDGBeijing-Kotlin-10.jpg" alt="GDGBeijing-Kotlin-10"></p>
<p>下午第四场是由 Android 老司机、<span class="exturl" data-url="aHR0cHM6Ly9oZW5jb2Rlci5jb20v" title="https://hencoder.com/">HenCoder<i class="fa fa-external-link"></i></span> 创办人、知名博主<span class="exturl" data-url="aHR0cHM6Ly9nb29nbGUtZGV2ZWxvcGVycy5hcHBzcG90LmNvbS9jb21tdW5pdHkvZXhwZXJ0cy9kaXJlY3RvcnkvcHJvZmlsZS9wcm9maWxlLWthaV96aHU=" title="https://google-developers.appspot.com/community/experts/directory/profile/profile-kai_zhu">朱凯<i class="fa fa-external-link"></i></span>（id: 扔物线）带来的 <strong>Kotlin 的协程 Coroutines</strong>主题分享。</p>
<p><img src="/uploads/GDGBeijing-Kotlin-11.jpg" alt="GDGBeijing-Kotlin-11"></p>
<p>朱凯的台风四平八稳，讲课技巧高超，循循善诱的为大家讲解了 kotlin 协程与 suspend 关键字的来龙去脉，确实解决了 kotlin 初学者不少的疑惑。</p>
<h4 id="Kotlin-Functional-Programming"><a href="#Kotlin-Functional-Programming" class="headerlink" title="Kotlin Functional Programming"></a>Kotlin Functional Programming</h4><p><img src="/uploads/GDGBeijing-Kotlin-12.png" alt="GDGBeijing-Kotlin-12"></p>
<p>下午第五场也是本次活动的最后一场分享由来自 OkCoin 的工程师、Kotlin 中文网译者、Kotlin 中文社区运营 乔禹昂带来的 <strong>Kotlin Functional Programming</strong> 主题分享。</p>
<p>乔禹昂是一名资深的函数式编程爱好者，他从 Java 中的 lambda 到 kotlin 中的函数一一进行了讲解，演示了 kotlin 函数式编程的一些方式，并对 kotlin 中内联函数 inline 的使用提出了编译器限制和指定性意见，最后还总结了函数式编程的优势，也是充满干货的一篇分享。</p>
<h4 id="留影纪念"><a href="#留影纪念" class="headerlink" title="留影纪念"></a>留影纪念</h4><p>分享结束后，主办方同参会方进行了合影留念，照片取自朱涛朋友圈，侵删。</p>
<p><img src="/uploads/GDGBeijing-Kotlin-13.jpg" alt="GDGBeijing-Kotlin-13"></p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>本次的活动内容丰富干货满满，未来再有机会时，我想我还会积极参加。</p>
<p><strong>知识点拾遗</strong></p>
<ol>
<li>内联函数 inline 的在编译期的实现机制</li>
<li>kotlin contracts ：在代码中为编译器提供信息的通信元语</li>
<li>channel：kotlin 协程 coroutine 间通信的阻塞式队列</li>
<li>kotlinc：编译工具的使用和从反编译 .class 结果查看 kotlin 语法特性在 java 实现方式的友好途径</li>
<li>kotlin 协程与 “协程” 理论间的差异</li>
<li>kotlin 协程挂起 suspend 的本质</li>
<li>kotlin 泛型增强 reified 关键字在编译期的实现机制</li>
<li>kotlin flows 响应式 API 的使用</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2019/06/24/Insight-into-MultiType/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/24/Insight-into-MultiType/" class="post-title-link" itemprop="url">MultiType 源码学习小结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-24 22:26:26" itemprop="dateCreated datePublished" datetime="2019-06-24T22:26:26+08:00">2019-06-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">开源项目源码解析</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/06/24/Insight-into-MultiType/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/06/24/Insight-into-MultiType/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RyYWtlZXQvTXVsdGlUeXBl" title="https://github.com/drakeet/MultiType">MultiType<i class="fa fa-external-link"></i></span> 是一个为 RecycleView 创建多种 Item 的 Android 库，它的设计简洁优雅，源码阅读体验也很好，本文记录了笔者研读此项目源码的感悟。</p>
<h2 id="MultiType-的简单使用"><a href="#MultiType-的简单使用" class="headerlink" title="MultiType 的简单使用"></a>MultiType 的简单使用</h2><p>开始之前，先来看下 <strong>MultiType</strong> 的总体类图</p>
<p><img src="/uploads/MultiType-Class-Diagram.png" alt="MultiType 类图"></p>
<p>图中左侧 <code>MultiTypeAdapter</code> 是供外部访问的主要类，它的使用方式如下。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampleActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> adapter: MultiTypeAdapter</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> items: MutableList&lt;Any&gt;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    setContentView(R.layout.activity_list)</span><br><span class="line">    <span class="keyword">val</span> recyclerView = findViewById&lt;RecyclerView&gt;(R.id.list)</span><br><span class="line">    <span class="comment">// 实例化MultiTypeAdapter</span></span><br><span class="line">    adapter = MultiTypeAdapter()</span><br><span class="line">    <span class="comment">// 注册三种类型的 Item </span></span><br><span class="line">    adapter.register(TextItemViewBinder())</span><br><span class="line">    adapter.register(ImageItemViewBinder())</span><br><span class="line">    adapter.register(RichItemViewBinder())</span><br><span class="line">    recyclerView.adapter = adapter</span><br><span class="line">    <span class="comment">// 模拟数据</span></span><br><span class="line">    <span class="keyword">val</span> textItem = TextItem(<span class="string">"world"</span>)</span><br><span class="line">    <span class="keyword">val</span> imageItem = ImageItem(R.mipmap.ic_launcher)</span><br><span class="line">    <span class="keyword">val</span> richItem = RichItem(<span class="string">"小艾大人赛高"</span>, R.drawable.img_11)</span><br><span class="line">    items = ArrayList()</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span>..<span class="number">19</span>) &#123;</span><br><span class="line">      items.add(textItem)</span><br><span class="line">      items.add(imageItem)</span><br><span class="line">      items.add(richItem)</span><br><span class="line">    &#125;</span><br><span class="line">    adapter.items = items</span><br><span class="line">    adapter.notifyDataSetChanged()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图中<code>ItemViewBinder</code> 是一个负责创建 ItemView 与填充 Item 数据的抽象类，上述代码中的 <code>TextItemViewBinder</code> 、<code>ImageItemViewBinder</code> 与 <code>RichItemViewBinder</code> 均为<code>ItemViewBinder</code>的实现类。</p>
<p><code>ItemViewBinder</code>的代码看起来很直观，以<code>ImageItemViewBinder</code>为例，它的实现如下。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageItemViewBinder</span> : <span class="type">ItemViewBinder</span>&lt;<span class="type">ImageItem, ImageItemViewBinder.ImageHolder</span>&gt;</span>() &#123;</span><br><span class="line">  <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageHolder</span></span>(itemView: View) : RecyclerView.ViewHolder(itemView) &#123;</span><br><span class="line">    <span class="keyword">val</span> image: ImageView = itemView.findViewById(R.id.image)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, parent: <span class="type">ViewGroup</span>)</span></span>: ImageHolder &#123;</span><br><span class="line">    <span class="keyword">return</span> ImageHolder(inflater.inflate(R.layout.item_image, parent, <span class="literal">false</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ImageHolder</span>, item: <span class="type">ImageItem</span>)</span></span> &#123;</span><br><span class="line">    holder.image.setImageResource(item.resId)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，MultiType 将 Item 视图创建与数据填充的工作交给了 <code>ItemViewBinder</code>来完成。当有新类型的 ItemView 需求时，只需先创建一个继承于 <code>ItemViewBinder</code>的具体类，再将其注册到 <code>MultiTypeAdapter</code> 中即可。</p>
<h2 id="MultiType-源码解析"><a href="#MultiType-源码解析" class="headerlink" title="MultiType 源码解析"></a>MultiType 源码解析</h2><span id="segment1"/>

<h3 id="1-MultiTypeAdaprer-的-register-过程"><a href="#1-MultiTypeAdaprer-的-register-过程" class="headerlink" title="1. MultiTypeAdaprer 的 register 过程"></a>1. MultiTypeAdaprer 的 register 过程</h3><p>从 <code>MultiTypeAdapter</code> 入手，它有如下三个 成员变量。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> items: List&lt;Any&gt; = emptyList() <span class="comment">//  Adapter 内的 item 数据列表</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>       <span class="comment">//  MutableTypes 的初始容量</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> types: Types = MutableTypes(initialCapacity) <span class="comment">// 表示多种 Item 类型的容器</span></span><br></pre></td></tr></table></figure>

<p>以文章开头处的代码为例，先来看一下 <code>MultiTypeAdapter</code>的成员函数 <strong>register</strong> 的执行流程</p>
<div id="sequence-0"></div>


<h4 id="1-1-register-binder-ItemViewBinder-lt-T-gt"><a href="#1-1-register-binder-ItemViewBinder-lt-T-gt" class="headerlink" title="1.1 register(binder: ItemViewBinder&lt;T, *&gt;)"></a>1.1 register(binder: ItemViewBinder&lt;T, *&gt;)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T : Any&gt;</span> <span class="title">register</span><span class="params">(binder: <span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;)</span></span> &#123;</span><br><span class="line">  register(T::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>, <span class="type">binder)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数中将 <code>T</code> 声明为 <strong>refied</strong> ，表示 <code>T</code> 是一个具体的类型，随后在函数内部调用了同名重载函数 <code>register(clazz: Class&lt;T&gt;, binder: ItemViewBinder&lt;T, *&gt;)</code></p>
<h4 id="1-2-register-clazz-Class-binder-ItemViewBinder-lt-T-gt"><a href="#1-2-register-clazz-Class-binder-ItemViewBinder-lt-T-gt" class="headerlink" title="1.2 register(clazz: Class, binder: ItemViewBinder&lt;T, *&gt;)"></a>1.2 register(clazz: Class<T>, binder: ItemViewBinder&lt;T, *&gt;)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">register</span><span class="params">(clazz: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;, binder: <span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;)</span></span> &#123;</span><br><span class="line">  unregisterAllTypesIfNeeded(clazz)</span><br><span class="line">  register(Type(clazz, binder, DefaultLinker()))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若已使用 <strong>clazz</strong> 注册过，则先对其进行清除。接着将前面传递来的参数 <strong>clazz</strong> 、<strong>binder</strong> 与新建的<strong>DefaultLinker 对象</strong> 一起作为 <code>Type</code> 构造函数的参数，构建 <code>Type</code> 对象。然后调用同名重载函数<code>register(type:Type&lt;T&gt;)</code>。</p>
<span id="Type"/>

<p><code>Type</code> 是一个只有三个属性的 <strong>data class</strong>，它的实现如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Type</span>&lt;<span class="type">T</span>&gt;</span>(</span><br><span class="line">  <span class="keyword">val</span> clazz: Class&lt;<span class="keyword">out</span> T&gt;,</span><br><span class="line">  <span class="keyword">val</span> binder: ItemViewBinder&lt;T, *&gt;,</span><br><span class="line">  <span class="keyword">val</span> linker: Linker&lt;T&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h4 id="1-3-register-type-Type"><a href="#1-3-register-type-Type" class="headerlink" title="1.3 register(type: Type)"></a>1.3 register(type: Type<T>)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">register</span><span class="params">(type: <span class="type">Type</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">  types.register(type)</span><br><span class="line">  type.binder._adapter = <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处将上一步传来的 <strong>type对象</strong> 注册到 <code>MutableTypes</code>类型的成员变量 <strong>types</strong> 中，同时将 <code>MultiTypeAdapter</code> 自身的引用赋值给 <strong>type对象</strong> 中成员变量 <strong>binder</strong> 的属性 <strong>_adapter</strong>  ，便于后续的使用。</p>
<p>接下来看 <code>MutableTypes</code> 中 <strong>register</strong> 函数的实现</p>
<h4 id="1-4-MutableTypes-register-type-Type"><a href="#1-4-MutableTypes-register-type-Type" class="headerlink" title="1.4 MutableTypes.register(type:Type)"></a>1.4 MutableTypes.register(type:Type<T>)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableTypes</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> types: MutableList&lt;Type&lt;*&gt;&gt; = ArrayList(initialCapacity)</span><br><span class="line">) : Types &#123;</span><br><span class="line">......</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">register</span><span class="params">(type: <span class="type">Type</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    types.add(type)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">unregister</span><span class="params">(clazz: <span class="type">Class</span>&lt;*&gt;)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> types.removeAll &#123; it.clazz == clazz &#125;</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MutabaleTypes</code> 有属性 <strong>initialCapacity</strong> 、 <strong>types</strong> ，前者表示后者的默认容器大小，<strong>types</strong> 则是一个可变列表。另外还可以看到，<strong>MutbaleTypes</strong> 实现了 <strong>Types</strong> 接口，并重写了<strong>register</strong> 函数，此函数是将传入的参数 <strong>type</strong> 添加到 <strong>types</strong> 列表中。与 <strong>register</strong> 函数相反的还有另一个重写函数 <strong>unregister</strong> ，它是将某个指定的 <code>Class</code> 所对应的全部 <strong>Type 对象</strong>从 <strong>types</strong> 列表中移除。</p>
<h4 id="1-5小结"><a href="#1-5小结" class="headerlink" title="1.5小结"></a>1.5小结</h4><p>结合以上四步操作，可知 <code>MultiTypeAdapter</code> 的 <strong>register</strong> 函数实际是将待注册的 <strong>数据模型 Class 信息</strong>、<strong>数据模型对应的 ItemViewBinder</strong>、<strong>数据模型对应的 Linker（默认为 DefaultLinker）</strong> 组合为 <code>Type</code> 对象，然后将其添加到 <code>MultiTypeAdapter</code> 的属性 <strong>types</strong> 对应的<code>MutableTypes</code> 对象的属性 <strong>types</strong> 可变数组中，以供后续使用。</p>
<h3 id="2-MultiTypeAdapter-中-ViewHolder-创建与数据填充的过程"><a href="#2-MultiTypeAdapter-中-ViewHolder-创建与数据填充的过程" class="headerlink" title="2. MultiTypeAdapter  中 ViewHolder 创建与数据填充的过程"></a>2. MultiTypeAdapter  中 ViewHolder 创建与数据填充的过程</h3><p><code>MultiTypeAdapter</code> 是 <code>RecyclerView.Adapter</code> 的实现类，<code>RecyclerView.Adapter</code> 中与 ViewHolder 创建及数据填充的相关的函数主要有以下四个：</p>
<ol>
<li><strong>getItemViewType(position: Int): Int</strong> // 获取每一个 Item 对应的 View 类型</li>
<li><strong>onCreateViewHolder(parent: ViewGroup, indexViewType: Int): ViewHolder</strong> // 为特定类型的 Item 创建 ViewHolder</li>
<li><strong>onBindViewHolder(holder: ViewHolder, position: Int)</strong>  //为每一个 Item 进行数据填充</li>
<li><strong>getItemCount(): Int</strong>  // 获取 Adapter 内 Item 的数量</li>
</ol>
<p>我们主要观察 <code>MultiTypeAdapter</code> 中前三个函数的实现</p>
<h4 id="2-1-getItemViewType-position-Int-Int"><a href="#2-1-getItemViewType-position-Int-Int" class="headerlink" title="2.1 getItemViewType(position: Int): Int"></a>2.1 getItemViewType(position: Int): Int</h4><div id="sequence-1"></div>



<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiTypeAdapter</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> items: List&lt;Any&gt; = emptyList(),</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> types: Types = MutableTypes(initialCapacity)</span><br><span class="line">) : RecyclerView.Adapter&lt;ViewHolder&gt;() &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemViewType</span><span class="params">(position: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> indexInTypesOf(position, items[position])</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">  <span class="meta">@Throws(BinderNotFoundException::class)</span></span><br><span class="line">  <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">indexInTypesOf</span><span class="params">(position: <span class="type">Int</span>, item: <span class="type">Any</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> index = types.firstIndexOf(item.javaClass)</span><br><span class="line">    <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> linker = types.getType&lt;Any&gt;(index).linker</span><br><span class="line">      <span class="keyword">return</span> index + linker.index(position, item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> BinderNotFoundException(item.javaClass)</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先来看 <strong>getItemViewType</strong> 函数， 第8行代码，调用了 <strong>indexInTypesOf</strong> 函数，传递给后者的参数为当前 item 在列表中的位置 <strong>position</strong> 以及这个 <strong>item</strong> 对象。</p>
<p>再来看 <strong>indexInTypesOf</strong> 函数，第13行代码，成员变量 <strong>types</strong> 的 <strong>firstIndexOf</strong> 函数通过 item 的 <code>Class</code> 信息查询这个 <strong>item</strong> 在 <strong>types</strong> 中首次出现的索引值，若得到的索引值不是 -1 ，则表示表示与此 item 的 <code>Class</code> 信息相关联的 <code>Type</code> 对象已注册到 <code>MutbleTypes</code> 中；若得到的索引值是 -1 ，则表示与此 item 的 <code>Class</code> 想关联的 <code>Type</code> 对象未注册，并在第18行抛出自定义的运行时异常<code>BinderNotFoundException</code>。<strong>types</strong> 是类型为 <code>MutableTypes</code>的对象，<code>MutableTypes</code> 的 <strong>firstIndexOf</strong> 函数的实现如下。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableTypes</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> types: MutableList&lt;Type&lt;*&gt;&gt; = ArrayList(initialCapacity)</span><br><span class="line">) : Types &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">firstIndexOf</span><span class="params">(clazz: <span class="type">Class</span>&lt;*&gt;)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> index = types.indexOfFirst &#123; it.clazz == clazz &#125;</span><br><span class="line">    <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> index</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> types.indexOfFirst &#123; it.clazz.isAssignableFrom(clazz) &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MutbaleTypes</strong> 的 <strong>firstIndexOf</strong> 函数的形参是 <code>Class</code> 类型的 <code>clazz</code> 对象，第7行代码，在成员变量 <strong>types</strong> 列表中查找与 <strong>clazz</strong> 属性与形参一致的首个 <code>Type</code> 对象的索引值。若能查到（不为 -1），则直接返回此索引；若未查到，则尝试使用入参 <strong>clazz</strong> 的继承关系重新在成员变量 <strong>types</strong> 内查询一次，其中 <code>A.isAssignableFrom(B)</code> 表示判断<code>A</code>的 <code>Class</code> 信息是否为 <code>B</code> 的 <code>Class</code> 信息的接口或父类。</p>
<p>回到 <strong>indexInTypesOf</strong> 函数，第16行代码，返回上一步得到的索引值 <strong>index</strong> 与 <strong>linker.index(posotion,item)</strong> 相加的值，linker 的默认实现为 <code>DefaultLinker</code>，其 index 函数的返回值始终为 0 ，因此此处相加的值即为上一步得到的索引值 index，对于 linker 的特殊实现我们稍后在<a href="#one2many">第三小节</a>单独分析，此处暂且不表。</p>
<p>至此，我们知道 <strong>getItemViewType</strong> 函数的返回值 viewType 即为当前 item 的 <code>Class</code> 信息在 <code>MutableTypes</code> 的成员变量 <strong>types</strong> 列表中索引值。</p>
<h4 id="2-2-onCreateViewHolder-parent-ViewGroup-indexViewType-Int-ViewHolder"><a href="#2-2-onCreateViewHolder-parent-ViewGroup-indexViewType-Int-ViewHolder" class="headerlink" title="2.2 onCreateViewHolder(parent: ViewGroup, indexViewType: Int): ViewHolder"></a>2.2 onCreateViewHolder(parent: ViewGroup, indexViewType: Int): ViewHolder</h4><div id="sequence-2"></div>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiTypeAdapter</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> items: List&lt;Any&gt; = emptyList(),</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> types: Types = MutableTypes(initialCapacity)</span><br><span class="line">) : RecyclerView.Adapter&lt;ViewHolder&gt;() &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, indexViewType: <span class="type">Int</span>)</span></span>: ViewHolder &#123;</span><br><span class="line">    <span class="keyword">val</span> inflater = LayoutInflater.from(parent.context)</span><br><span class="line">    <span class="keyword">val</span> binder = types.getType&lt;Any&gt;(indexViewType).binder</span><br><span class="line">    <span class="keyword">return</span> binder.onCreateViewHolder(inflater, parent)</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 RecyclerView 需要一个新的 ViewHolder 时，<strong>onCreateViewHolder</strong> 函数会被调用，传入的 parent 表示RecycleView ，indexViewType 表示这个 item 对应的视图类型，即在 <code>getItemViewType</code> 函数的返回值</p>
<p> 第8行代码从传入的 <code>ViewGroup</code> 类型的 <strong>parent</strong> 参数中获取 <strong>context</strong> 对象，然后将此  <strong>context</strong> 作为参数调用 <code>LayoutInflater</code> 的静态方法 <strong>from</strong> ，得到 <code>Inflater</code> 类型 <strong>inflater</strong> 的对象。</p>
<p>第9行代码，通过传入的 <strong>indexViewType</strong> 参数，先调用属性 <strong>types</strong> 的 <strong>getType</strong> 函数获取 <code>Type</code> 类型的对象，然后得到 <code>Type</code> 对象的属性 <strong>binder</strong> 。  <strong>getType</strong> 函数的实现如下所示，只是将 index 对应的 <code>Type</code> 从 types 列表中取出，这个 <code>Type</code> 对象是在初始化时通过 <strong>register 函数</strong>添加到 <strong>types</strong> 列表中的，我们在第一小节中有介绍。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MutableTypes</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> types: MutableList&lt;Type&lt;*&gt;&gt; = ArrayList(initialCapacity)</span><br><span class="line">) : Types &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">getType</span><span class="params">(index: <span class="type">Int</span>)</span></span>: Type&lt;T&gt; = types[index] <span class="keyword">as</span> Type&lt;T&gt;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第10行代码，调用上一步得到的 <strong>binder 对象</strong>的成员函数 <strong>onCreateViewHolder</strong> 来完成 ViewHolder 的创建。</p>
<p>至此，我们了解了 ViewHolder 的创建过程。</p>
<h4 id="2-3-onBindViewHolder-holder-ViewHolder-position-Int"><a href="#2-3-onBindViewHolder-holder-ViewHolder-position-Int" class="headerlink" title="2.3 onBindViewHolder(holder: ViewHolder, position: Int)"></a>2.3 onBindViewHolder(holder: ViewHolder, position: Int)</h4><div id="sequence-3"></div>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiTypeAdapter</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> items: List&lt;Any&gt; = emptyList(),</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> types: Types = MutableTypes(initialCapacity)</span><br><span class="line">) : RecyclerView.Adapter&lt;ViewHolder&gt;() &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>, position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    onBindViewHolder(holder, position, emptyList())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>, position: <span class="type">Int</span>, payloads: <span class="type">List</span>&lt;<span class="type">Any</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> item = items[position]</span><br><span class="line">    getOutBinderByViewHolder(holder).onBindViewHolder(holder, item, payloads)</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getOutBinderByViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>)</span></span>: ItemViewBinder&lt;Any, ViewHolder&gt; &#123;</span><br><span class="line">    <span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span></span><br><span class="line">    <span class="keyword">return</span> types.getType&lt;Any&gt;(holder.itemViewType).binder <span class="keyword">as</span> ItemViewBinder&lt;Any, ViewHolder&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 RecyclerView 需要显示指定 position 位置的 Item 时，<code>MultiTypeAdapter</code> 的 <strong>onBindViewHolder</strong> 函数会被调用。</p>
<p>第7-9行代码，函数的形参 <strong>holder</strong> 是在 <strong>onCreateViewHolder</strong> 函数中创建的，<strong>position</strong> 是当前 Item 对应的位置。第8行代码调用了同名重载函数。</p>
<p>第11-14行代码，函数的形参中多了一个用于优化数据填充的 <strong>payloads</strong> 参数。第12行，先获取 position 对应的 item 对象。第13行，先通过成员函数 <strong>getOutBinderByViewHolder</strong> 获取具体的 <code>ItemViewBinder</code> 对象。</p>
<p><strong>getOutBinderByViewHolder</strong> 函数的实现也很直观。第19行代码，先通过<code>MultiTypes</code>类型的属性 <strong>types</strong> 的成员函数 <strong>getType</strong> 得到函数形参传递而来的 <strong>holder</strong> 对象的 <strong>itemViewType</strong> 属性所对应的 <code>Type</code>对象，然后将此<code>Type</code>对象的 <strong>binder</strong> 属性强转为 <code>ItemVIewBinder</code> 返回给调用方。</p>
<p>回到 <strong>onCreateViewHolder</strong> 函数，第13行代码，在得到当前 <strong>holder</strong> 对应的<code>ItemViewBinder</code>之后，接着便调用了这个<code>ItemViewBinder</code>对象的成员函数 <strong>onBindViewHolder</strong>，伴随的参数的是 <strong>holder</strong>，<strong>item</strong>与上一步传来的 <strong>payloads</strong>，从而完成了这个 ViewHolder 的数据填充。</p>
<h4 id="2-4-小结"><a href="#2-4-小结" class="headerlink" title="2.4 小结"></a>2.4 小结</h4><p><a href="#segment1">第一小节</a>中，<code>MultiTypeAdapter</code> 的  <strong>register</strong> 函数先将<strong>数据模型的 Class 信息</strong>、<strong>具体的 ItemViewBinder</strong> 以及 <strong>linker</strong> 封装为 <code>Type</code> 对象并添加到 <code>MutbaleTypes</code> 的成员变量 <strong>types</strong> 列表中。</p>
<p>本小节中解析的三个函数，均与第一小节中介绍的 <code>MutableTypes</code> 有关。</p>
<ul>
<li><strong>getItemViewType</strong> 函数根据当前 item 的 Class 信息获取其所对应的 Type 对象在 types 列表中的索引值；</li>
<li><strong>onCreateViewHolder</strong> 函数根据 getItemViewType 计算出的索引值在 types 列表中获取具体 ItemViewBinder， 然后使用调用这个 ItemViewBinder 的 onCreateViewHolder 函数创建具体的 ViewHolder；</li>
<li><strong>onBindViewHolder</strong> 函数根据 onCreateViewHolder 中创建的 holder 对象的成员变量 itemViewType 获取这个 holder 对应的 Type 对象的成员变量 binder，然后调用 binder 的 onBindViewHolder 完成数据填充。</li>
</ul>
<p><span id="one2many"></span></p>
<h3 id="3-MultiType-一对多"><a href="#3-MultiType-一对多" class="headerlink" title="3. MultiType 一对多"></a>3. MultiType 一对多</h3><p>MultiType 中的一对多是指 RecyclerView 中的同一份数据模型，对应多种 ViewHolder。如下所示，电商 App 的搜索结果页就属这种情况。</p>
<table>
<thead>
<tr>
<th>列表模式</th>
<th>大图模式</th>
</tr>
</thead>
<tbody><tr>
<td><img src="/uploads/MultiType-2.png" alt=""></td>
<td><img src="/uploads/MultiType-3.png" alt=""></td>
</tr>
</tbody></table>
<h4 id="3-1-one2many-简单实用"><a href="#3-1-one2many-简单实用" class="headerlink" title="3.1 one2many 简单实用"></a>3.1 one2many 简单实用</h4><p>下边以 MultiType 中的sample one2many 为入口，来了解一下 MultiType 是如何实现一对多的。开始之前，先来看一下 one2many 的运行截图。</p>
<img src="/uploads/One2ManySample_Expected.png" width="40%" height="40%">

<p>one2many sample 中包含以下四个类，其中 <code>Data</code> 是数据模型类，它有 <code>DataType1ViewBinder</code> 和 <code>DataType2ViewBinder</code> 两种样式。<code>OneDataToManyActivity</code> 是这个 sample 的 Activity。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">one2many</span><br><span class="line">  Data.kt</span><br><span class="line">  DataType1ViewBinder.kt</span><br><span class="line">  DataType2ViewBinder.kt</span><br><span class="line">  OneDataToManyActivity.kt</span><br></pre></td></tr></table></figure>

<p><code>Data</code> 类的代码如下，它有 <strong>title</strong> 和 <strong>type</strong> 两个成员变量，前者用来显示，后者表示其对应的 <code>ViewBinder</code> 类型。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Data</span></span>(</span><br><span class="line">  <span class="meta">@field:SerializedName</span>(<span class="string">"title"</span>) <span class="keyword">var</span> title: String,</span><br><span class="line">  <span class="meta">@field:SerializedName</span>(<span class="string">"type"</span>) <span class="keyword">var</span> type: <span class="built_in">Int</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> TYPE_1 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> TYPE_2 = <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DataType1ViewBinder</code> 和 <code>DataType2ViewBinder</code> 的区别仅是 layout 不同，如下所示。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- class DataType1ViewBinder : ItemViewBinder&lt;Data, DataType1ViewBinder.ViewHolder&gt;() &#123;</span></span><br><span class="line"><span class="addition">+ class DataType2ViewBinder : ItemViewBinder&lt;Data, DataType2ViewBinder.ViewHolder&gt;() &#123;</span></span><br><span class="line"></span><br><span class="line">  override fun onCreateViewHolder(inflater: LayoutInflater, parent: ViewGroup): ViewHolder &#123;</span><br><span class="line"><span class="deletion">-    return ViewHolder(inflater.inflate(R.layout.item_data_type1, parent, false))</span></span><br><span class="line"><span class="addition">+    return ViewHolder(inflater.inflate(R.layout.item_data_type2, parent, false))    </span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override fun onBindViewHolder(holder: ViewHolder, item: Data) &#123;</span><br><span class="line">    holder.setTitle(item.title)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  class ViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) &#123;</span><br><span class="line"></span><br><span class="line">    private var titleView: TextView = itemView.findViewById(android.R.id.title)</span><br><span class="line"></span><br><span class="line">    fun setTitle(title: String) &#123;</span><br><span class="line">      titleView.text = title</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>R.layout.item_data_type1 与 R.layout.item_data_type2 的区别仅是 gravity 不同，如下所示。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;LinearLayout</span><br><span class="line">    xmlns:android="http://schemas.android.com/apk/res/android"</span><br><span class="line">    xmlns:tools="http://schemas.android.com/tools"</span><br><span class="line">    android:layout_width="match_parent"</span><br><span class="line">    android:layout_height="wrap_content"</span><br><span class="line">    android:orientation="vertical"</span><br><span class="line"><span class="deletion">-    android:gravity="start"&gt; //R.layout.item_data_type1</span></span><br><span class="line"><span class="addition">+    android:gravity="end"&gt;   //R.layout.item_data_type2</span></span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id="@android:id/title"</span><br><span class="line">        android:layout_width="wrap_content"</span><br><span class="line">        android:layout_height="wrap_content"</span><br><span class="line">        android:padding="12dp"</span><br><span class="line">        android:hint="right"</span><br><span class="line">        tools:text="title"/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>

<p><code>OneDataToManyActivity</code> 中的代码如下，其 register 部分与<a href="#segment1">第一小节</a>有明显不同。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OneDataToManyActivity</span> : <span class="type">MenuBaseActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@VisibleForTesting</span></span><br><span class="line">  <span class="keyword">lateinit</span> <span class="keyword">var</span> recyclerView: RecyclerView</span><br><span class="line">  <span class="meta">@VisibleForTesting</span></span><br><span class="line">  <span class="keyword">lateinit</span> <span class="keyword">var</span> adapter: MultiTypeAdapter</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> dataFromService: List&lt;Data&gt;</span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">      <span class="keyword">val</span> list = ArrayList&lt;Data&gt;()</span><br><span class="line">      <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">      <span class="keyword">while</span> (i &lt; <span class="number">30</span>) &#123;</span><br><span class="line">        list.add(Data(<span class="string">"title: <span class="variable">$i</span>"</span>, Data.TYPE_1))</span><br><span class="line">        list.add(Data(<span class="string">"title: <span class="subst">$&#123; i + <span class="number">1</span> &#125;</span>"</span>, Data.TYPE_2))</span><br><span class="line">        i += <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> list</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    setContentView(R.layout.activity_list)</span><br><span class="line">    recyclerView = findViewById(R.id.list)</span><br><span class="line">    adapter = MultiTypeAdapter()</span><br><span class="line"></span><br><span class="line">    adapter.register(Data::<span class="class"><span class="keyword">class</span>).<span class="title">to</span></span>(</span><br><span class="line">      DataType1ViewBinder(),</span><br><span class="line">      DataType2ViewBinder()</span><br><span class="line">    ).withKotlinClassLinker(<span class="keyword">object</span> :KotlinClassLinker&lt;Data&gt;&#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">index</span><span class="params">(position: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Data</span>)</span></span>: KClass&lt;<span class="keyword">out</span> ItemViewBinder&lt;Data, *&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> (<span class="keyword">data</span>.type) &#123;</span><br><span class="line">          Data.TYPE_2 -&gt; DataType2ViewBinder::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">          <span class="keyword">else</span> -&gt; DataType1ViewBinder::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    adapter.items = dataFromService</span><br><span class="line">    adapter.notifyDataSetChanged()</span><br><span class="line">    recyclerView.adapter = adapter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-one2many-的-register-过程"><a href="#3-2-one2many-的-register-过程" class="headerlink" title="3.2 one2many 的 register 过程"></a>3.2 one2many 的 register 过程</h4><div id="sequence-4"></div>

<p><code>MultiTypeAdapter</code> 一对多的 <strong>register</strong> 函数实现如下。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiTypeAdapter</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> items: List&lt;Any&gt; = emptyList(),</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">val</span> initialCapacity: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">open</span> <span class="keyword">var</span> types: Types = MutableTypes(initialCapacity)</span><br><span class="line">) : RecyclerView.Adapter&lt;ViewHolder&gt;() &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : Any&gt;</span> <span class="title">register</span><span class="params">(clazz: <span class="type">KClass</span>&lt;<span class="type">T</span>&gt;)</span></span>: OneToManyFlow&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> register(clazz.java)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">register</span><span class="params">(clazz: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: OneToManyFlow&lt;T&gt; &#123;</span><br><span class="line">    unregisterAllTypesIfNeeded(clazz)</span><br><span class="line">    <span class="keyword">return</span> OneToManyBuilder(<span class="keyword">this</span>, clazz)</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>register</strong> 函数，第9行代码，获取调用方传来的 <code>KClass</code> 对象的 javaClass 变量，然后调用同名重载函数。第14行代码，尝试移除此 javaClass 已经关联的 <code>Type</code>。第15行代码，创建 <code>OneToManyBuilder</code> 对象并返回给调用方。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">adapter.register(Data::<span class="class"><span class="keyword">class</span>).<span class="title">to</span></span>(</span><br><span class="line">  DataType1ViewBinder(),</span><br><span class="line">  DataType2ViewBinder()</span><br><span class="line">).withKotlinClassLinker(<span class="keyword">object</span> :KotlinClassLinker&lt;Data&gt;&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">index</span><span class="params">(position: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Data</span>)</span></span>: KClass&lt;<span class="keyword">out</span> ItemViewBinder&lt;Data, *&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">when</span> (<span class="keyword">data</span>.type) &#123;</span><br><span class="line">      Data.TYPE_2 -&gt; DataType2ViewBinder::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">      <span class="keyword">else</span> -&gt; DataType1ViewBinder::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>回到 <strong>OneDataToManyActivity</strong> 的 <strong>onCreate</strong> 方法。第1行代码，在调用 <code>MultiTypeAdapter</code> 的 <strong>register</strong> 函数后得到了 <code>OneToManyBulder</code> 对象，紧接着调用该对象的 <strong>to</strong> 函数，并将 <code>DataType1ViewBinder()</code>, <code>DataType2ViewBinder()</code> 作为参数传入。第30-37行代码，调用 <code>OneToManyBulder</code> 对象的 <strong>withKotlinClassLinker</strong> 函数，并新建了一个 <code>KotlinClassLinker</code> 的匿名内部类的对象作为此函数的实际参数。</p>
<p>接下来我们来看下 <code>OneToManyBulder</code> 的代码，它实现了 <code>OneToManyFlow</code> 和 <code>OneToManyEndpoint</code> 这两个接口。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToManyBuilder</span>&lt;<span class="type">T</span>&gt;</span>(</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> adapter: MultiTypeAdapter,</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> clazz: Class&lt;T&gt;</span><br><span class="line">) : OneToManyFlow&lt;T&gt;, OneToManyEndpoint&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> binders: Array&lt;ItemViewBinder&lt;T, *&gt;&gt;? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@SafeVarargs</span></span><br><span class="line">  <span class="meta">@CheckResult(suggest = <span class="meta-string">"#withLinker(Linker)"</span>)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">to</span><span class="params">(<span class="keyword">vararg</span> binders: <span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;)</span></span> = apply &#123;</span><br><span class="line">    <span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span></span><br><span class="line">    <span class="keyword">this</span>.binders = binders <span class="keyword">as</span> Array&lt;ItemViewBinder&lt;T, *&gt;&gt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">withLinker</span><span class="params">(linker: <span class="type">Linker</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    doRegister(linker)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">withJavaClassLinker</span><span class="params">(javaClassLinker: <span class="type">JavaClassLinker</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    withLinker(ClassLinkerBridge.toLinker(javaClassLinker, binders!!))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">doRegister</span><span class="params">(linker: <span class="type">Linker</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (binder <span class="keyword">in</span> binders!!) &#123;</span><br><span class="line">      adapter.register(Type(clazz, binder, linker))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------接口代码--------------------</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OneToManyFlow</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@CheckResult</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">to</span><span class="params">(<span class="keyword">vararg</span> binders: <span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;)</span></span>: OneToManyEndpoint&lt;T&gt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OneToManyEndpoint</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">withLinker</span><span class="params">(linker: <span class="type">Linker</span>&lt;<span class="type">T</span>&gt;)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">withLinker</span><span class="params">(linker: (<span class="type">position</span>: <span class="type">Int</span>, <span class="type">item</span>: <span class="type">T</span>) -&gt; <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    withLinker(<span class="keyword">object</span> : Linker&lt;T&gt; &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">index</span><span class="params">(position: <span class="type">Int</span>, item: <span class="type">T</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> linker(position, item)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">withJavaClassLinker</span><span class="params">(javaClassLinker: <span class="type">JavaClassLinker</span>&lt;<span class="type">T</span>&gt;)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">withJavaClassLinker</span><span class="params">(classLinker: (<span class="type">position</span>: <span class="type">Int</span>, <span class="type">item</span>: <span class="type">T</span>) -&gt; <span class="type">Class</span>&lt;<span class="type">out</span> <span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;&gt;)</span></span> &#123;</span><br><span class="line">    withJavaClassLinker(<span class="keyword">object</span> : JavaClassLinker&lt;T&gt; &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">index</span><span class="params">(position: <span class="type">Int</span>, item: <span class="type">T</span>)</span></span>: Class&lt;<span class="keyword">out</span> ItemViewBinder&lt;T, *&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> classLinker(position, item)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">withKotlinClassLinker</span><span class="params">(classLinker: <span class="type">KotlinClassLinker</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    withJavaClassLinker &#123; position, item -&gt; classLinker.index(position, item).java &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">withKotlinClassLinker</span><span class="params">(classLinker: (<span class="type">position</span>: <span class="type">Int</span>, <span class="type">item</span>: <span class="type">T</span>) -&gt; <span class="type">KClass</span>&lt;<span class="type">out</span> <span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;&gt;)</span></span> &#123;</span><br><span class="line">    withJavaClassLinker &#123; position, item -&gt; classLinker(position, item).java &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OneToManyBuilder 有 <strong>adapter</strong>，<strong>clazz</strong> 两个属性，如之前所述，这两个属性在 <code>MultiTypeAdapter</code> 的 <strong>register</strong> 函数中被赋值。</p>
<p>第10行代码，<code>to(vararg binders: ItemViewBinder&lt;T, *&gt;)</code> 函数声明中的的 <code>vararg</code>关键字，对应 Java 中的可变参数符号 <code>…</code>，此处表示 <strong>to</strong> 函数可以接受一个或多个 <code>ItemViewBinder</code> 类型的对象作为参数。<strong>to</strong> 函数的实现是将调用方传入的参数 <strong>binders</strong> 赋值给 <code>OneToManyBuilder</code> 的属性 <strong>binders</strong>。</p>
<p><span id="withKotlinClassLinker"/><code>OneToManyBuilder</code>并未重写 <strong>withKotlinClassLinker</strong> 函数，因此当调用方调用此函数时，会调用到<code>OneToManyEndpoint</code>接口内的默认函数 <strong>withKotlinClassLinker</strong>。此函数有两个重载版本，一个接受 <code>KotlinClassLinker</code> 类型的对象作为参数，另一个接受<code>(position: Int, item: T) -&gt; KClass&lt;out ItemViewBinder&lt;T, *&gt;&gt;)</code>类型的 <strong>lambda</strong> 变量作为参数，这两个默认函数内部都会调用第48行的默认函数 <strong>withJavaClassLinker</strong> 来将上层调用方传来的 <code>KotlinClassLinker</code> 类型的对象转换为 <code>JavaClassLinker</code> 类型的对象。</p>
<p>默认函数 <strong>withJavaClassLinker</strong> 内部又调用了同名重载函数 <strong>withJavaClassLinker</strong> ，并将新建的<code>JavaClassLinker</code> 对象作为参数传递过去。</p>
<p><code>OneToManyBuilder</code>重写了这个重载的 <strong>withJavaClassLinker</strong> 函数，第19行代码，先将上一步传来的 <strong>javaClassLinker</strong> 与它的 <strong>binders</strong> 属性作为参数，调用了 <code>ClassLinkerBridge</code> 的静态函数 <strong>toLinker</strong> 将其转化为<code>ClassLinkerBridge</code> 类型的对象，<code>ClassLinkderBridge</code>的实现如下。<span id="ClassLinkerBridge"/></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLinkerBridge</span>&lt;<span class="type">T</span>&gt; <span class="keyword">private</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> javaClassLinker: JavaClassLinker&lt;T&gt;,</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> binders: Array&lt;ItemViewBinder&lt;T, *&gt;&gt;</span><br><span class="line">) : Linker&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">index</span><span class="params">(position: <span class="type">Int</span>, item: <span class="type">T</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> indexedClass = javaClassLinker.index(position, item)</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> binders.indices) &#123;</span><br><span class="line">      <span class="keyword">if</span> (binders[i].javaClass == indexedClass) &#123;</span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> IndexOutOfBoundsException(</span><br><span class="line">      <span class="string">"The binders'(<span class="subst">$&#123;binders.contentToString()&#125;</span>) you registered do not contain this <span class="subst">$&#123;indexedClass.name&#125;</span>."</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">toLinker</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      javaClassLinker: <span class="type">JavaClassLinker</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">      binders: <span class="type">Array</span>&lt;<span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: Linker&lt;T&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> ClassLinkerBridge(javaClassLinker, binders)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ClassLinkerBridge</code>实现了 <code>Linker</code> 接口并重写了此接口的 <strong>index</strong> 函数。第7行代码，通过调用方传入的 <strong>javaClssLinker</strong> 参数，获取 <strong>position</strong> 与 <strong>item</strong> 所对应的 <code>ItemViewBinder</code> 的 <code>Class</code> 信息。第8-12 行代码，获取这个<code>Class</code> 对应的 <code>ItemViewBinder</code> 在属性 <strong>binders</strong> 列表中的索引值，若查找不到，则抛出自定义异常 <code>IndexOutOfBoundsException</code>。</p>
<p>回到<code>OneToManyBuilder</code>中，第19行代码，将上一步得到 <code>ClassLinkerBridge</code> 对象作为参数调用了第15行的<strong>withLinker</strong> 函数，此函数内部调用了第23行的 <strong>doRegister</strong> 函数。<strong>doRegister</strong> 函数内对<code>OneToManyBuilder</code>的属性 <strong>binders</strong> 进行遍历，并将其中的每一个 <strong>binder</strong>与 <strong>clazz</strong> 属性和传入的参数<strong>linker</strong>组合为 <code>Type</code> 对象，注册到 <code>MutableTypes</code> 中。因此对于同一份数据模型，会在 <code>MutableTypes</code> 中注册多个 <code>Type</code>。此处索引值的设计思路非常巧妙，随后会单独讨论。</p>
<h4 id="3-3-one2many-中-ViewHolder-的创建"><a href="#3-3-one2many-中-ViewHolder-的创建" class="headerlink" title="3.3 one2many 中 ViewHolder 的创建"></a>3.3 one2many 中 ViewHolder 的创建</h4><div id="sequence-5"></div>

<p>通过前面的分析我们知道，<code>RecyclerView</code> 中 ViewHolder 的创建与 ItemViewType 有关，而 ItemViewType 源于 Adapter 中的 getItemViewType 函数，我们再来看一下<code>MultiTypeAdapter</code> 中 <strong>getItemViewType</strong> 的实现。<span id="indexInTypesOf"/></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemViewType</span><span class="params">(position: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> indexInTypesOf(position, items[position])</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Throws(BinderNotFoundException::class)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">indexInTypesOf</span><span class="params">(position: <span class="type">Int</span>, item: <span class="type">Any</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">  <span class="keyword">val</span> index = types.firstIndexOf(item.javaClass)</span><br><span class="line">  <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> linker = types.getType&lt;Any&gt;(index).linker</span><br><span class="line">    <span class="keyword">return</span> index + linker.index(position, item)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> BinderNotFoundException(item.javaClass)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第8行代码，根据当前索引得到在 <code>MutableTypes</code>中注册的 <code>Type</code> 对象的属性 <strong>linker</strong> ，这个 <strong>linker</strong> 便是我们在 <strong>3.2</strong>中见到过的<a href="#ClassLinkerBridge">ClassLinkerBridge</a>。第9行代码，调用这个 <strong>linker</strong> 对象的 <strong>index</strong> 函数，<strong>index</strong> 的实现如下。<span id="ClassLinkerBridge_index"/></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLinkerBridge</span>&lt;<span class="type">T</span>&gt; <span class="keyword">private</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> javaClassLinker: JavaClassLinker&lt;T&gt;,</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> binders: Array&lt;ItemViewBinder&lt;T, *&gt;&gt;</span><br><span class="line">) : Linker&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">index</span><span class="params">(position: <span class="type">Int</span>, item: <span class="type">T</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> indexedClass = javaClassLinker.index(position, item)</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> binders.indices) &#123;</span><br><span class="line">      <span class="keyword">if</span> (binders[i].javaClass == indexedClass) &#123;</span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> IndexOutOfBoundsException(</span><br><span class="line">      <span class="string">"The binders'(<span class="subst">$&#123;binders.contentToString()&#125;</span>) you registered do not contain this <span class="subst">$&#123;indexedClass.name&#125;</span>."</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第6行代码，<strong>index</strong> 函数调用了 <code>JavaClassLinker</code> 对象的 <strong>index</strong> 函数。<code>JavaClassLinker</code> 对象是在注册过程中经 <strong>withJavaClassLinker</strong> 函数转化而来的，此函数将调用方传入的 <code>KotlinClassLinker</code>类型的对象转换为<code>JavaClassLinker</code>类型的对象，我们在 <strong>3.2</strong> 中已做过<a href="#withKotlinClassLinker">分析</a>，此处不再展开。转换前的 <strong>kotlinClassLinker</strong> 如下所示，根据传入的参数 <strong>data</strong> 的成员变量 <strong>type</strong> 来决定返回的<code>ItemViewBinder</code>的类型。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">withKotlinClassLinker(<span class="keyword">object</span> :KotlinClassLinker&lt;Data&gt;&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">index</span><span class="params">(position: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Data</span>)</span></span>: KClass&lt;<span class="keyword">out</span> ItemViewBinder&lt;Data, *&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">when</span> (<span class="keyword">data</span>.type) &#123;</span><br><span class="line">      Data.TYPE_2 -&gt; DataType2ViewBinder::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">      <span class="keyword">else</span> -&gt; DataType1ViewBinder::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p> one2many sample 中这样处理是有意演示 KotlinClass 的使用方式，平时用的话可以直接条用 withJavaClassLinker 来省略这一步的转换。</p>
</blockquote>
<p>回到 <code>ClassLinkerBridge</code> 的 <a href="#ClassLinkerBridge_index"><strong>index</strong> 函数</a>，第6行代码得到了当前 <strong>Item</strong> 所对应的具体的<code>Class&lt;ItemViewBinder&gt;</code>对象。第7-11行代码，得到该 <strong>class</strong> 对象在属性 <strong>binders</strong> 数组中的首次出现的索引值，然后将其返回调用方。</p>
<p>再回头看 <code>MultiTypeAdapter</code>中 <a href="#indexInTypesOf"><strong>indexInTypesOf</strong>函数</a>的实现。第9行代码，<u><strong>将这个 item 在 Types 中首次出现的索引值与它在 linker 的 binders 列表中的索引值相加，作为<code>getItemViewType</code>函数的返回值。</strong></u></p>
<p>接下来是我们之前分析过的 <code>onCreateViewHolder</code>，这次我们主要看第3行代码，根据 <strong>getItemViewType</strong> 获取的 indexViewType ，得到其对应的 ItemViewBinder。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, indexViewType: <span class="type">Int</span>)</span></span>: ViewHolder &#123;</span><br><span class="line">  <span class="keyword">val</span> inflater = LayoutInflater.from(parent.context)</span><br><span class="line">  <span class="keyword">val</span> binder = types.getType&lt;Any&gt;(indexViewType).binder</span><br><span class="line">  <span class="keyword">return</span> binder.onCreateViewHolder(inflater, parent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-小结"><a href="#3-3-小结" class="headerlink" title="3.3 小结"></a>3.3 小结</h4><p>之前说到 MultiType 中索引值的设计非常巧妙，在了解了一对多的注册、使用后，再来探索下这个巧妙之处。 one2many 的 sample 的注册过程中，在 <code>MutableTypes</code> 中注册了多个 <code>Type</code>对象，注册后 <strong>types:List&lt;Type&gt;</strong>的数据如下</p>
<table>
<thead>
<tr>
<th>index</th>
<th>Class</th>
<th>ItemViewBinder</th>
<th>Linker</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>Data</td>
<td>DataType1ViewBinder</td>
<td>ClassLinkerBridge</td>
</tr>
<tr>
<td>1</td>
<td>Data</td>
<td>DataType2ViewBinder</td>
<td>ClassLinkerBridge</td>
</tr>
</tbody></table>
<p><strong>getItemViewType</strong> 中返回的索引值是当前位置的 Item 对应的 <code>Type</code> 在<code>MutableTypes</code>的属性 <strong>types</strong> 列表中首次出现的索引值 <u><strong>index</strong></u> 与 这个索引值所对应的 <code>Type</code> 对象的 <strong>linker</strong> 属性的  <strong>index</strong> 函数的返回值 <u><strong>indexFromLinker</strong></u> 的和。</p>
<blockquote>
<p>例1：<code>Data</code> 对应的 <code>Type</code>在 <strong>types</strong>中首次出现的索引值为 0，当<code>Data</code>对象的<strong>type</strong>属性为 <strong>TYPE_1</strong> 时，indexFromLinker 的值为 0，此时 <strong>getItemViewType</strong> 的返回值是 0。</p>
</blockquote>
<p><strong>onCreateViewHolder</strong> 函数的参数 <strong>indexViewType</strong> 即为上一步得到 <u>index</u> 与 <u>indexFromLinker</u> 和，此函数内调用 <code>MutbaleTypes</code> 类型属性 <strong>types</strong> 的 <strong>getType</strong> 函数，将上一步得到的和作为 <strong>getType</strong> 的参数传递过去得到 <code>Type</code>对象，然后通过得到了这个<code>Type</code>对象的 <strong>binder</strong>属性。这个 <strong>binder</strong> 刚好和上一步中 <code>ClassLinkerBridge</code> 的 <strong>index</strong> 函数中 javaClassLinker.index 所对应的 <code>ItemViewBinder</code>一致。</p>
<blockquote>
<p> 例2：传入的 <strong>indexViewType</strong> 值为 0，因此 <strong>types.getType(indexViewType)</strong>得到的<code>Type</code> 的即为表格中第一行的数据，它的 <strong>binder</strong> 属性即为 DataType1ViewBinder ，与例1中 <code>Data</code> 对象的 <strong>type</strong> 属性相匹配。</p>
</blockquote>
<h2 id="技术点拾遗"><a href="#技术点拾遗" class="headerlink" title="技术点拾遗"></a>技术点拾遗</h2><ol>
<li><p>MultiTypeAdapter 中重写了 <code>fun onBindViewHolder(VH holder, int position, List&lt;Object&gt; payloads)</code> 函数，此函数对 ViewHolder 的 <strong>部分数据更新</strong> 进行了优化。具体表现是当 <strong>payloads</strong> 列表不为空时，仅更新 <strong>payloads</strong> 内的部分数据，减轻渲染压力达到优化效果。</p>
</li>
<li><p>若要在 kotlin 泛型函数中使用泛型 <code>T</code> 的 Class 信息，需在 <code>T</code> 之前增加 <code>reified</code> 关键字，同时在函数前增加 <code>inline</code> 关键字，如下所示</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T : Any&gt;</span> <span class="title">register</span><span class="params">(binder: <span class="type">ItemViewBinder</span>&lt;<span class="type">T</span>, *&gt;)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 函数内部使用 T 的 class 信息</span></span><br><span class="line">  register(T::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>, <span class="type">binder)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>kotlin 的构造函数自带的重载效果仅限 kotlin 模块可用，若要在 Java 模块中使用 kotlin 构造函数的重载函数，可在构造函数前添加<code>@JvmOverloads</code>注解，如下所示。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//class Demo(val param1:String,val param2:Int) 这种方式仅可在 kotlin 模块调用重载构造函数</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123; </span><br><span class="line">  <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span>(<span class="keyword">val</span> param1:String, <span class="keyword">val</span> param2:<span class="built_in">Int</span>) </span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(<span class="keyword">val</span> param1:String, <span class="keyword">val</span> param2:<span class="built_in">Int</span>)&#123;&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>kotlin 中的泛型没有表示不确定类型的符号 <code>?</code>，但有称为 <span class="exturl" data-url="aHR0cHM6Ly9rb3RsaW5sYW5nLm9yZy9kb2NzL3JlZmVyZW5jZS9nZW5lcmljcy5odG1sI3N0YXItcHJvamVjdGlvbnM=" title="https://kotlinlang.org/docs/reference/generics.html#star-projections">Star-projections<i class="fa fa-external-link"></i></span> 的符号 <code>*</code> ，直译过来为星形投影。它是更为安全及严格的泛型限定符，编译器会将 <code>&lt;*&gt;</code> 视为 <code>&lt;out Any&gt;</code>，其中的 <code>out</code> 表示该类型<strong>只能</strong>作为函数的返回值类型使用，若将其作为函数的入参使用，编译器会直接报错。具体规则如下：</p>
<ul>
<li><code>Function&lt;*&gt;</code>表示 <code>Function&lt;in Nothing&gt;</code>和 <code>Function&lt;out Any?&gt;</code></li>
<li><code>Function&lt;*, String&gt;</code> 表示 <code>Function&lt;in Nothing, String&gt;</code>;</li>
<li><code>Function&lt;Int, *&gt;</code> 表示 <code>Function&lt;Int, out Any?&gt;</code>;</li>
<li><code>Function&lt;*, *&gt;</code> 表示 <code>Function&lt;in Nothing, out Any?&gt;</code>.</li>
</ul>
</li>
</ol>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.27/webfontloader.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script><textarea id="sequence-0-code" style="display: none">title: MultiTypeAdapter register 工作流程
Client->MultiTypeAdapter: 1. register(ItemViewBinder<T,*>)
MultiTypeAdapter->MultiTypeAdapter: 2. register(Class<T>,ItemViewBinder<T,*>)
MultiTypeAdapter->MultiTypeAdapter: 3. register(Type<T>)
MultiTypeAdapter->MutableTypes: 4. register(Type<T>)</textarea><textarea id="sequence-0-options" style="display: none">{"theme":"simple"}</textarea><script>  var code = document.getElementById("sequence-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("sequence-0-options").value));  var diagram = Diagram.parse(code);  diagram.drawSVG("sequence-0", options);</script><textarea id="sequence-1-code" style="display: none">MultiTypeAdapter->MultiTypeAdapter: 1.indexInTypesOf
MultiTypeAdapter->MutableTypes: 2.firstIndexOf
MutableTypes-->MultiTypeAdapter: index
MultiTypeAdapter->MutableTypes: 3.getType
MutableTypes->MutableTypes: getLinker
MutableTypes-->MultiTypeAdapter: linker</textarea><textarea id="sequence-1-options" style="display: none">{"theme":"simple"}</textarea><script>  var code = document.getElementById("sequence-1-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("sequence-1-options").value));  var diagram = Diagram.parse(code);  diagram.drawSVG("sequence-1", options);</script><textarea id="sequence-2-code" style="display: none">MultiTypeAdapter->LayoutInflater: 1. from
LayoutInflater-->MultiTypeAdapter: inflater
MultiTypeAdapter->MutableTypes: 2. getType
MutableTypes->MutableTypes: 3. getBinder
MutableTypes-->MultiTypeAdapter: binder
MultiTypeAdapter->ItemViewBinder:4. onCreateViewBinder</textarea><textarea id="sequence-2-options" style="display: none">{"theme":"simple"}</textarea><script>  var code = document.getElementById("sequence-2-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("sequence-2-options").value));  var diagram = Diagram.parse(code);  diagram.drawSVG("sequence-2", options);</script><textarea id="sequence-3-code" style="display: none">MultiTypeAdapter->MultiTypeAdapter: 1. onBindViewHolder
MultiTypeAdapter->MultiTypeAdapter: 2. onBindViewHolder
MultiTypeAdapter->MultiTypeAdapter: 3. getOutBinderByViewHolder
MultiTypeAdapter->MutableTypes: 4. getType
MutableTypes-->MultiTypeAdapter: type
MultiTypeAdapter->Type: 5.getBinder
Type-->MultiTypeAdapter : binder
MultiTypeAdapter->ItemViewBinder: 6. onBindViewHolder</textarea><textarea id="sequence-3-options" style="display: none">{"theme":"simple"}</textarea><script>  var code = document.getElementById("sequence-3-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("sequence-3-options").value));  var diagram = Diagram.parse(code);  diagram.drawSVG("sequence-3", options);</script><textarea id="sequence-4-code" style="display: none">Client->MultiTypeAdapter: 1. register
MultiTypeAdapter->MultiTypeAdapter: 2. register
MultiTypeAdapter-->Client: oneToManyBuilder
Client->OneToManyBuilder: 3. to
Client->OneToManyBuilder: 4. withKotlinClassLinker
OneToManyBuilder->OneToManyEndpoint: 5. withKotlinClassLinker
OneToManyEndpoint->OneToManyEndpoint: 6. withJavaClassLinker
OneToManyEndpoint->OneToManyBuilder: 7. withJavaClassLinker
OneToManyBuilder->ClassLinkerBridge: 8.toLinker
ClassLinkerBridge-->OneToManyBuilder: linkerBridge
OneToManyBuilder->OneToManyBuilder: 9. withLinker
OneToManyBuilder->OneToManyBuilder: 10. doRegister
note left of OneToManyBuilder: loop: binders
OneToManyBuilder->MultiTypeAdapter: 11. register</textarea><textarea id="sequence-4-options" style="display: none">{"theme":"simple"}</textarea><script>  var code = document.getElementById("sequence-4-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("sequence-4-options").value));  var diagram = Diagram.parse(code);  diagram.drawSVG("sequence-4", options);</script><textarea id="sequence-5-code" style="display: none">Client->MultiTypeAdpter: 1. getItemViewType
MultiTypeAdpter->MultiTypeAdpter: 2. indexInTypesOf
MultiTypeAdpter->MutableTypes: 3. firstIndexOf
MutableTypes-->MultiTypeAdpter: firstIndex
MultiTypeAdpter->MutableTypes: 4. getType
MutableTypes->MutableTypes: getLinker
MutableTypes-->MultiTypeAdpter: linker
MultiTypeAdpter->ClassLinkerBridge: 5. index
ClassLinkerBridge-->MultiTypeAdpter: linker.index
MultiTypeAdpter-->Client: firstIndex + linker.index</textarea><textarea id="sequence-5-options" style="display: none">{"theme":"simple"}</textarea><script>  var code = document.getElementById("sequence-5-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("sequence-5-options").value));  var diagram = Diagram.parse(code);  diagram.drawSVG("sequence-5", options);</script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2019/06/23/how-to-reading-AOSP-with-Android-Studio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/23/how-to-reading-AOSP-with-Android-Studio/" class="post-title-link" itemprop="url">使用 Android Studio 阅读 AOSP 源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-23 01:13:33" itemprop="dateCreated datePublished" datetime="2019-06-23T01:13:33+08:00">2019-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android-9-%E7%B3%BB%E7%BB%9F%E6%BA%90%E4%BB%A3%E7%A0%81%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">Android 9 系统源代码情景分析</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/06/23/how-to-reading-AOSP-with-Android-Studio/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/06/23/how-to-reading-AOSP-with-Android-Studio/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://geek5nan.github.io/2019/06/10/build-android-pie-in-macOS-Mojave/">上一篇文章</a>介绍了 AOSP 9 在 macOS 10.14 环境下的编译方式，本文就 Andorid Studio 环境下阅读 AOSP 源码的方式进行记录。</p>
<h2 id="阅读前-AOSP-的准备"><a href="#阅读前-AOSP-的准备" class="headerlink" title="阅读前 AOSP 的准备"></a>阅读前 AOSP 的准备</h2><p>开始之前我们先为 AOSP 生成 IDEA 工程文件，便于稍后在 Android Studio 中载入。</p>
<h3 id="1-为-AOSP-生成-Android-Studio-工程配置文件"><a href="#1-为-AOSP-生成-Android-Studio-工程配置文件" class="headerlink" title="1. 为 AOSP 生成 Android Studio 工程配置文件"></a>1. 为 AOSP 生成 Android Studio 工程配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Volumes/AOSP</span><br><span class="line"><span class="comment"># 设置 AOSP 编译所需的环境变量</span></span><br><span class="line"><span class="built_in">source</span> build/envsetup.sh</span><br><span class="line"><span class="comment"># 使用 idegen.sh 脚本生成 IDEA 工程文件</span></span><br><span class="line">development/tools/idegen/idegen.sh</span><br><span class="line">-------------------------------</span><br><span class="line">Read excludes: 4ms</span><br><span class="line">Traversed tree: 68826ms</span><br></pre></td></tr></table></figure>

<p>稍等片刻，即可在 AOSP 目录下看到生成的 <code>android.iml</code> 和 <code>android.ipr</code>，其中 <strong>iml 文件</strong> 表示 information of modules, 用来描述 AOSP 的模块信息。<strong>ipr 文件</strong> 表示 IDEA project configuration ，用来描述 IDEA 的工程配置信息，双击此文件时系统将直接使用 Andorid Studio 打开此项目。</p>
<p><img src="/uploads/aosp2-1.png" alt=""></p>
<h3 id="2-导入-Android-Studio"><a href="#2-导入-Android-Studio" class="headerlink" title="2. 导入 Android Studio"></a>2. 导入 Android Studio</h3><ol>
<li>点击 <strong>Open an existring Android Studio project</strong> </li>
</ol>
<p><img src="/uploads/aosp2-2.png" alt=""></p>
<ol start="2">
<li>选中 AOSP 根目录</li>
</ol>
<p><img src="/uploads/aosp2-3.png" alt=""></p>
<p>使用 Android Studio 打开 AOSP 项目时会先对项目源码建立索引，此步骤比较耗时，笔者所用的4核心8线程的CPU建立索引大概需要8-10分钟，读者可趁此机会起身活动片刻。</p>
<h3 id="3-修改-Android-Studio-VM参数，优化源码阅读体验"><a href="#3-修改-Android-Studio-VM参数，优化源码阅读体验" class="headerlink" title="3. 修改 Android Studio VM参数，优化源码阅读体验"></a>3. 修改 Android Studio VM参数，优化源码阅读体验</h3><p>AOSP 源码文件较多，Android Studio 默认设置的 1280m 堆最大内存对于 AOSP 这样的大型项目已不再合适，为了更好的性能，我们可以通过如下方式来增大 Android Studio 的堆最大内存。</p>
<p><img src="/uploads/aosp2-4.png" alt=""></p>
<ol>
<li><p>点击 <strong>Help</strong> &gt; <strong>Edit Custom VM Options</strong> 以打开您的 <code>studio.vmoptions</code> 文件。</p>
</li>
<li><p>向 <code>studio.vmoptions</code> 文件添加一个行，使用语法 <strong>-Xmx<span style="color: blue">HeapSize</span></strong> 设置最大堆内存。如图所示，笔者将Android Studio 的堆最大内存空间设置为 6G。</p>
</li>
<li><p>保存对 <code>studio.vmoptions</code> 文件所做的更改，然后重新启动 Android Studio 以使更改生效。</p>
</li>
</ol>
<h3 id="4-修改-Android-Studio-文件系统大小写敏感项"><a href="#4-修改-Android-Studio-文件系统大小写敏感项" class="headerlink" title="4. 修改 Android Studio 文件系统大小写敏感项"></a>4. 修改 Android Studio 文件系统大小写敏感项</h3><p>AOSP 首次导入 Android Studio后，会出现下图所示的气泡弹窗，表示AOSP项目的文件系统大小写敏感度与 Android Studio 默认设置的文件系统大小写敏感度不匹配。</p>
<p><img src="/uploads/aosp2-5.png" alt=""></p>
<p>为了更好的阅读体验，我们可以采用如下方式修改 Android Studio 的文件系统大小写敏感度。</p>
<p><img src="/uploads/aosp2-6.png" alt=""></p>
<ol>
<li>点击 <strong>Help</strong> &gt; <strong>Edit Custom Properties</strong>。如果您之前从未编辑过 IDE 属性，Android Studio 将提示您新建一个 <code>idea.properties</code> 文件。点击 <strong>Yes</strong> 创建文件。</li>
<li>此时 <code>idea.properties</code> 文件将在 Android Studio 的编辑器窗口中打开。</li>
<li>编辑<code>idea.properties</code>文件，添加自定义属性<code>idea.case.sensitive.fs=true</code> 。</li>
<li>保存对 <code>idea.properties</code> 文件所做的更改，然后重新启动 Android Studio 以使更改生效。</li>
</ol>
<h3 id="5-修改-AOSP-工程配置"><a href="#5-修改-AOSP-工程配置" class="headerlink" title="5. 修改 AOSP 工程配置"></a>5. 修改 AOSP 工程配置</h3><p><strong>1.清空 Android Studio 中关联的 JDK 与 SDK</strong></p>
<p>我们首次安装 Android Studio 时，通常会为其配置默认的 JDK 和 SDK，而 AOSP 项目中也包含 Android SDK 与 Java JDK 的源码，但在未清空 Android Studio 的默认 JDK 与 SDK 之前，Android Studio 会优先加载其默认的 JDK 与 SDK 而非 AOSP 中包含的，我们可以采用如下方式清空默认的 JDK 与 SDK 。</p>
<ol>
<li>点击 <strong>File</strong> &gt; <strong>Project Structure.. *<em>，也可使用快捷键 *</em>⌘</strong> + <strong>;</strong> </li>
<li>选中<strong>Platform Setting</strong> &gt; <strong>SDK</strong>，然后选中所有的 SDK，最后点击上方的移除按钮 <strong>➖</strong></li>
</ol>
<p><img src="/uploads/aosp2-8.png" alt=""></p>
<ol start="3">
<li><p>点击上方的添加按钮 ➕，添加 JDK </p>
</li>
<li><p>将新增的JDK更名为 Empty JDK </p>
</li>
<li><p>使用下方的移除按钮➖，依次清空 Empty JDK 下方标签栏中 <strong>Classpath</strong> 与 <strong>Sourcepath</strong>下的所有依赖项</p>
</li>
</ol>
<p><img src="/uploads/aosp2-9.png" alt=""></p>
<ol start="6">
<li>点击右下方的 <strong>Apply</strong> 按钮保存更改，然后进行下一步操作。</li>
</ol>
<p><strong>2.移除 AOSP 内的多余依赖项</strong></p>
<ol>
<li>点击 <strong>Project Settings</strong> &gt; <strong>Modules</strong>，选中 android 模块，将其 Module SDK 设置为我们上一步创建的 <strong>Empty JDK</strong></li>
<li>移除 Export 中除 <strong>Module source</strong> 、 <strong>Empty JDK</strong> 以外的所有条目，如下图所示。</li>
</ol>
<p><img src="/uploads/aosp2-10.png" alt=""></p>
<ol start="3">
<li>点击右下方的 <strong>OK</strong> 按钮保存修改。</li>
</ol>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>经过以上操作，代码中的红色错误全部消失，代码间也能够进行任意跳转（除 native 代码外），总算可以舒畅的阅读 AOSP 了。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ol>
<li><strong>import 部分出现大量的红色错误，代码内无法跳转，提示 Cannot find declaration to go to</strong> 。参考<a href="https://geek5nan.github.io/2019/06/10/build-android-pie-in-macOS-Mojave/">上一篇文章</a>，重新编译 AOSP 解决。</li>
<li><strong>项目索引时间太长，或代码跳转太慢</strong> 。 AOSP 项目模块非常多，文件数量也非常大，Android Studio 每次打开 AOSP 时都需要为 AOSP 项目内的海量文件建立索引，跳转时也需要在海量文件中进行检索，慢是必然的。为此，我们可以修改 AOSP 的工程模块描述文件 <strong>android.iml</strong>，排除一些不关心的模块，以此来提高索引建立与检索时速度。</li>
</ol>
<p>AOSP  的工程模块描述文件 <code>/Volumes/AOSP/android.iml</code> 内容如下。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;module relativePaths="true" type="JAVA_MODULE" version="4"&gt;</span><br><span class="line">......</span><br><span class="line">  &lt;component name="NewModuleRootManager" inherit-compiler-output="true"&gt;</span><br><span class="line">    &lt;exclude-output /&gt;</span><br><span class="line">    &lt;content url="file://$MODULE_DIR$"&gt;</span><br><span class="line">......</span><br><span class="line"><span class="addition">+      &lt;sourceFolder url="file://$MODULE_DIR$/frameworks/base/core/java" type="kotlin-source" /&gt;</span></span><br><span class="line"><span class="addition">+      &lt;sourceFolder url="file://$MODULE_DIR$/frameworks/base/core/tests/benchmarks/src" type="kotlin-test" /&gt;</span></span><br><span class="line"><span class="deletion">-      &lt;excludeFolder url="file://$MODULE_DIR$/.repo" /&gt;</span></span><br><span class="line">......</span><br><span class="line">    &lt;/content&gt;</span><br><span class="line">  &lt;/component&gt;</span><br><span class="line">&lt;/module&gt;</span><br></pre></td></tr></table></figure>

<p>​    其中，绿色的 <span style="color:green">sourceFolder</span> 表示已导入的模块，红色的 <span style='color:red'>excludeFolder</span> 表示需要从项目中排除的模块。我们可仅保留部分感兴趣的模块，将其他不感兴趣的模块的 xml 标签由 <span style="color:green">sourceFolder</span>  修改为 <span style="color:red">excludeFolder</span>  ，这样一来项目索引和检索的速度便会快很多。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2019/06/10/build-android-pie-in-macOS-Mojave/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/10/build-android-pie-in-macOS-Mojave/" class="post-title-link" itemprop="url">使用 macOS 10.14 编译 Android 9.0</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-10 23:15:01" itemprop="dateCreated datePublished" datetime="2019-06-10T23:15:01+08:00">2019-06-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android-9-%E7%B3%BB%E7%BB%9F%E6%BA%90%E4%BB%A3%E7%A0%81%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">Android 9 系统源代码情景分析</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/06/10/build-android-pie-in-macOS-Mojave/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/06/10/build-android-pie-in-macOS-Mojave/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>随着移动端设备增量的放缓和市场上各行各业 App 的饱和，连笔者的手机都很久未安装过新 App，更不用提更换手机的频率。与此同时，移动开发也由上半场拼点子拼速度的快捷玩法，进入到下半场拼质量拼生态的高阶玩法。作为一名一线开发人员，大环境的走向与业务形态的发展虽由不得我们控制，但核心技术的掌握则是我们可以身体力行的( 笑~)。</p>
<p>AOSP 是 Android 系统的代码，囊括了 Andorid 系统的全部内容，从应用开发 Framework 层到 Android 虚拟机 ART/Dalvik 层再到 Linux 内核层，所有的疑惑都能在源码中找到答案，其源码的重要性不言而喻。本文作为系列的开篇，主要对 AOSP 的下载、编译过程进行阐述，同时记录下过程中遇到的问题及解决方案。</p>
<p>笔者的系统版本为 macOS 10.14.5，截止文章发布时仍是最新的操作系统，AOSP-android-9.0.0_r42 的源码加编译产物需要 200G 的磁盘空间，请提前预留好磁盘空间。若主机磁盘空间不足，可使用外置移动硬盘来解决。</p>
<p><img src="/uploads/aosp1-1.png" alt="编译后将近 200G "></p>
<h2 id="1-Xcode-的安装"><a href="#1-Xcode-的安装" class="headerlink" title="1. Xcode 的安装"></a>1. Xcode 的安装</h2><p>Xcode 包含了编译过程所需的各种工具，如 git、clang、make 等，在编译之前，我们先处理好 Xcode 相关的问题。</p>
<p>截止到2019年6月，<span style='color:red'>AOSP 仍不支持使用 Xcode 10 编译</span>。虽可在 AOSP 配置文件增加 10.14 字段绕过该限制，但后续编译时仍会出现莫名其妙的错误。因此，建议直接使用 Xcode9.4 来避免此类问题。Xcode9.4 的下载地址为<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2Rvd25sb2FkL21vcmUvPz14Y29kZQ==" title="https://developer.apple.com/download/more/?=xcode">Apple Developer Download<i class="fa fa-external-link"></i></span>，登录苹果账号后选中 Xcode 9.4 条目即可看到下载按钮。</p>
<p>若之前已安装 Xcode10 或更高版本，建议在 Xcode9.4 下载成功后进行以下操作：</p>
<ol>
<li>将原有 Xcode.app 更名为 Xcode10.app 或其他</li>
<li>解压缩 Xcode 9.4 对应的 Xcode.xip 文件，随后将解压缩出的 Xcode.app 移动至 /Applications 目录</li>
</ol>
<p>Xcode 9.4 安装后，在终端内输入 <code>clang -version</code> 进行验证，若出现如下输入内容，则表示 Xcode 9.4 切换成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Apple LLVM version 9.1.0 (clang-902.0.39.2)</span><br><span class="line">Target: x86_64-apple-darwin18.6.0</span><br><span class="line">Thread model: posix</span><br><span class="line">InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin</span><br></pre></td></tr></table></figure>

<h2 id="2-macOS-大小写敏感磁盘的创建"><a href="#2-macOS-大小写敏感磁盘的创建" class="headerlink" title="2. macOS 大小写敏感磁盘的创建"></a>2. macOS 大小写敏感磁盘的创建</h2><p> macOS 文件系统的默认类型是大小写不敏感，大部分人的 macOS 文件系统类型均为大小写不敏感，然而 AOSP 项目中的代码却对大小写敏感。因此在下载 AOSP 源码之前，需要先创建一个大小写敏感的磁盘区域，创建命令如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdiutil create -<span class="built_in">type</span> SPARSE -fs <span class="string">'Case-sensitive Journaled HFS+'</span> -size 200g -volname AOSP /PathTo/AOSP.dmg.sparseimage</span><br></pre></td></tr></table></figure>

<p>其中，<code>-size 200g</code> 表示新建磁盘空间的最大容量为200g，<code>-volname AOSP</code> 表示磁盘挂载时的名称为 AOSP，<code>/PathTo/AOSP.dmg.sparseimage</code> 是新建磁盘空间文件的存放位置。磁盘空间创建后并不会立即占用200g，而是随着该磁盘空间内数据存储的增多而扩大。当磁盘空间不足时，可在磁盘未挂载的状态下采用如下命令对原有磁盘空间进行扩容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdiutil resize -size 220g /PathTo/AOSP.dmg.sparseimage</span><br></pre></td></tr></table></figure>

<p>为了方便后续的使用，建议在终端环境下增加挂载与卸载 AOSP 磁盘空间的指令。所需函数如下，将其添加到 <code>.zshrc</code> 或 <code>.bashrc</code> 即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载 AOSP 磁盘空间</span></span><br><span class="line"><span class="function"><span class="title">mountAndroid</span></span>() &#123; hdiutil attach /PathTo/AOSP.dmg.sparseimage -mountpoint /Volumes/AOSP; &#125;</span><br><span class="line"><span class="comment"># 卸载 AOSP 磁盘空间</span></span><br><span class="line"><span class="function"><span class="title">umountAndroid</span></span>() &#123; hdiutil detach /Volumes/AOSP; &#125;</span><br></pre></td></tr></table></figure>

<p>添加成功后，在终端内输入 <code>mountAndroid</code> 或 <code>umountAndroid</code> 即可快速挂载和卸载 AOSP 磁盘空间。</p>
<h2 id="3-AOSP-源码下载"><a href="#3-AOSP-源码下载" class="headerlink" title="3. AOSP 源码下载"></a>3. AOSP 源码下载</h2><p>最新的 AOSP 的源码约35G，数据量较大，建议从国内镜像获取，本小节使用<span class="exturl" data-url="aHR0cHM6Ly9sdWcudXN0Yy5lZHUuY24vd2lraS9taXJyb3JzL2hlbHAvYW9zcA==" title="https://lug.ustc.edu.cn/wiki/mirrors/help/aosp">科大镜像源<i class="fa fa-external-link"></i></span>演示下载流程。</p>
<h3 id="3-1-安装-repo"><a href="#3-1-安装-repo" class="headerlink" title="3.1 安装 repo"></a>3.1 安装 repo</h3><p>最新的 AOSP 项目下含有 700+ 个git仓库，若用 git-submodule，git-subtree 管理的话非常复杂，为此谷歌专门编写了 repo 工具，用来管理多个 git 仓库间的代码同步。<br><strong>0. 在当前用户目录下创建 bin 目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~&#x2F;bin</span><br></pre></td></tr></table></figure>

<p><strong>1. 下载 repo 到当前用户下的 bin 目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL  &#39;https:&#x2F;&#x2F;gerrit-googlesource.proxy.ustclug.org&#x2F;git-repo&#x2F;+&#x2F;master&#x2F;repo?format&#x3D;TEXT&#39; |base64 -d &gt; ~&#x2F;bin&#x2F;repo</span><br></pre></td></tr></table></figure>

<p><strong>2. 为 repo 赋予可执行权限</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x ~&#x2F;bin&#x2F;repo</span><br></pre></td></tr></table></figure>

<p><strong>3. 将 bin 目录注册到终端环境</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># zsh</span><br><span class="line">echo &#39;export PATH&#x3D;~&#x2F;bin:$PATH&#39;&gt;&gt;~&#x2F;.zshrc</span><br></pre></td></tr></table></figure>

<h3 id="3-2-下载-AOSP-源码"><a href="#3-2-下载-AOSP-源码" class="headerlink" title="3.2 下载 AOSP 源码"></a>3.2 下载 AOSP 源码</h3><p><strong>0. 初始化 AOSP 仓库清单</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载 AOSP 磁盘空间</span></span><br><span class="line">mountAndroid</span><br><span class="line"><span class="comment"># 进入 AOSP 磁盘空间</span></span><br><span class="line"><span class="built_in">cd</span> /Volumes/AOSP</span><br><span class="line"><span class="comment"># 初始化 AOSP 仓库清单</span></span><br><span class="line">repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-9.0.0_r42</span><br></pre></td></tr></table></figure>

<blockquote>
<p>首次使用 git ，需按提示填写 git.username 与 git.email 信息</p>
</blockquote>
<p>执行以上命令，会将<span class="exturl" data-url="Z2l0Oi8vbWlycm9ycy51c3RjLmVkdS5jbi9hb3NwL3BsYXRmb3JtL21hbmlmZXN0" title="git://mirrors.ustc.edu.cn/aosp/platform/manifest">AOSP清单仓库<i class="fa fa-external-link"></i></span>拉取到<code>/Volumes/AOSP/.repo</code>目录下，其中的 <code>manifest.xml</code>是一个软链接，链接到<code>/Volumes/AOSP/.repo/manifests/default.xml</code> 文件，文件中存储的即为 <code>AOSP</code>当前分支下所有仓库的清单文件。</p>
<p><img src="/uploads/aosp1-2.png" alt=""></p>
<p><code>/Volumes/AOSP/manifest.xml</code>清单文件内容</p>
<p><img src="/uploads/aosp1-3.png" alt="清单文件内容"></p>
<p>清单中列出了 AOSP 当前分支所需的全部仓库，仓库以 <strong>project</strong> 条目的形式描述，其中 <strong>path</strong> 属性表示下载到本地后的文件目录，<strong>name</strong> 属性表示远程仓库的相对路径。</p>
<p><img src="/uploads/aosp1-4.png" alt="Manifest.git_config"></p>
<p><code>/Volumes/AOSP/.repo/manifests/.git/config</code>是一个指向<code>/Volumes/AOSP/.repo/manifests.git/config</code>文件的软链接，config 文件记录了 AOSP 清单仓库的基本信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;Volumes&#x2F;AOSP&#x2F;.repo&#x2F;manifests&#x2F;.git&#x2F;config</span><br><span class="line">[core]</span><br><span class="line">    repositoryformatversion &#x3D; 0</span><br><span class="line">    filemode &#x3D; true</span><br><span class="line">    precomposeunicode &#x3D; true</span><br><span class="line">[filter &quot;lfs&quot;]</span><br><span class="line">    smudge &#x3D; git-lfs smudge --skip -- %f</span><br><span class="line">    process &#x3D; git-lfs filter-process --skip</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">    url &#x3D; git:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;aosp&#x2F;platform&#x2F;manifest</span><br><span class="line">    fetch &#x3D; +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*</span><br><span class="line">[branch &quot;default&quot;]</span><br><span class="line">    remote &#x3D; origin</span><br><span class="line">    merge &#x3D; refs&#x2F;heads&#x2F;android-9.0.0_r42</span><br></pre></td></tr></table></figure>



<p><strong>1. 下载 AOSP 代码</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<p>执行此操作时，repo 先解析上一步得到的<strong>manifest.xml</strong>来获取仓库信息，然后对清单中的所有仓库依次执行类似 <strong>git clone (git://mirrors.ustc.edu.cn/aosp + $project.name) $project.path</strong> 类似的操作将 AOSP 源码同步到本地。</p>
<p>clone 过程又可分为 <strong>Fetching projects</strong>（下载 bare 仓库）与 <strong>Syncing work tree</strong>（解压到工作目录）两个阶段。</p>
<p><strong>Fetching projects</strong> 阶段会将 AOSP 中的700+个仓库陆续拉取到本地，内容暂存在 /Volumes/AOSP/.repo/projects 与 /Volumes/AOSP/.repo/project-objects 目录下的 bare 仓库内，此阶段大约需要下载 35G 的数据。下载过程中在 /Volumes/AOSP 目录内看不到明显变化，可使用磁盘命令<code>du -h -d 1</code>来查看下载进度。</p>
<p><strong>Syncing work tree</strong>阶段会将 /Volumes/AOSP/.repo 下 bare 仓库的内容逐个取出，并放置到 /Volumes/AOSP 目录中，解压所需的空间也在35G左右。此阶段同样可以使用<code>du -h -d 1</code>来查看解压进度。</p>
<h2 id="4-编译-AOSP"><a href="#4-编译-AOSP" class="headerlink" title="4. 编译 AOSP"></a>4. 编译 AOSP</h2><p><strong>0. 加载编译环境变量</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Volumes/AOSP</span><br><span class="line"><span class="comment"># 设置 AOSP 编译所需的环境变量</span></span><br><span class="line"><span class="built_in">source</span> build/envsetup.sh</span><br></pre></td></tr></table></figure>

<p><strong>1. 设置编译对象</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置编译对象</span></span><br><span class="line">lunch aosp_x86_64-eng</span><br></pre></td></tr></table></figure>

<p>此处是将 aosp 编译为 x86 架构的 64 位版本，如需编译其他版本，可键入 <code>lunch</code> 后在列表中选择。<br><strong>2. 开始编译</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m -j16</span><br></pre></td></tr></table></figure>

<p><code>-j16</code> 表示开启16个作业来同时编译，此处的数字与 CPU 相关，一般可设置为 CPU 核心数量的 2-4 倍。</p>
<p>接下来便耐心等待，编译成功后会出现如下提示，笔者所使用的4核8线程处理器，完整编译一次大约需要三个半小时。编译产物最终存储在 /Volemes/ASOP/out 目录，大约105G。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Setting name!</span><br><span class="line">partNum is 0</span><br><span class="line">REALLY setting name!</span><br><span class="line">Warning: The kernel may <span class="built_in">continue</span> to use old or deleted partitions.</span><br><span class="line">You should reboot or remove the drive.</span><br><span class="line">The operation has completed successfully.</span><br><span class="line"></span><br><span class="line"><span class="comment">#### build completed successfully (03:35:23 (hh:mm:ss)) ####</span></span><br></pre></td></tr></table></figure>

<h2 id="5-常见问题"><a href="#5-常见问题" class="headerlink" title="5. 常见问题"></a>5. 常见问题</h2><blockquote>
<ol>
<li>Could not find a supported mac sdk: [“10.10” “10.11” “10.12” “10.13”]</li>
</ol>
</blockquote>
<p>AOSP 暂只支持在 10.10-10.13 上编译，其本质是对 Xcode 编译套件 MacOS.sdk 的限定。若当前 /Application/Xcode 对应的版本为 Xcode 10，则会出现这个错误提示，因为 Xcode10 内置的 MacOS.sdk 为 10.14 。以往虽有魔改 AOSP 编译配置的方式，为其添加 “10.14” 来避免此错误。但因 Xcode10 的改动较大，不建议普通用户尝试魔改 AOSP 编译配置，最稳妥的方式还是参照步骤1中的描述进行操作。</p>
<blockquote>
<ol start="2">
<li>&lt;IOKit/IOReturn.h&gt; not found</li>
</ol>
</blockquote>
<p>与问题1一样，可通过步骤1 更换 Xcode 9.4 为默认 Xcode 解决。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2019/03/19/export-data-of-qiniu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/19/export-data-of-qiniu/" class="post-title-link" itemprop="url">导出七牛云存储的数据</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-19 12:45:38" itemprop="dateCreated datePublished" datetime="2019-03-19T12:45:38+08:00">2019-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A1%AB%E5%9D%91/" itemprop="url" rel="index"><span itemprop="name">填坑</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/03/19/export-data-of-qiniu/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/19/export-data-of-qiniu/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前不久，七牛收回了其测试域名，导致先前创建的外链失效，关联的图片也因此而无法加载。继续使用七牛云的话，需要绑定一个已备案的域名。我没有域名，只能选择将七牛中的数据迁出，本文记录了我的迁出方案，仅供参考。</p>
<h2 id="七牛控制台"><a href="#七牛控制台" class="headerlink" title="七牛控制台"></a>七牛控制台</h2><p>登录七牛控制台，看到之前上传的文件都还在，不由松了一口气。</p>
<p><img src="/uploads/qiniuPortal.png" alt=""></p>
<p>但因七牛提供的测试域名已被收回，这些文件无法直接下载。七牛官方有提供命令行工具 qshell 用来管理七牛云存储中的数据，下面便尝试用 qshell 来取回七牛云存储中的数据。</p>
<h2 id="qshell"><a href="#qshell" class="headerlink" title="qshell"></a>qshell</h2><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><ol>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIucWluaXUuY29tL2tvZG8vdG9vbHMvMTMwMi9xc2hlbGw=" title="https://developer.qiniu.com/kodo/tools/1302/qshell">下载qshell<i class="fa fa-external-link"></i></span></p>
</li>
<li><p>设置七牛密钥,<code>AccessKey</code>与<code>SecretKey</code>可在个人中心查看，<code>username</code>即登录名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./qshell account <span class="variable">$AccessKey</span> <span class="variable">$SecretKey</span> <span class="variable">$username</span></span><br></pre></td></tr></table></figure></li>
<li><p>查看七牛中的所有的存储空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./qshell buckets </span><br><span class="line">bucket1 bucket2</span><br></pre></td></tr></table></figure></li>
<li><p>查看任意bucket下的所有文件,<code>bucket1</code>即存储空间名称，可在第三步获得</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./qshell listbucket bucket1</span><br><span class="line">20180607152835781571470.png	146467	FkomvVSnuHSTqOb5DTP2P-tMfvhu	15283578247522637	image/g&gt; 	0	</span><br><span class="line">20180607152835853736115.png	275169	FjNQ_IsQ2O1uAJ8GUIWnf4EI_ria	15283585599550264	image/g&gt; 	0	</span><br><span class="line">20180607152835873357855.png	301775	Fkf66UnqTOE_2qk9JLaK7CmBYGaz	15283587418650741	image/g&gt; 	0	</span><br><span class="line">20180607152835873635379.png	301775	Fkf66UnqTOE_2qk9JLaK7CmBYGaz	15283587447048077	image/g&gt; 	0	</span><br><span class="line">20180607152835921758924.png	228242	FosahF-yBSb52XpzeEwsWtthYtr-	15283592250769811	image/g&gt; 	0	</span><br><span class="line">20180607152835922424458.png	228242	FosahF-yBSb52XpzeEwsWtthYtr-	15283592317735414	image/g&gt; 	0	</span><br><span class="line">2018060715283595974118.png	274603	Fus9VYf57nyzZl0anfAtyhb9LqUB	15283596050005389	image/g&gt; 	0	</span><br><span class="line">20180607152835959964068.png	274603	Fus9VYf57nyzZl0anfAtyhb9LqUB	15283596074482577	image/g&gt; 	0	</span><br><span class="line">20180607152835995681268.png	336315	FnBe6Y7ZTcOXcagb1jlVFpT9PBDB	15283599638787908	image/g&gt; 	0	</span><br><span class="line">20180607152836010286020.png	163278	FulF_a__HWD_0ozKbWYQkLlUC3ae	15283601099593898	image/g&gt; 	0	</span><br><span class="line">20180607152836024325067.png	174147	FlMb0fDhRvK4ATatZ7nMjALKtM_D	15283602512194601	image/png	0</span><br></pre></td></tr></table></figure></li>
<li><p>下载文件，qshell提供了两个下载子命令，qdownload和get，其中qdownload可以批量下载，但必须绑定域名；get只能下载单个文件，但无需绑定域名</p>
</li>
<li><p>下载单个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./qshell get <span class="variable">$bucketName</span> <span class="variable">$fileName</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载多个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//使用awk命令构造含有多条`qshell get`语句的脚本patchGet.sh</span><br><span class="line">$ ./qshell listbucket <span class="variable">$bukectName</span> | awk <span class="string">'$1="./qshell get $bucketName "$1&#123;print $1&#125;'</span>&gt;patchGet.sh</span><br><span class="line">//为patchGet.sh赋予可执行权限</span><br><span class="line">$ chmod +x patchGet.sh</span><br><span class="line">//执行批量get脚本</span><br><span class="line">$ ./patchGet.sh</span><br></pre></td></tr></table></figure></li>
<li><p>等待脚本执行完成，即可发现bucket1中的文件均已下载到本地<br><img src="/uploads/patchGet.sh.jpg" alt="patchGet.sh"></p>
</li>
</ol>
<p>本文完结。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2018/07/17/Android-ActivityUtil/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/17/Android-ActivityUtil/" class="post-title-link" itemprop="url">Android中同时finish多个Activity - 一次内存泄露的小记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-17 14:04:17" itemprop="dateCreated datePublished" datetime="2018-07-17T14:04:17+08:00">2018-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/develop/" itemprop="url" rel="index"><span itemprop="name">develop</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/07/17/Android-ActivityUtil/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/07/17/Android-ActivityUtil/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Android开发中，有时需要同时<strong>finish</strong>多个Activity，避免用户点击<strong>后退</strong>按钮时回退到不该呈现的Activity。对于这样的问题，常见的方式是维护一个单例ActivityList，将多个Activity置入此单例列表，需要关闭多个Activity时可遍历该List依次执行<strong>finish</strong>操作。<br>代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Activity&gt; activityList;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ActivityUtil instance;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ActivityUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ActivityUtil <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">null</span> == instance ? <span class="keyword">new</span> ActivityUtil() : instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Activity&gt; <span class="title">getActivityList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> activityList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向栈中添加Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addActivity</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activityList == <span class="keyword">null</span>) &#123;</span><br><span class="line">            activityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        activityList.add(activity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭栈中指定的Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeActivity</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span> &amp;&amp; activityList.contains(activity)) &#123;</span><br><span class="line">            activityList.remove(activity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭栈顶的Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLastActivity</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activityList.size()&gt;<span class="number">1</span>)&#123;</span><br><span class="line">            activityList.remove(activityList.size()-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭栈顶topN个Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishLastActivites</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">    	<span class="keyword">int</span> p = activityList.size() - n;</span><br><span class="line">    	<span class="keyword">if</span> ( p &gt;= <span class="number">0</span> ) &#123;</span><br><span class="line">    		Iterator&lt;Activity&gt; iterator = activityList.iterator();	</span><br><span class="line">    		<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    		<span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">    			 Activity activity = iterator.next();</span><br><span class="line">    			 <span class="keyword">if</span> ( i++ &gt;= p ) &#123;</span><br><span class="line">    			 	iterator.remove();</span><br><span class="line">    			 	<span class="keyword">if</span> (!activity.isFinishing()) &#123;</span><br><span class="line">    			 		activity.finish();	</span><br><span class="line">    			 	&#125;</span><br><span class="line">    			 &#125;</span><br><span class="line">    		&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭栈中所有的Activity</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishAllActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != activityList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Activity activity : activityList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!activity.isFinishing()) &#123;</span><br><span class="line">                    activity.finish();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            activityList.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>这样的代码本身没有问题，但开发时非常容易<strong>忘掉</strong>此处List中的引用而直接在外部finish，从而造成内存泄露。我们可以在List中使用<strong>WeakReference</strong>来避免这样的内存泄露。<br>代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;WeakReference&lt;Activity&gt;&gt; activityList;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ActivityUtil instance;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ActivityUtil</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ActivityUtil <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">null</span> == instance ? <span class="keyword">new</span> ActivityUtil() : instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;WeakReference&lt;Activity&gt;&gt; getActivityList() &#123;</span><br><span class="line">        <span class="keyword">return</span> activityList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addActivity</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activityList == <span class="keyword">null</span>) &#123;</span><br><span class="line">            activityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//使用WeakReference持有Activity</span></span><br><span class="line">        WeakReference&lt;Activity&gt; weakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</span><br><span class="line">        activityList.add(weakReference);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeActivity</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (WeakReference&lt;Activity&gt; weakReference : activityList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (weakReference.get() == activity) &#123;</span><br><span class="line">                activityList.remove(weakReference);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLastActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activityList.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            activityList.remove(activityList.size() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishLastActivites</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p = activityList.size() - n;</span><br><span class="line">        <span class="keyword">if</span> (p &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Iterator&lt;WeakReference&lt;Activity&gt;&gt; iterator = activityList.iterator();</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                Activity activity = iterator.next().get();</span><br><span class="line">                <span class="keyword">if</span> (i++ &gt;= p) &#123;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    <span class="keyword">if</span> (!activity.isFinishing()) &#123;</span><br><span class="line">                        activity.finish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishAllActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != activityList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (WeakReference&lt;Activity&gt; weakReference : activityList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!weakReference.get().isFinishing()) &#123;</span><br><span class="line">                    weakReference.get().finish();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            activityList.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2018/07/08/Understand-Android-MVP-Architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/08/Understand-Android-MVP-Architecture/" class="post-title-link" itemprop="url">Android MVP架构解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-08 23:22:13" itemprop="dateCreated datePublished" datetime="2018-07-08T23:22:13+08:00">2018-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/develop/" itemprop="url" rel="index"><span itemprop="name">develop</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/07/08/Understand-Android-MVP-Architecture/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/07/08/Understand-Android-MVP-Architecture/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>14 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZXNhbXBsZXMvYW5kcm9pZC1hcmNoaXRlY3R1cmU=" title="https://github.com/googlesamples/android-architecture">Android Architecture Blueprints<i class="fa fa-external-link"></i></span> 是谷歌官方开源的一组 Android 架构方案，项目以多个分支分别采用 <strong>MVP</strong>，<strong>MVVM</strong> 的概念以及 dagger、rxjava、databinding、livedata 等工具库，演示了一个简单的 <strong>TodoApp</strong> 在不同架构模式下的代码组织方式。这个项目中的代码非常规范，架构模式也非常有借鉴意义，是一个很有价值的学习素材。</p>
<p>本文将通过 <strong>项目组织</strong>、<strong>架构组织与通信</strong>、<strong>设计原则</strong> 这三个层次对项目中的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZXNhbXBsZXMvYW5kcm9pZC1hcmNoaXRlY3R1cmUvdHJlZS90b2RvLW12cC8=" title="https://github.com/googlesamples/android-architecture/tree/todo-mvp/">todo-mvp<i class="fa fa-external-link"></i></span>分支进行解析，从而达到学习的目的。</p>
<h1 id="项目概览"><a href="#项目概览" class="headerlink" title="项目概览"></a>项目概览</h1><p>在分析之前，我们先通过截图来了解一下TodoApp的功能。</p>
<table>
<thead>
<tr>
<th>TodoApp</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>用来跳转列表页与统计页的抽屉窗口</td>
<td>统计页</td>
</tr>
<tr>
<td><img src="/uploads/todo-drawer.png" alt=""></td>
<td><img src="/uploads/todo-stats.png" alt=""></td>
</tr>
<tr>
<td>列表页</td>
<td></td>
</tr>
<tr>
<td><img src="/uploads/todo-tasks1.png" alt=""></td>
<td><img src="/uploads/todo-tasks2.png" alt=""></td>
</tr>
<tr>
<td>详情页</td>
<td>编辑页</td>
</tr>
<tr>
<td><img src="/uploads/todo-detail.png" alt=""></td>
<td><img src="/uploads/todo-edit.png" alt=""></td>
</tr>
</tbody></table>
<p>知晓了项目功能后，再来看项目的组织。</p>
<h1 id="项目组织"><a href="#项目组织" class="headerlink" title="项目组织"></a>项目组织</h1><p>在开始之前推荐大家先了解一下<span class="exturl" data-url="aHR0cHM6Ly93d3cuamV0YnJhaW5zLmNvbS9oZWxwL2lkZWEvc3ltYm9scy5odG1s" title="https://www.jetbrains.com/help/idea/symbols.html">IDEA符号表<i class="fa fa-external-link"></i></span>，熟悉符号表对理解项目组织有很大帮助。</p>
<h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><img alt="TodoMVP 项目目录" src="/uploads/todo-mvp-project-structure1.png" width="70%">
app/src 除了 androidTest、main、test 这三个常见的模板目录外，还有androidTestMock、mock与prod 目录。androidTestMock 虽不常见，但通过名称可推断它是一个测试相关的目录，另外还有 mock、prod 这两个目录，我们稍后会讲到。
## UI模块划分
<img alt="TodoMVP 项目目录" src="/uploads/todo-mvp-project-structure2.png" width="70%">
app/src/main/java 下的 addedittask、statistics、taskdetail、tasks 这四个目录分别对应 App 内编辑页、统计页、详情页、列表页这四个模块，每个目录都有自己的 Activity、Fragment与Presenter，分别表示 MVP 中的 **View** 层和 **Presenter** 层，Contract 由字面意义推断为契约接口，此处暂且不表，稍后会在源码中了解其实际内涵。
## Model层
<img alt="TodoMVP 项目目录" src="/uploads/todo-mvp-project-structure3.png" width="70%">
app/src/main/java 下的 data 目录表示 **Model** 层，Task 是经final修饰的实体类模型，data/source 下有表示数据源接口的 TasksDataSource 与表示数据仓库类的 TasksRepository，data/source/local 与 data/source/remote 分别表示本地数据源与远程数据源，由ToDoDatabase及TastsDao可推断其local部分以数据库的形式实现。

<p>最下方的 BasePresenter、BaseView 分别表示Presenter与View的基类，剩下的utils包用到时再进行查阅即可。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>经过简单的查看，不难作出如下推论。</p>
<ol>
<li>项目采用MVP模式进行代码组织，每个功能模块均有其专属的 Activity、Fragmeng 与Presenter，所有的功能都围绕 Task 进行 CURD，所以 Mode 层只有一个实体类。</li>
<li>Model 层内涵了加载数据的业务逻辑</li>
<li>Model 层采用了 local 和 remote 双数据源，推断 TasksRepository 拥有缓存策略。</li>
</ol>
<p>同时还有一些疑问：</p>
<ol>
<li>M-V-P是怎样组织的？</li>
<li>M-V-P间如何进行通信？</li>
</ol>
<p>接下来便通过代码来找寻答案</p>
<h1 id="架构组织与通信"><a href="#架构组织与通信" class="headerlink" title="架构组织与通信"></a>架构组织与通信</h1><h2 id="架构组织"><a href="#架构组织" class="headerlink" title="架构组织"></a>架构组织</h2><h3 id="1-从最简单的Base接口开始看"><a href="#1-从最简单的Base接口开始看" class="headerlink" title="1. 从最简单的Base接口开始看"></a>1. 从最简单的Base接口开始看</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BaseView.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseView</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 规定View必须实现setPresenter方法，因此View必然持有Presenter的引用</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPresenter</span><span class="params">(T presenter)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//BasePresenter.java    </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BasePresenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="2-Tasks契约接口"><a href="#2-Tasks契约接口" class="headerlink" title="2. Tasks契约接口"></a>2. Tasks契约接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksContract.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TasksContract</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">View</span> <span class="keyword">extends</span> <span class="title">BaseView</span>&lt;<span class="title">Presenter</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">//设置加载指示器是否显示</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setLoadingIndicator</span><span class="params">(<span class="keyword">boolean</span> active)</span></span>;</span><br><span class="line">        <span class="comment">//显示任务列表</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTasks</span><span class="params">(List&lt;Task&gt; tasks)</span></span>;</span><br><span class="line">        <span class="comment">//进入新增任务页</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showAddTask</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//进入任务详情页</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTaskDetailsUi</span><span class="params">(String taskId)</span></span>;</span><br><span class="line">        <span class="comment">//显示任务被标记为完成状态的提示</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTaskMarkedComplete</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示任务被标记为活跃状态的提示</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showTaskMarkedActive</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示完成状态的任务被清除的提示</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showCompletedTasksCleared</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示任务加载失败的提示</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showLoadingTasksError</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示无任务视图</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showNoTasks</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示无活跃任务视图</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showNoActiveTasks</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示无完成任务视图</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showNoCompletedTasks</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//修改顶部Label文字</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showActiveFilterLabel</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showCompletedFilterLabel</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showAllFilterLabel</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示成功保存信息的提示</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showSuccessfullySavedMessage</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//判断Fragment是否活跃</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//显示过滤器菜单弹窗</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">showFilteringPopUpMenu</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Presenter</span> <span class="keyword">extends</span> <span class="title">BasePresenter</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Fragment.onActivityResults回调</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">result</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode)</span></span>;</span><br><span class="line">        <span class="comment">//加载任务列表</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">loadTasks</span><span class="params">(<span class="keyword">boolean</span> forceUpdate)</span></span>;</span><br><span class="line">        <span class="comment">//添加新任务</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">addNewTask</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//打开任务详情</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">openTaskDetails</span><span class="params">(@NonNull Task requestedTask)</span></span>;</span><br><span class="line">        <span class="comment">//标记某任务已完成</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">completeTask</span><span class="params">(@NonNull Task completedTask)</span></span>;</span><br><span class="line">        <span class="comment">//标记某任务未完成</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">activateTask</span><span class="params">(@NonNull Task activeTask)</span></span>;</span><br><span class="line">        <span class="comment">//清除已完成任务</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">clearCompletedTasks</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="comment">//设置过滤器</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setFiltering</span><span class="params">(TasksFilterType requestType)</span></span>;</span><br><span class="line">        <span class="comment">//获取过滤器</span></span><br><span class="line">        <span class="function">TasksFilterType <span class="title">getFiltering</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZXNhbXBsZXMvYW5kcm9pZC1hcmNoaXRlY3R1cmUvYmxvYi90b2RvLW12cC90b2RvYXBwL2FwcC9zcmMvbWFpbi9qYXZhL2NvbS9leGFtcGxlL2FuZHJvaWQvYXJjaGl0ZWN0dXJlL2JsdWVwcmludHMvdG9kb2FwcC90YXNrcy9UYXNrc0NvbnRyYWN0LmphdmE=" title="https://github.com/googlesamples/android-architecture/blob/todo-mvp/todoapp/app/src/main/java/com/example/android/architecture/blueprints/todoapp/tasks/TasksContract.java">TasksContract<i class="fa fa-external-link"></i></span> 采用内部接口的形式将 View 与 Presenter 结合在一处，使得 View 和 Presenter 中有哪些功能看起来一目了然，维护时也很方便。</p>
<ul>
<li>TasksContract.View 声明了任务列表所有的UI动态</li>
<li>TasksContract.Presenter 声明了任务列表的所有业务事件</li>
</ul>
<h3 id="3-契约接口的实现类"><a href="#3-契约接口的实现类" class="headerlink" title="3. 契约接口的实现类"></a>3. 契约接口的实现类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksFragment.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TasksFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">TasksContract</span>.<span class="title">View</span> </span>&#123;</span><br><span class="line"><span class="comment">//TasksPresenter.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TasksPresenter</span> <span class="keyword">implements</span> <span class="title">TasksContract</span>.<span class="title">Presenter</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>TasksFragment 与 TasksPresenter 分别实现了 TasksContract.View 与 TasksContract.Presenter 接口。因此 TasksFragment 对应任务列表模块的 <strong>View</strong> 层，TasksPresenter 对应任务列表模块的 <strong>Presenter</strong> 层。</p>
<ul>
<li>TasksFragment 负责 View 层的视图改动，当有用户事件发生或者需要获取数据时，需交由 Presenter 处理</li>
<li>TasksPresenter 负责 Presenter 层的事件处理</li>
</ul>
<h3 id="4-View-与-Presenter-如何建立联系"><a href="#4-View-与-Presenter-如何建立联系" class="headerlink" title="4. View 与 Presenter 如何建立联系"></a>4. View 与 Presenter 如何建立联系</h3><h4 id="从TasksActivity入手"><a href="#从TasksActivity入手" class="headerlink" title="从TasksActivity入手"></a>从TasksActivity入手</h4><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZXNhbXBsZXMvYW5kcm9pZC1hcmNoaXRlY3R1cmUvYmxvYi90b2RvLW12cC90b2RvYXBwL2FwcC9zcmMvbWFpbi9yZXMvbGF5b3V0L3Rhc2tzX2FjdC54bWw=" title="https://github.com/googlesamples/android-architecture/blob/todo-mvp/todoapp/app/src/main/res/layout/tasks_act.xml">tasks_act.xml<i class="fa fa-external-link"></i></span></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//tasks_act.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.drawerlayout.widget.DrawerLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.google.android.material.appbar.AppBarLayout</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.coordinatorlayout.widget.CoordinatorLayout</span>&gt;</span></span><br><span class="line">            // Fragment 占位容器</span><br><span class="line">            <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/contentFrame"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">com.google.android.material.floatingactionbutton.FloatingActionButton</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">androidx.coordinatorlayout.widget.CoordinatorLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.google.android.material.navigation.NavigationView</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.drawerlayout.widget.DrawerLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZXNhbXBsZXMvYW5kcm9pZC1hcmNoaXRlY3R1cmUvYmxvYi90b2RvLW12cC90b2RvYXBwL2FwcC9zcmMvbWFpbi9qYXZhL2NvbS9leGFtcGxlL2FuZHJvaWQvYXJjaGl0ZWN0dXJlL2JsdWVwcmludHMvdG9kb2FwcC90YXNrcy9UYXNrc0FjdGl2aXR5LmphdmE=" title="https://github.com/googlesamples/android-architecture/blob/todo-mvp/todoapp/app/src/main/java/com/example/android/architecture/blueprints/todoapp/tasks/TasksActivity.java">TasksActivity<i class="fa fa-external-link"></i></span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksActivity.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    TasksFragment tasksFragment =</span><br><span class="line">            (TasksFragment) getSupportFragmentManager().findFragmentById(R.id.contentFrame);</span><br><span class="line">    <span class="keyword">if</span> (tasksFragment == <span class="keyword">null</span>) &#123;</span><br><span class="line">        tasksFragment = TasksFragment.newInstance();</span><br><span class="line">        <span class="comment">// 将TasksFragment 关联到 TasksActivity</span></span><br><span class="line">        ActivityUtils.addFragmentToActivity(</span><br><span class="line">                getSupportFragmentManager(), tasksFragment, R.id.contentFrame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化Presenter时，将repository，fragment作为参数传入</span></span><br><span class="line">    mTasksPresenter = <span class="keyword">new</span> TasksPresenter(Injection.provideTasksRepository(getApplicationContext()), tasksFragment);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在TasksActivity的onCreate方法内attach了TasksFragment，同时对TasksPresenter进行实例化，而TasksPresenter的构造函数与tasksFragment有很强的关联。 </p>
<h4 id="追踪-TasksPresenter-的构造函数"><a href="#追踪-TasksPresenter-的构造函数" class="headerlink" title="追踪 TasksPresenter 的构造函数"></a>追踪 TasksPresenter 的构造函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksPresenter.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TasksPresenter</span><span class="params">(@NonNull TasksRepository tasksRepository, @NonNull TasksContract.View tasksView)</span> </span>&#123;</span><br><span class="line">    mTasksRepository = checkNotNull(tasksRepository, <span class="string">"tasksRepository cannot be null"</span>);</span><br><span class="line">    <span class="comment">//采用断言检测参数是否为Null</span></span><br><span class="line">    mTasksView = checkNotNull(tasksView, <span class="string">"tasksView cannot be null!"</span>);</span><br><span class="line">    <span class="comment">//为View设置Presenter</span></span><br><span class="line">    mTasksView.setPresenter(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//BasePresenter 基类继承而来的方法，一旦被调用便执行 loadTasks</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    loadTasks(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//TasksFragment.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    <span class="comment">//当 Fragment 的生命周期到达 resume 状态时，调用 presenter 的 start 方法</span></span><br><span class="line">    mPresenter.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPresenter</span><span class="params">(@NonNull TasksContract.Presenter presenter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//采用断言检测参数是否为Null，若非Null则将其赋值给 mPresenter</span></span><br><span class="line">    mPresenter = checkNotNull(presenter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在TasksPresenter的构造方法中，终于看到 Presenter 层与 View 层是如何关联的，至此，MVP之间的桥梁总算架通，接下来我们将视线转移到层次间的交互上。</p>
<h2 id="组件通信：列表刷新的前世今生"><a href="#组件通信：列表刷新的前世今生" class="headerlink" title="组件通信：列表刷新的前世今生"></a>组件通信：列表刷新的前世今生</h2><h3 id="刷新事件发生时，TasksFragment-将其转交给-TasksPresenter-处理"><a href="#刷新事件发生时，TasksFragment-将其转交给-TasksPresenter-处理" class="headerlink" title="刷新事件发生时，TasksFragment 将其转交给 TasksPresenter 处理"></a>刷新事件发生时，TasksFragment 将其转交给 TasksPresenter 处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksFragment.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户点击菜单控件，Fragment收到点击事件</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (item.getItemId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.menu_clear:</span><br><span class="line">            mPresenter.clearCompletedTasks();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.menu_filter:</span><br><span class="line">            showFilteringPopUpMenu();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.menu_refresh:</span><br><span class="line">            <span class="comment">//若用户点击的是刷新按钮，则交由presenter 的 loadTasks 方法进行处理</span></span><br><span class="line">            mPresenter.loadTasks(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TasksPresenter-对-loadTastk-true-的响应"><a href="#TasksPresenter-对-loadTastk-true-的响应" class="headerlink" title="TasksPresenter 对 loadTastk(true) 的响应"></a>TasksPresenter 对 loadTastk(true) 的响应</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksPrenseter.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadTasks</span><span class="params">(<span class="keyword">boolean</span> forceUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// loadTasks(true) 时，下条语句可直接看做 loadTasks(true,true);</span></span><br><span class="line">    loadTasks(forceUpdate || mFirstLoad, <span class="keyword">true</span>);</span><br><span class="line">    mFirstLoad = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadTasks</span><span class="params">(<span class="keyword">boolean</span> forceUpdate, <span class="keyword">final</span> <span class="keyword">boolean</span> showLoadingUI)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (showLoadingUI) &#123;</span><br><span class="line">        <span class="comment">//显示加载中动画</span></span><br><span class="line">        mTasksView.setLoadingIndicator(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (forceUpdate) &#123;</span><br><span class="line">        <span class="comment">//强制更新时，将repo的脏缓存标志设置为true，达到放弃缓存的目的</span></span><br><span class="line">        mTasksRepository.mCacheIsDirty = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mTasksRepository.getTasks(<span class="keyword">new</span> TasksDataSource.LoadTasksCallback() &#123;</span><br><span class="line">        <span class="comment">//数据源成功回调</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTasksLoaded</span><span class="params">(List&lt;Task&gt; tasks)</span> </span>&#123;</span><br><span class="line">            List&lt;Task&gt; tasksToShow = <span class="keyword">new</span> ArrayList&lt;Task&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Task task : tasks) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (mCurrentFiltering) &#123;</span><br><span class="line">                    <span class="keyword">case</span> ALL_TASKS:</span><br><span class="line">                        tasksToShow.add(task);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> ACTIVE_TASKS:</span><br><span class="line">                        <span class="keyword">if</span> (task.isActive()) &#123;</span><br><span class="line">                            tasksToShow.add(task);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMPLETED_TASKS:</span><br><span class="line">                        <span class="keyword">if</span> (task.isCompleted()) &#123;</span><br><span class="line">                            tasksToShow.add(task);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        tasksToShow.add(task);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果 TasksFragment 不活跃，则中止操作，直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (!mTasksView.isActive()) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">            <span class="comment">// 关闭加载动画</span></span><br><span class="line">            <span class="keyword">if</span> (showLoadingUI) &#123; mTasksView.setLoadingIndicator(<span class="keyword">false</span>); &#125;</span><br><span class="line">            <span class="keyword">if</span> (tasks.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 当列表为空时，根据过滤器状态显示对应的空列表提示信息</span></span><br><span class="line">                <span class="keyword">switch</span> (mCurrentFiltering) &#123;</span><br><span class="line">                    <span class="keyword">case</span> ACTIVE_TASKS:</span><br><span class="line">                        <span class="comment">//将View层的变动交由mTasksView即TasksFragment处理</span></span><br><span class="line">                        mTasksView.showNoActiveTasks();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMPLETED_TASKS:</span><br><span class="line">                        mTasksView.showNoCompletedTasks();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        mTasksView.showNoTasks();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;       </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 列表不为空时，调用mTasksView.showTasks来展示最新获取到的任务列表</span></span><br><span class="line">                mTasksView.showTasks(tasks);</span><br><span class="line">                showFilterLabel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//数据源失败回调</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mTasksView.isActive()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//显示加载失败提示</span></span><br><span class="line">            mTasksView.showLoadingTasksError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TasksPresenter通过TasksRepository获取数据，无论成功或失败，都会通过mTasksView即TasksFragment来完成View的更新。</p>
<h3 id="TasksFragment-对-showTasks-的响应"><a href="#TasksFragment-对-showTasks-的响应" class="headerlink" title="TasksFragment 对 showTasks 的响应"></a>TasksFragment 对 showTasks 的响应</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksFragment.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showTasks</span><span class="params">(List&lt;Task&gt; tasks)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//通知adapter</span></span><br><span class="line">    mListAdapter.replaceData(tasks);</span><br><span class="line">    <span class="comment">//显示任务列表</span></span><br><span class="line">    mTasksView.setVisibility(View.VISIBLE);</span><br><span class="line">    <span class="comment">//隐藏无任务视图</span></span><br><span class="line">    mNoTasksView.setVisibility(View.GONE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//TasksFragment.TasksAdapter</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceData</span><span class="params">(List&lt;Task&gt; tasks)</span> </span>&#123;</span><br><span class="line">    mTasks = checkNotNull(tasks);</span><br><span class="line">    <span class="comment">//通知ListView更新</span></span><br><span class="line">    notifyDataSetChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TasksRepository-对-getTasks-的响应"><a href="#TasksRepository-对-getTasks-的响应" class="headerlink" title="TasksRepository 对 getTasks 的响应"></a>TasksRepository 对 getTasks 的响应</h3><h4 id="1-Repository-的实现"><a href="#1-Repository-的实现" class="headerlink" title="1. Repository 的实现"></a>1. Repository 的实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksDataSource.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TasksDataSource</span> </span>&#123;</span><br><span class="line">    <span class="comment">//加载任务列表回调</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">LoadTasksCallback</span> </span>&#123;</span><br><span class="line">        <span class="comment">//成功回调</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onTasksLoaded</span><span class="params">(List&lt;Task&gt; tasks)</span></span>;</span><br><span class="line">        <span class="comment">//失败回调</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取单个任务回调</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">GetTaskCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onTaskLoaded</span><span class="params">(Task task)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取任务列表</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getTasks</span><span class="params">(@NonNull LoadTasksCallback callback)</span></span>;</span><br><span class="line">    <span class="comment">//获取单个任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getTask</span><span class="params">(@NonNull String taskId, @NonNull GetTaskCallback callback)</span></span>;</span><br><span class="line">    <span class="comment">//保存单个任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">saveTask</span><span class="params">(@NonNull Task task)</span></span>;</span><br><span class="line">    <span class="comment">//完成单个任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">completeTask</span><span class="params">(@NonNull Task task)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">completeTask</span><span class="params">(@NonNull String taskId)</span></span>;</span><br><span class="line">    <span class="comment">//激活单个任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activateTask</span><span class="params">(@NonNull Task task)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activateTask</span><span class="params">(@NonNull String taskId)</span></span>;</span><br><span class="line">    <span class="comment">//清空已完成任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearCompletedTasks</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//刷新任务列表</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshTasks</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//删除所有任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteAllTasks</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//删除单个任务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteTask</span><span class="params">(@NonNull String taskId)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//TasksRepository.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TasksRepository</span> <span class="keyword">implements</span> <span class="title">TasksDataSource</span> </span>&#123;</span><br><span class="line">    <span class="comment">//单例模式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TasksRepository INSTANCE = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//持有本地数据源与远程数据源</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TasksDataSource mTasksRemoteDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TasksDataSource mTasksLocalDataSource;</span><br><span class="line">    <span class="comment">//私有化构造方法，屏蔽 new 操作</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">TasksRepository</span><span class="params">(@NonNull TasksDataSource tasksRemoteDataSource,</span></span></span><br><span class="line"><span class="function"><span class="params">                            @NonNull TasksDataSource tasksLocalDataSource)</span> </span>&#123;</span><br><span class="line">        mTasksRemoteDataSource = checkNotNull(tasksRemoteDataSource);</span><br><span class="line">        mTasksLocalDataSource = checkNotNull(tasksLocalDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//单例方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TasksRepository <span class="title">getInstance</span><span class="params">(TasksDataSource tasksRemoteDataSource, TasksDataSource tasksLocalDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</span><br><span class="line">            INSTANCE = <span class="keyword">new</span> TasksRepository(tasksRemoteDataSource, tasksLocalDataSource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-Repository-内的缓存策略"><a href="#2-Repository-内的缓存策略" class="headerlink" title="2. Repository 内的缓存策略"></a>2. Repository 内的缓存策略</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取任务列表</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTasks</span><span class="params">(@NonNull <span class="keyword">final</span> LoadTasksCallback callback)</span> </span>&#123;</span><br><span class="line">    checkNotNull(callback);</span><br><span class="line">    <span class="comment">// 如果缓存可用，则返回缓存内容</span></span><br><span class="line">    <span class="keyword">if</span> (mCachedTasks != <span class="keyword">null</span> &amp;&amp; !mCacheIsDirty) &#123;</span><br><span class="line">        callback.onTasksLoaded(<span class="keyword">new</span> ArrayList&lt;&gt;(mCachedTasks.values()));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mCacheIsDirty) &#123;</span><br><span class="line">        <span class="comment">// 如果存在脏缓存，则重新从远程获取数据</span></span><br><span class="line">        getTasksFromRemoteDataSource(callback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不存在脏缓存时，尝试从本地数据库内获取数据</span></span><br><span class="line">        mTasksLocalDataSource.getTasks(<span class="keyword">new</span> LoadTasksCallback() &#123;</span><br><span class="line">            <span class="comment">//若在本地数据库内成功获得数据，则将数据回调给 Presenter</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTasksLoaded</span><span class="params">(List&lt;Task&gt; tasks)</span> </span>&#123;</span><br><span class="line">                refreshCache(tasks);</span><br><span class="line">                callback.onTasksLoaded(<span class="keyword">new</span> ArrayList&lt;&gt;(mCachedTasks.values()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//若在本地数据库获得失败，则重新从远程获取数据</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                getTasksFromRemoteDataSource(callback);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//从远程获取数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getTasksFromRemoteDataSource</span><span class="params">(@NonNull <span class="keyword">final</span> LoadTasksCallback callback)</span> </span>&#123;</span><br><span class="line">    mTasksRemoteDataSource.getTasks(<span class="keyword">new</span> LoadTasksCallback() &#123;</span><br><span class="line">        <span class="comment">//若成功获得数据，则将数据回调给 Presenter</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTasksLoaded</span><span class="params">(List&lt;Task&gt; tasks)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//刷新缓存标志</span></span><br><span class="line">            refreshCache(tasks);</span><br><span class="line">            <span class="comment">//刷新本地数据库</span></span><br><span class="line">            refreshLocalDataSource(tasks);</span><br><span class="line">            <span class="comment">//将数据回调给 Presenter</span></span><br><span class="line">            callback.onTasksLoaded(<span class="keyword">new</span> ArrayList&lt;&gt;(mCachedTasks.values()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//若成功获得数据，则将将失败事件回调给 Presenter</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataNotAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            callback.onDataNotAvailable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="组件作用"><a href="#组件作用" class="headerlink" title="组件作用"></a>组件作用</h2><h3 id="Contract-在-MVP-中的作用"><a href="#Contract-在-MVP-中的作用" class="headerlink" title="Contract 在 MVP 中的作用"></a>Contract 在 MVP 中的作用</h3><p>Contract 是每个模块的契约，对模块内的 View 和 Presenter 起到提纲擎领的作用，是编写代码前首先需要思考的内容，它的职责如下：</p>
<ol>
<li>整合 View 与 Presenter 接口，便于维护</li>
<li>为 View 与 Presenter 的功能与职责做出规范，便于阅读及理解</li>
<li>作为 View 和 Presenter 的抽象，是遵循依赖反转原则（Dependency Inversion Principle）的前提</li>
</ol>
<h3 id="Activity-在-MVP-中的作用"><a href="#Activity-在-MVP-中的作用" class="headerlink" title="Activity 在 MVP 中的作用"></a>Activity 在 MVP 中的作用</h3><p>Activity 是每个模块的入口，它的职责如下：</p>
<ol>
<li>响应 Actiivty 的生命周期事件</li>
<li>加载 layout ，响应来自 drawer 及 fab 的用户事件</li>
<li>实例化 Fragment(View) 及 Presenter，并建立二者间的关联</li>
<li>为 Presenter 注入 Repository</li>
</ol>
<p>关于第4点，将在后边的依赖反转章节进行详细阐述。</p>
<h3 id="Fragment-在-MVP-中的作用"><a href="#Fragment-在-MVP-中的作用" class="headerlink" title="Fragment 在 MVP 中的作用"></a>Fragment 在 MVP 中的作用</h3><p>Fragment 作为 Fragment 的子类及 Contract.View 接口的实现类，它有以下几点职责：</p>
<ol>
<li>响应 Fragment 的生命周期事件</li>
<li>加载 layout ，完成子控件的实例化及映射，对用户事件进行处理或将其中转给 Contract.Presenter</li>
<li>作为 Contract.View 接口的具体实现，对 View 层进行更新</li>
</ol>
<h3 id="Presenter-在-MVP-中的作用"><a href="#Presenter-在-MVP-中的作用" class="headerlink" title="Presenter 在 MVP 中的作用"></a>Presenter 在 MVP 中的作用</h3><p>Presenter 仅作为 Contract.Presenter 接口的实现类，它有如下几点职责：</p>
<ol>
<li>纯 Java 代码，与 Android SDK 完全解耦，为测试提供便利</li>
<li>响应 Fragment 中转来的用户事件，对用户事件进行处理或将其中转给 Repository</li>
<li>响应 Repository 的回调，随后将 Model 层返回的数据中转给 Contract.View </li>
</ol>
<h3 id="Repository-在-MVP-中的作用"><a href="#Repository-在-MVP-中的作用" class="headerlink" title="Repository 在 MVP 中的作用"></a>Repository 在 MVP 中的作用</h3><p>Repository 作为 Model 模块内的组件以及 DataSource 接口的实现类，它的职责如下：</p>
<ol>
<li>Repository 本身并未存储数据，它仅负责数据的缓存策略</li>
<li>将来自 Presenter 的调用先进行 CURD 缓存策略的处理，再中转给实际的 LocalDataSource / RemoteDataSource，并将最终结果回调给 Presenter</li>
</ol>
<h3 id="MVP间的通信方式"><a href="#MVP间的通信方式" class="headerlink" title="MVP间的通信方式"></a>MVP间的通信方式</h3><p><img src="/uploads/todo-mvp-figure.png" alt=""></p>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><ol>
<li>项目的模块划分与代码结构非常清晰，使得项目易于理解与上手</li>
<li>Activity 与 Fragment 的同时使用，带来了更好的分离性，Acitivity 作为模块入口兼控制器，负责view、presenter的创建与连接</li>
<li>UI代码与业务代码进行了拆分，整体的可测试性非常好，UI层和业务层均可单独进行测试。</li>
</ol>
<h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><h2 id="面向对象设计的-S-O-L-I-D-原则"><a href="#面向对象设计的-S-O-L-I-D-原则" class="headerlink" title="面向对象设计的 S.O.L.I.D 原则"></a>面向对象设计的 S.O.L.I.D 原则</h2><table>
<thead>
<tr>
<th>缩写</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>SRP</td>
<td>单一职责原则（Singel responsibility principle）</td>
<td>每个类、接口尽可能的只负责单方面的工作</td>
</tr>
<tr>
<td>OCP</td>
<td>开闭原则（Open-closed princile）</td>
<td>对扩展开放，对修改关闭</td>
</tr>
<tr>
<td>LSP</td>
<td>里式替换原则（Liskov substitution princile）</td>
<td>程序中的对象可以在不改变其正确性的条件下替换为它的子类对象</td>
</tr>
<tr>
<td>ISP</td>
<td>接口隔离原则（Interface segregation princile）</td>
<td>尽量使用多个小而精接口代替一个大而多的超级接口，从而在接口改动时减少对上层调用者的影响</td>
</tr>
<tr>
<td>DIP</td>
<td>依赖反转原则（Dependency inversion princile）</td>
<td>因为里式替换原则的存在，鼓励对象间的引用尽可能的依赖抽象而不是细节（即尽可能的使用父类型作为对象的引用类型），以此来降低依赖时的耦合度</td>
</tr>
</tbody></table>
<h2 id="todo-mvp-中设计原则的体现"><a href="#todo-mvp-中设计原则的体现" class="headerlink" title="todo-mvp 中设计原则的体现"></a>todo-mvp 中设计原则的体现</h2><ol>
<li>View 与 Presenter 相互持有时，都使用父类对象作为引用，满足了里式替换原则和依赖反转原则</li>
<li>Model、View 与 Presenter 间的划分很清晰，满足了接口隔离原则与单一职责原则</li>
<li>Repository、LocalDataSource、RemoteDataSource 对 DataSource 的不同实现满足了开闭原则</li>
</ol>
<h2 id="一个依赖注入的细节"><a href="#一个依赖注入的细节" class="headerlink" title="一个依赖注入的细节"></a>一个依赖注入的细节</h2><p>TasksActivity 的 onCreate 在创建 TasksPresenter 时，通过 Injection 来获取 Repository。Injection 通常伴随强烈的依赖注入语义，此处必有蹊跷</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TasksActivity.java onCreate</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    mTasksPresenter = <span class="keyword">new</span> TasksPresenter(</span><br><span class="line">            Injection.provideTasksRepository(getApplicationContext()), </span><br><span class="line">            tasksFragment);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到项目组织，在 mock 与 prod 下，果然看到两个同名的 Injection 类<br><img alt="TodoMVP 项目目录" src="/uploads/todo-mvp-project-structure4.png" width="70%"><br>除 RemoteDataSourcew 外，两份Injection的代码完全一致，甚至连包名都一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mock </span></span><br><span class="line"><span class="keyword">package</span> com.example.android.architecture.blueprints.todoapp;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Injection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TasksRepository <span class="title">provideTasksRepository</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">        checkNotNull(context);</span><br><span class="line">        ToDoDatabase database = ToDoDatabase.getInstance(context);</span><br><span class="line">        <span class="comment">// mock 环境使用 FakeTasksRemoteDataSource</span></span><br><span class="line">        <span class="keyword">return</span> TasksRepository.getInstance(FakeTasksRemoteDataSource.getInstance(),</span><br><span class="line">                TasksLocalDataSource.getInstance(<span class="keyword">new</span> AppExecutors(),</span><br><span class="line">                        database.taskDao()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// src/prod</span></span><br><span class="line"><span class="keyword">package</span> com.example.android.architecture.blueprints.todoapp;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Injection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TasksRepository <span class="title">provideTasksRepository</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">        checkNotNull(context);</span><br><span class="line">        ToDoDatabase database = ToDoDatabase.getInstance(context);</span><br><span class="line">        <span class="comment">// prod 环境使用 TasksRemoteDataSource</span></span><br><span class="line">        <span class="keyword">return</span> TasksRepository.getInstance(TasksRemoteDataSource.getInstance(),</span><br><span class="line">                TasksLocalDataSource.getInstance(<span class="keyword">new</span> AppExecutors(),</span><br><span class="line">                        database.taskDao()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到项目组织，打开Build Variant窗口，同时打开app下的 build.gradle文件</p>
<img alt="TodoMVP 项目目录" src="/uploads/todo-mvp-project-structure5.png" >

<p>根据 mock/java 的蓝色文件夹图标可知，mock 下的 Injection.java 为当前源码集的一部分，项目编译时运行时会选用这个 Injection </p>
<p>我们在Build Variant窗口的列表中，使用鼠标选中 prodDebug或prodRelease ，项目变回会自动进行 Gradle Sync 操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Executing tasks: [:app:generateProdDebugSources]</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">...省略</span><br><span class="line">&gt; Task :app:preProdDebugBuild UP-TO-DATE</span><br><span class="line">&gt; Task :app:compileProdDebugAidl NO-SOURCE</span><br><span class="line">&gt; Task :app:compileProdDebugRenderscript UP-TO-DATE</span><br><span class="line">&gt; Task :app:checkProdDebugManifest UP-TO-DATE</span><br><span class="line">&gt; Task :app:generateProdDebugBuildConfig UP-TO-DATE</span><br><span class="line">&gt; Task :app:generateProdDebugSources UP-TO-DATE</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 0s</span><br><span class="line">6 actionable tasks: 6 up-to-date</span><br></pre></td></tr></table></figure>
<p>执行完成后再来观察项目组织，发现 prod/java 成为了源码集的一部分，mock/java 则变为了普通文件夹<br><img alt="TodoMVP 项目目录" src="/uploads/todo-mvp-project-structure6.png" width="70%"><br>此时若进行编译，便会将 prod/java 下的 Injection 编译到项目中，而 mock 下的文件夹则会被编译器忽略。</p>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>Injection 类通过 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL2J1aWxkL2J1aWxkLXZhcmlhbnRz" title="https://developer.android.com/studio/build/build-variants">build vartiant<i class="fa fa-external-link"></i></span> 改变源码集的方式来实现注入，避免了手动修改带来的潜在问题，使得 mock 与 prod 环境间的切换变得尤为方便，不失为一种优雅的方式。</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><ol>
<li>架构出现的目的是降低项目复杂度</li>
<li>降低项目复杂度的手段是尽可能的解耦</li>
<li>解耦的思路是运用设计模式来组织代码</li>
<li>设计模式遵循的原则是 SOLID</li>
</ol>
<p>参考链接：<br><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8zODljOWFlMWE4MmM=" title="https://www.jianshu.com/p/389c9ae1a82c">Android官方MVP架构项目解析<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU09MSUQ=" title="https://en.wikipedia.org/wiki/SOLID">SOLID<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9qaW5uaWFuc2hpbG9uZ25pYW4uaXRleWUuY29tL2Jsb2cvMTQxMzg0Ng==" title="https://jinnianshilongnian.iteye.com/blog/1413846">【第二章】 IoC 之 2.1 IoC基础 ——跟我学Spring3 <i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLWRldmVsb3BlcnMuZ29vZ2xlYmxvZy5jb20vMjAxNS8xMi9sZXZlcmFnaW5nLXByb2R1Y3QtZmxhdm9ycy1pbi1hbmRyb2lkLmh0bWw=" title="https://android-developers.googleblog.com/2015/12/leveraging-product-flavors-in-android.html">Leveraging product flavors in Android Studio for hermetic testing
<i class="fa fa-external-link"></i></span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://geek5nan.github.io/2018/06/27/coding-marathon-05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Geek5Nan">
      <meta itemprop="description" content="每天进步一点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geek5Nan">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/27/coding-marathon-05/" class="post-title-link" itemprop="url">编程马拉松 Day05 堆、二叉堆、堆排序</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-27 00:05:35" itemprop="dateCreated datePublished" datetime="2018-06-27T00:05:35+08:00">2018-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-11 22:04:51" itemprop="dateModified" datetime="2019-12-11T22:04:51+08:00">2019-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E9%A9%AC%E6%8B%89%E6%9D%BE/" itemprop="url" rel="index"><span itemprop="name">编程马拉松</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/06/27/coding-marathon-05/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/06/27/coding-marathon-05/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h3><p>堆排序需要用到<strong>二叉堆</strong>，在开始之前，我们先来了解一下什么是二叉堆。</p>
<p>当二叉树满足满足如下条件时，我们说这个二叉树是<strong>堆有序</strong>的：</p>
<ol>
<li>每一个父结点的值都比它的子结点大（称为大顶堆）或小（称为小顶堆）</li>
<li>子结点的大小与其左右位置无关</li>
</ol>
<p>堆有序的二叉树，也可称为<strong>二叉堆</strong>。二叉堆是最常见的堆结构，因此也常将二叉堆直接称为<strong>堆</strong>，可以采用如下两种方式来表示二叉堆</p>
<ol>
<li>使用指针，二叉树的每个结点需存储三个指针，分别指向其父结点和两个子结点</li>
<li>使用数组，对二叉树做层序遍历，按层级顺序放入数组中，根结点在数组索引0的位置存放，其子结点分别在索引1和2的位置，1和2个子结点分别在位置3、4和5、6中存放，以此类推</li>
</ol>
<p>就排序来讲，其所需处理的数据较为连续，没有空隙，可用完全二叉树来表示。对于完全二叉树，采用数组的表示方法也更方便些，下图展示了采用数组实现的两个二叉堆。<br><img src="/uploads/ArrayHeapDemo.png" alt="二叉堆"></p>
<p>对于数组实现的二叉堆，索引为k的结点的父结点的索引为(k-1)/2，它的子结点的索引分别为2k+1和2k+2。</p>
<h3 id="堆有序化"><a href="#堆有序化" class="headerlink" title="堆有序化"></a>堆有序化</h3><p>以大顶堆为例，有序化的过程中我们会遇到两种情况</p>
<ol>
<li>在堆底加入一个较大元素时，我们需要<strong><em>由下至上</em></strong>恢复堆的顺序</li>
<li>当将根结点替换为一个较小元素时，我们需要<strong><em>由上到下</em></strong>恢复堆的顺序</li>
</ol>
<h4 id="由下至上的堆有序化（上浮）"><a href="#由下至上的堆有序化（上浮）" class="headerlink" title="由下至上的堆有序化（上浮）"></a>由下至上的堆有序化（上浮）</h4><p>如果堆的有序状态因为某个结点变的比它的父结点更大而被打破，就需要通过将它与它的父结点交换来恢复堆有序。交换后，这个结点比它的两个子结点都大，但这个结点仍然可能比它现在的父结点更大。我们可以一遍遍的用同样的方式来将其向上移动，直到遇到一个比它更大的父结点或到达了堆的根结点，如下图所示。<br><img src="/uploads/HeapSwim.png" alt="由下至上的堆有序化（上浮）"></p>
<p>上浮操作对应的代码如下    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swim</span><span class="params">(Integer arr[], <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(k &gt; <span class="number">0</span> &amp;&amp; arr[(k - <span class="number">1</span>) / <span class="number">2</span>] &lt; arr[k]) &#123; <span class="comment">//若k&gt;0且索引为k的结点大于其父结点时，将该结点与其父结点交换</span></span><br><span class="line">        swap(arr, k, (k - <span class="number">1</span>) / <span class="number">2</span>);</span><br><span class="line">        k = (k - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="由上至下的堆有序化（下沉）"><a href="#由上至下的堆有序化（下沉）" class="headerlink" title="由上至下的堆有序化（下沉）"></a>由上至下的堆有序化（下沉）</h4><p>如果堆的有序状态因为某个结点变的比它的某个子结点更小而被打破，就需要通过将它和它的子结点中较大者交换位置来恢复堆有序。交换可能会在子结点处继续打破堆的有序状态，此时可以采用相同的方式，将结点向下移动直到它的子结点都比它小或是到达了堆的底部，如下图所示。<br><img src="/uploads/HeapSink.png" alt="由上至下的堆有序化（下沉）"><br>下沉操作对应的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sink</span><span class="params">(Integer arr[], <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">2</span> * k + <span class="number">1</span> &lt;= arr.length - <span class="number">1</span>) &#123;<span class="comment">//若k存在子结点，则进入循环</span></span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">2</span> * k + <span class="number">1</span>; <span class="comment">//获取k的第一个子结点</span></span><br><span class="line">        <span class="keyword">if</span> (j &lt; arr.length - <span class="number">1</span> &amp;&amp; arr[j] &lt; arr[j + <span class="number">1</span>]) &#123;<span class="comment">//若存在两个子结点，则找到其中较大的子结点</span></span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (arr[j] &gt; arr[k]) &#123;<span class="comment">//若k的较大子结点比k大，则交换它们的位置</span></span><br><span class="line">            swap(arr, j, k);</span><br><span class="line">            k = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h3><p>在介绍完堆的数据结构和操作方式后，我们来看堆排序是如何进行的。</p>
<h4 id="堆的构造"><a href="#堆的构造" class="headerlink" title="堆的构造"></a>堆的构造</h4><ol>
<li>将原数组看做堆的话，则最后一个<em>分支结点</em>（含有子结点的结点）在原数组中的索引为 (n-1)/2 -1</li>
<li>从(n-1)/2-1向前依次执行下沉操作，从而得到<strong>堆有序</strong>的数组</li>
</ol>
<p><img src="/uploads/HeapInit.png" alt="堆初始化"></p>
<h4 id="堆的排序"><a href="#堆的排序" class="headerlink" title="堆的排序"></a>堆的排序</h4><ol>
<li>取出堆的根结点，与数组最后一个元素交换。交换后堆有序状态可能会被打破，需要在新的根结点进行<strong>下沉</strong>操作，使其恢复为<strong>堆有序</strong>状态。此时数组中最大(大顶堆)/最小(小顶堆)的值存放在数组末位，除它以外的最 大/小 值位于堆顶。</li>
<li>从数组中排除最后一个元素，重复步骤2，直到数组中的元素全部排除时，完成排序</li>
</ol>
<p><img src="/uploads/HeapSort.png" alt="堆排序"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">heapSort</span><span class="params">(Integer arr[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = arr.length;</span><br><span class="line">    <span class="comment">//堆的构造,对每一个含有孩子的结点做下沉操作,得到大顶堆</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = (n-<span class="number">1</span>) /<span class="number">2</span> -<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        heapSink(arr, i, n);</span><br><span class="line">    &#125;</span><br><span class="line">    printArr(arr, <span class="string">"大顶堆"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">    	swap(arr, <span class="number">0</span>, i);</span><br><span class="line">        heapSink(arr, <span class="number">0</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    printArr(arr, <span class="string">"堆排序"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">heapSink</span><span class="params">(Integer arr[], <span class="keyword">int</span> i, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">true<span class="keyword">while</span>(<span class="number">2</span> * k + <span class="number">1</span> &lt;= length - <span class="number">1</span>) &#123;<span class="comment">//若k存在子结点，则进入循环</span></span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">2</span> * k + <span class="number">1</span>; <span class="comment">//获取k的第一个子结点</span></span><br><span class="line">        <span class="keyword">if</span> (j &lt; length - <span class="number">1</span> &amp;&amp; arr[j] &lt; arr[j + <span class="number">1</span>]) &#123;<span class="comment">//若存在两个子结点，则找到其中较大的子结点</span></span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (arr[j] &gt; arr[k]) &#123;<span class="comment">//若k的较大子结点比k大，则交换它们的位置</span></span><br><span class="line">            swap(arr, j, k);</span><br><span class="line">            k = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>堆排序动态图<br><img src="/uploads/HeapSort1.gif" alt="堆排序动态图"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>堆排序算法也是一种选择排序算法，整体由堆的构建、堆的交换与下沉两个步骤组成。其中堆的构建需要比较(n-1)/2-1次下沉，每次下沉至多交换一次，时间复杂度为O(n)；堆的交换与下沉中需交换n次，下沉依次需要执行$\log_2(n-1),log_2(n-2)…1$次交换，近似为$Nlog_2N$。因此堆排序的时间复杂度为$O(N\log_2N)$</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Geek5Nan"
      src="/uploads/avatar.png">
  <p class="site-author-name" itemprop="name">Geek5Nan</p>
  <div class="site-description" itemprop="description">每天进步一点。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dlZWs1bmFu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;geek5nan"><i class="fa fa-fw fa-github"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93ZWliby5jb20vZ2VlazVuYW4=" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;geek5nan"><i class="fa fa-fw fa-weibo"></i></span>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2013 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Geek5Nan</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">116k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:45</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9taXN0LnRoZW1lLW5leHQub3Jn">NexT.Mist</span> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://geek5nan.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
